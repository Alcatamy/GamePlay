<!DOCTYPE html>
<html lang="es" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fantasy Manager Pro</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Alpine.js -->
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase SDKs (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBzlYu7dTaEvIIt7VehdhVwqOLS2BLnqDQ",
            authDomain: "mercato-fbdcc.firebaseapp.com",
            databaseURL: "https://mercato-fbdcc-default-rtdb.firebaseio.com",
            projectId: "mercato-fbdcc",
            storageBucket: "mercato-fbdcc.firebasestorage.app",
            messagingSenderId: "865841758007",
            appId: "1:865841758007:web:ac53121bc37d00574864b2",
            measurementId: "G-0WQNPFTYNF"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
    </script>
    <!-- Market Data -->
    <script src="market_data.js"></script>
    <script src="movements_data.js"></script> <!-- Historical Data -->

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap');

        :root {
            /* Premium Dark Palette */
            --bg-body: #0f172a;
            --bg-card: #1e293b;
            --bg-card-glass: rgba(30, 41, 59, 0.7);

            --primary: #10b981;
            /* Emerald 500 */
            --primary-glow: rgba(16, 185, 129, 0.4);
            --secondary: #6366f1;
            /* Indigo 500 */

            --text-main: #f8fafc;
            --text-muted: #94a3b8;

            --border: rgba(255, 255, 255, 0.08);
            --glass: blur(12px) saturate(160%);

            --nav-height: 70px;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding-bottom: calc(var(--nav-height) + 20px);
            /* Space for bottom nav */
            -webkit-font-smoothing: antialiased;
        }

        /* Premium Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 10px;
        }

        /* Typography */
        h1,
        h2,
        h3 {
            letter-spacing: -0.025em;
        }

        /* Mobile Layout */
        .app-container {
            max-width: 600px;
            /* Mobile focused max width */
            margin: 0 auto;
            padding: 20px;
        }

        /* Glass Cards */
        .glass-card {
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .sidebar-link:hover,
        .sidebar-link.active {
            background: rgba(59, 130, 246, 0.1);
            color: #60a5fa;
            border-right: 3px solid #60a5fa;
        }
    </style>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: { bg: '#0f172a', card: '#1e293b' },
                        brand: { blue: '#3b82f6', purple: '#8b5cf6', green: '#10b981', red: '#ef4444' }
                    }
                }
            }
        }
    </script>
</head>

<body x-data="gamePlayApp()" x-init="initApp()">

    <div class="app-container">

        <!-- HEADER MOBILE -->
        <header class="flex justify-between items-center mb-6 pt-2">
            <div>
                <h1 class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-emerald-400 to-cyan-500"
                    style="font-family: 'Outfit', sans-serif;">
                    Fantasy<span class="text-white">Pro</span>
                </h1>
                <p class="text-xs text-slate-400 tracking-wide">Manager Intelligence</p>
            </div>
            <div class="relative">
                <div
                    class="w-10 h-10 rounded-full bg-slate-800 flex items-center justify-center border border-slate-700 shadow-lg shadow-emerald-500/20">
                    <i class="fas fa-robot text-emerald-400 text-lg"></i>
                </div>
                <div class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 rounded-full border-2 border-slate-900">
                </div>
            </div>
        </header>

        <!-- INFO BAR -->
        <div
            class="flex items-center justify-between bg-slate-800/40 p-3 rounded-2xl border border-white/5 mb-6 backdrop-blur-sm">
            <div class="flex items-center gap-2 text-xs text-slate-400">
                <div class="w-2 h-2 rounded-full bg-blue-500 animate-pulse"></div>
                <span x-text="movements.length + ' movimientos'"></span>
            </div>
            <button @click="reconstructTradingHistory(); addLog('Recalculando...', 'info')"
                class="text-xs bg-blue-500/10 text-blue-400 px-3 py-1.5 rounded-lg border border-blue-500/20 font-semibold hover:bg-blue-500 hover:text-white transition-all">
                <i class="fas fa-sync-alt mr-1"></i> Sync
            </button>
        </div>

        <main class="space-y-6 pb-24">

            <!-- DASHBOARD -->
            <div x-show="currentView === 'dashboard'" class="space-y-6" x-transition.opacity>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="glass-card p-6 flex flex-col relative overflow-hidden group">
                        <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:scale-110 transition-transform">
                            <i class="fas fa-money-bill-wave text-6xl text-green-500"></i>
                        </div>
                        <span class="text-slate-400 text-xs font-bold uppercase tracking-wider">Volumen
                            Negociado</span>
                        <span class="text-2xl font-bold text-white mt-1"
                            x-text="formatMoney(calculateTotalVolume())"></span>
                    </div>
                    <div class="glass-card p-6 flex flex-col relative overflow-hidden group">
                        <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:scale-110 transition-transform">
                            <i class="fas fa-users text-6xl text-blue-500"></i>
                        </div>
                        <span class="text-slate-400 text-xs font-bold uppercase tracking-wider">Managers</span>
                        <span class="text-2xl font-bold text-white mt-1" x-text="Object.keys(managers).length"></span>
                    </div>
                    <div class="glass-card p-6 flex flex-col relative overflow-hidden group">
                        <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:scale-110 transition-transform">
                            <i class="fas fa-chart-line text-6xl text-purple-500"></i>
                        </div>
                        <span class="text-slate-400 text-xs font-bold uppercase tracking-wider">Mercado
                            (Jugadores)</span>
                        <span class="text-2xl font-bold text-white mt-1"
                            x-text="formatMoney(calculateMarketTotal())"></span>
                        <span class="text-xs text-green-400 mt-1"
                            x-text="Object.keys(marketData).length + ' jugadores'"></span>
                    </div>
                    <div class="glass-card p-6 flex flex-col relative overflow-hidden group">
                        <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:scale-110 transition-transform">
                            <i class="fas fa-trophy text-6xl text-yellow-500"></i>
                        </div>
                        <span class="text-slate-400 text-xs font-bold uppercase tracking-wider">L칤der
                            (Patrimonio)</span>
                        <span class="text-xl font-bold text-white mt-1 truncate"
                            x-text="marketValuation.sort((a,b)=>(b.marketValue+b.balance)-(a.marketValue+a.balance))[0]?.name || '-'"></span>
                    </div>
                </div>

                <div class="glass-card p-6">
                    <h3 class="text-lg font-bold text-white mb-4"><i
                            class="fas fa-trophy text-yellow-400 mr-2"></i>Clasificaci칩n R치pida</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="text-slate-400 border-b border-slate-700 text-xs uppercase">
                                    <th class="p-3">Manager</th>
                                    <th class="p-3 text-right">Caja</th>
                                    <th class="p-3 text-right">Plantilla</th>
                                    <th class="p-3 text-right font-bold text-white">Patrimonio Total</th>
                                    <th class="p-3 text-right text-blue-400">Puja M치x</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template
                                    x-for="mgr in marketValuation.sort((a,b) => (b.balance+b.marketValue)-(a.balance+a.marketValue))"
                                    :key="mgr.name">
                                    <tr class="border-b border-slate-700/50 hover:bg-slate-800/50 transition-colors">
                                        <td class="p-3 font-medium text-white" x-text="mgr.name"></td>
                                        <td class="p-3 text-right text-slate-400" x-text="formatMoney(mgr.balance)">
                                        </td>
                                        <td class="p-3 text-right text-green-400" x-text="formatMoney(mgr.marketValue)">
                                        </td>
                                        <td class="p-3 text-right font-bold text-white"
                                            x-text="formatMoney(mgr.balance + mgr.marketValue)"></td>
                                        <td class="p-3 text-right font-mono text-blue-400"
                                            x-text="formatMoney(mgr.balance + (mgr.marketValue * 0.2))"></td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- CLASIFICACION DETALLADA -->
            <div x-show="currentView === 'clasificacion'" class="space-y-6" x-transition.opacity>
                <div class="glass-card overflow-hidden">
                    <div class="p-4 bg-slate-900 border-b border-slate-800">
                        <h3 class="text-white font-bold"><i class="fas fa-chart-pie mr-2"></i>An치lisis Financiero &
                            Inflaci칩n</h3>
                    </div>
                    <table class="w-full text-left">
                        <thead class="bg-slate-900 border-b border-slate-700">
                            <tr class="text-slate-400 text-xs uppercase">
                                <th class="p-4">Manager</th>
                                <th class="p-4 text-right">Inversi칩n (Coste)</th>
                                <th class="p-4 text-right">Valor Actual</th>
                                <th class="p-4 text-right text-green-400">Inflaci칩n (Latente)</th>
                                <th class="p-4 text-right text-yellow-400">Profit Realizado</th>
                                <th class="p-4 text-right text-blue-400">ROI Total</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-800">
                            <template
                                x-for="mgr in marketValuation.sort((a,b) => b.unrealizedProfit - a.unrealizedProfit)"
                                :key="mgr.name">
                                <tr class="hover:bg-slate-800/50 transition-colors">
                                    <td class="p-4 font-semibold text-white" x-text="mgr.name"></td>
                                    <td class="p-4 text-right text-slate-400" x-text="formatMoney(mgr.invested)">
                                    </td>
                                    <td class="p-4 text-right text-white" x-text="formatMoney(mgr.marketValue)">
                                    </td>
                                    <td class="p-4 text-right font-bold"
                                        :class="mgr.unrealizedProfit > 0 ? 'text-green-500' : 'text-red-500'"
                                        x-text="formatMoney(mgr.unrealizedProfit)"></td>
                                    <td class="p-4 text-right font-mono text-yellow-500"
                                        x-text="formatMoney(tradingHistory.managerStats[mgr.name]?.profit || 0)">
                                    </td>
                                    <td class="p-4 text-right font-mono text-blue-400"
                                        x-text="mgr.invested > 0 ? ((mgr.unrealizedProfit / mgr.invested)*100).toFixed(1) + '%' : '0%'">
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- JUGADORES (ALL PLAYERS) -->
            <div x-show="currentView === 'jugadores'" class="space-y-6" x-transition.opacity>
                <div class="flex flex-wrap gap-4 mb-4">
                    <input type="text" x-model="playerFilters.search" placeholder="游댌 Buscar jugador..."
                        class="bg-slate-800 border-slate-700 rounded-lg p-3 text-white flex-grow focus:ring-2 focus:ring-blue-500 outline-none">
                    <select x-model="playerFilters.owner"
                        class="bg-slate-800 border-slate-700 rounded-lg p-3 text-white outline-none">
                        <option value="all">Todos los Estados</option>
                        <option value="free">Solo Libres</option>
                        <option value="owned">Con Due침o</option>
                    </select>
                    <select x-model="playerFilters.sort"
                        class="bg-slate-800 border-slate-700 rounded-lg p-3 text-white outline-none">
                        <option value="value_desc">Mayor Valor</option>
                        <option value="value_asc">Menor Valor</option>
                        <option value="cost_desc">Mayor Coste</option>
                    </select>
                </div>

                <div class="glass-card overflow-hidden">
                    <table class="w-full text-left">
                        <thead class="bg-slate-900 border-b border-slate-700">
                            <tr class="text-slate-400 text-xs uppercase">
                                <th class="p-4">Jugador</th>
                                <th class="p-4">Estado / Due침o</th>
                                <th class="p-4 text-right">Valor Mercado</th>
                                <th class="p-4 text-right">24h %</th>
                                <th class="p-4 text-right">Coste Adquisici칩n</th>
                                <th class="p-4 text-right">Diff</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-800">
                            <template x-for="p in filteredPlayers.slice(0, 5000)" :key="p.name">
                                <tr class="hover:bg-slate-800/50 transition-colors">
                                    <td class="p-4 font-medium text-white" x-text="p.name"></td>
                                    <td class="p-4">
                                        <span x-show="p.owner"
                                            class="px-2 py-1 rounded bg-blue-900/40 text-blue-300 text-xs border border-blue-800"
                                            x-text="p.owner"></span>
                                        <span x-show="!p.owner" class="text-slate-600 text-xs italic">Libre
                                            (Mercado)</span>
                                    </td>
                                    <td class="p-4 text-right font-mono text-green-400" x-text="formatMoney(p.value)">
                                    </td>
                                    <td class="p-4 text-right text-xs font-mono"
                                        :class="p.trendPct > 0 ? 'text-green-500' : (p.trendPct < 0 ? 'text-red-500' : 'text-slate-500')">
                                        <span x-show="p.trendPct !== 0">
                                            <i class="fas"
                                                :class="p.trendPct > 0 ? 'fa-caret-up' : 'fa-caret-down'"></i>
                                            <span x-text="Math.abs(p.trendPct) + '%'"></span>
                                        </span>
                                        <span x-show="p.trendPct === 0">-</span>
                                    </td>
                                    <td class="p-4 text-right text-slate-500 text-xs"
                                        x-text="p.cost ? formatMoney(p.cost) : '-'"></td>
                                    <td class="p-4 text-right text-xs"
                                        :class="p.value - p.cost > 0 ? 'text-green-500' : 'text-red-500'"
                                        x-text="p.cost ? formatMoney(p.value - p.cost) : '-'"></td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                    <div class="p-4 text-center text-slate-600 text-xs">Mostrando <span
                            x-text="Math.min(5000, filteredPlayers.length)"></span> de <span
                            x-text="filteredPlayers.length"></span> jugadores</div>
                </div>
            </div>

            <!-- MOVIMIENTOS -->
            <div x-show="currentView === 'movimientos'" class="space-y-6" x-transition.opacity>
                <div class="glass-card p-4 grid grid-cols-1 md:grid-cols-4 gap-4">
                    <input type="text" x-model="filters.search" placeholder="游댌 Buscar..."
                        class="bg-slate-800 border-slate-700 rounded-lg text-white p-2 outline-none focus:ring-1 focus:ring-blue-500">
                    <select x-model="filters.team"
                        class="bg-slate-800 border-slate-700 rounded-lg text-white p-2 outline-none">
                        <option value="all">Todos los Equipos</option>
                        <template x-for="(m, name) in managers" :key="name">
                            <option :value="name" x-text="name"></option>
                        </template>
                    </select>
                    <select x-model="filters.type"
                        class="bg-slate-800 border-slate-700 rounded-lg text-white p-2 outline-none">
                        <option value="all">Todos los tipos</option>
                        <option value="transfer">Traspasos</option>
                        <option value="market">Mercado</option>
                        <option value="clause">Cl치usulas</option>
                        <option value="reward">Premios</option>
                    </select>
                    <div class="text-right text-xs text-slate-500 flex items-center justify-end"><span
                            x-text="filteredMovements.length"></span> resultados</div>
                </div>

                <div class="glass-card overflow-hidden">
                    <table class="w-full">
                        <thead class="bg-slate-900 text-xs uppercase text-slate-400">
                            <tr>
                                <th class="p-3">Fecha</th>
                                <th class="p-3">Tipo</th>
                                <th class="p-3">Descripci칩n</th>
                                <th class="p-3 text-right">Sobrecoste (Est.)</th>
                                <th class="p-3 text-right">Importe</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-800">
                            <template x-for="m in filteredMovements.slice(0, 5000)" :key="m.id">
                                <tr class="hover:bg-slate-800/50">
                                    <td class="p-3 text-slate-400 text-xs whitespace-nowrap" x-text="m.date"></td>
                                    <td class="p-3">
                                        <span class="px-2 py-1 rounded text-[10px] font-bold uppercase" :class="{
                                                    'bg-green-900/50 text-green-300': m.type === 'transfer' && m.amount > 0,
                                                    'bg-red-900/50 text-red-300': m.type === 'transfer' && m.amount < 0,
                                                    'bg-blue-900/50 text-blue-300': m.type === 'shield',
                                                    'bg-yellow-900/50 text-yellow-300': m.type === 'reward'
                                                }" x-text="m.type === 'transfer' ? 'Fichaje' : m.type"></span>
                                    </td>
                                    <td class="p-3 text-sm text-slate-200">
                                        <div class="font-bold" x-text="m.player"></div>
                                        <div class="text-xs text-slate-500 flex items-center gap-2">
                                            <span x-text="m.seller"></span> <i
                                                class="fas fa-arrow-right text-[10px]"></i> <span
                                                x-text="m.buyer"></span>
                                        </div>
                                    </td>
                                    <td class="p-3 text-right text-xs font-mono text-slate-400">
                                        <template x-if="m.type === 'transfer' && marketData[m.player]">
                                            <span
                                                :class="(m.amount - marketData[m.player]) > 0 ? 'text-red-400' : 'text-green-400'">
                                                <span x-text="(m.amount - marketData[m.player]) > 0 ? '+' : ''"></span>
                                                <span x-text="formatMoney(m.amount - marketData[m.player])"></span>
                                            </span>
                                        </template>
                                        <template x-if="!(m.type === 'transfer' && marketData[m.player])">
                                            <span>-</span>
                                        </template>
                                    </td>
                                    <td class="p-3 text-right font-mono text-white" x-text="formatMoney(m.amount)">
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- NEGOCIOS -->
            <div x-show="currentView === 'negocios'" class="space-y-6" x-transition.opacity>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="glass-card p-6">
                        <h3 class="text-lg font-bold text-green-400 mb-4"><i class="fas fa-chart-line mr-2"></i>Mejores
                            "Flips" (Profit)</h3>
                        <div class="space-y-3">
                            <template x-for="(deal, i) in bestDeals.slice(0,50)" :key="i">
                                <div
                                    class="flex items-center justify-between p-3 bg-slate-800/40 rounded-lg border border-slate-700/50 hover:bg-slate-800 transition-colors">
                                    <div class="flex items-center gap-3">
                                        <div class="text-green-500 font-bold text-lg w-6 text-center" x-text="i+1">
                                        </div>
                                        <div>
                                            <div class="font-bold text-white" x-text="deal.player"></div>
                                            <div class="text-xs text-slate-400" x-text="deal.manager"></div>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div class="font-mono text-green-400 font-bold"
                                            x-text="'+' + formatMoney(deal.profit)"></div>
                                        <div class="text-xs text-slate-500" x-text="deal.roi.toFixed(0) + '% ROI'">
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>

                    <div class="glass-card p-6">
                        <h3 class="text-lg font-bold text-red-400 mb-4"><i class="fas fa-level-down-alt mr-2"></i>Peores
                            "Ruinas" (Loss)</h3>
                        <div class="space-y-3">
                            <template x-for="(deal, i) in worstDeals.slice(0,50)" :key="i">
                                <div
                                    class="flex items-center justify-between p-3 bg-slate-800/40 rounded-lg border border-slate-700/50 hover:bg-slate-800 transition-colors">
                                    <div class="flex items-center gap-3">
                                        <div class="text-red-500 font-bold text-lg w-6 text-center" x-text="i+1">
                                        </div>
                                        <div>
                                            <div class="font-bold text-white" x-text="deal.player"></div>
                                            <div class="text-xs text-slate-400" x-text="deal.manager"></div>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div class="font-mono text-red-500 font-bold" x-text="formatMoney(deal.profit)">
                                        </div>
                                        <div class="text-xs text-slate-500">P칠rdida</div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>

                    <div class="glass-card p-6 lg:col-span-2">
                        <h3 class="text-lg font-bold text-blue-400 mb-4"><i
                                class="fas fa-search-dollar mr-2"></i>An치lisis de Pujas (Patrones)</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <template x-for="(stats, mgr) in calculateBidPatterns()" :key="mgr">
                                <div class="bg-slate-800/40 p-4 rounded-lg border border-slate-700">
                                    <div class="font-bold text-white mb-2" x-text="mgr"></div>
                                    <div class="space-y-1 text-xs">
                                        <div class="flex justify-between">
                                            <span class="text-slate-400">Pujas Totales</span>
                                            <span class="text-white" x-text="stats.total"></span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-slate-400">Redondas (..000)</span>
                                            <span class="text-green-400"
                                                x-text="((stats.round/stats.total)*100).toFixed(0) + '%'"></span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-slate-400">Estrat칠gicas (..001)</span>
                                            <span class="text-yellow-400"
                                                x-text="((stats.strategic/stats.total)*100).toFixed(0) + '%'"></span>
                                        </div>
                                        <div class="flex justify-between border-t border-slate-700 pt-1 mt-1">
                                            <span class="text-slate-400">Sobrecoste Medio</span>
                                            <span class="text-blue-400" x-text="stats.avgOverbid + '%'"></span>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
            </div>

    </div>
    </div>

    <!-- INTELLIGENCE (PRO) -->
    <div x-show="currentView === 'intelligence'" class="space-y-6" x-transition.opacity>
        <!-- Cheat Sheet -->
        <div class="glass-card p-6 border border-yellow-500/30">
            <h3 class="text-xl font-bold text-yellow-400 mb-4"><i class="fas fa-lightbulb mr-2"></i>Cheat Sheet de
                Mercado (Oportunidades)</h3>
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead class="text-xs uppercase text-slate-400 bg-black/20">
                        <tr>
                            <th class="p-3">Jugador</th>
                            <th class="p-3 text-right">VM Hoy</th>
                            <th class="p-3">Raz칩n IA</th>
                            <th class="p-3 text-right">Puja Sugerida</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-800">
                        <template x-for="op in cheatSheet" :key="op.player">
                            <tr class="hover:bg-slate-800/50">
                                <td class="p-3 font-bold text-white" x-text="op.player"></td>
                                <td class="p-3 text-right font-mono text-slate-300" x-text="formatMoney(op.vm)"></td>
                                <td class="p-3 text-xs text-blue-300" x-text="op.reason"></td>
                                <td class="p-3 text-right font-mono text-green-400 font-bold"
                                    x-text="formatMoney(op.bid)"></td>
                            </tr>
                        </template>
                        <tr x-show="!cheatSheet.length">
                            <td colspan="4" class="p-4 text-center text-slate-500">No hay oportunidades claras
                                detectadas hoy.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Manager Psychology -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="glass-card p-6">
                <h3 class="text-lg font-bold text-purple-400 mb-4"><i class="fas fa-brain mr-2"></i>Psicolog칤a de Puja
                    (Spread Medio)</h3>
                <div class="space-y-4">
                    <template x-for="psy in calculatePsychology()" :key="psy.name">
                        <div class="bg-slate-800/50 p-3 rounded-lg">
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-bold text-white" x-text="psy.name"></span>
                                <span class="text-xs font-mono px-2 py-1 rounded bg-purple-900/50 text-purple-300"
                                    x-text="'Avg Spread: ' + psy.avgSpread + '%'"></span>
                            </div>
                            <div class="grid grid-cols-4 gap-2 text-xs text-center">
                                <div class="bg-slate-900/50 rounded p-1">
                                    <div class="text-slate-500">PT</div>
                                    <div class="text-white" x-text="(psy.posSpreads.PT || '-') + '%'"></div>
                                </div>
                                <div class="bg-slate-900/50 rounded p-1">
                                    <div class="text-slate-500">DF</div>
                                    <div class="text-white" x-text="(psy.posSpreads.DF || '-') + '%'"></div>
                                </div>
                                <div class="bg-slate-900/50 rounded p-1">
                                    <div class="text-slate-500">MC</div>
                                    <div class="text-white" x-text="(psy.posSpreads.MC || '-') + '%'"></div>
                                </div>
                                <div class="bg-slate-900/50 rounded p-1">
                                    <div class="text-slate-500">DL</div>
                                    <div class="text-white" x-text="(psy.posSpreads.DL || '-') + '%'"></div>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <div class="glass-card p-6">
                <h3 class="text-lg font-bold text-orange-400 mb-4"><i class="fas fa-map mr-2"></i>Mapa de Necesidad
                    (Plantillas)</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-xs text-center">
                        <thead>
                            <tr class="text-slate-400">
                                <th class="p-2 text-left">Manager</th>
                                <th class="p-2">PT</th>
                                <th class="p-2">DF</th>
                                <th class="p-2">MC</th>
                                <th class="p-2">DL</th>
                                <th class="p-2">Total</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-800">
                            <template x-for="(needs, mgr) in calculateNeedMap()" :key="mgr">
                                <tr>
                                    <td class="p-2 text-left text-white font-medium" x-text="mgr"></td>
                                    <td class="p-2"
                                        :class="needs.PT < 1 ? 'text-red-500 font-bold bg-red-900/10' : 'text-slate-300'"
                                        x-text="needs.PT"></td>
                                    <td class="p-2"
                                        :class="needs.DF < 4 ? 'text-red-500 font-bold bg-red-900/10' : 'text-slate-300'"
                                        x-text="needs.DF"></td>
                                    <td class="p-2"
                                        :class="needs.MC < 4 ? 'text-red-500 font-bold bg-red-900/10' : 'text-slate-300'"
                                        x-text="needs.MC"></td>
                                    <td class="p-2"
                                        :class="needs.DL < 2 ? 'text-red-500 font-bold bg-red-900/10' : 'text-slate-300'"
                                        x-text="needs.DL"></td>
                                    <td class="p-2 text-slate-500" x-text="needs.total"></td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- IMPORT (Magic Parser) -->
    <div x-show="currentView === 'importar'" class="space-y-6" x-transition.opacity>
        <div class="glass-card p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-bold text-white">Importador Inteligente</h2>
                <button @click="processInput()"
                    class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg font-bold text-sm">
                    <i class="fas fa-bolt mr-2"></i> Procesar
                </button>
            </div>

            <div
                class="mb-4 p-3 bg-blue-900/20 border border-blue-500/30 rounded-lg text-xs text-blue-300 flex items-center gap-2">
                <i class="fas fa-info-circle text-lg"></i>
                <div>
                    <strong>쮽altan datos antiguos?</strong>
                    <p>Re-importa tu archivo <code>movimientos_smart.txt</code> pegando su contenido abajo
                        para restaurar todo el historial en esta nueva versi칩n V2.0.</p>
                </div>
            </div>
            <textarea x-model="rawInput"
                class="w-full bg-slate-900/80 text-slate-300 p-4 rounded-lg font-mono text-xs border border-slate-700 focus:border-blue-500 outline-none h-64"
                placeholder="Pega aqu칤 el HTML completo de Mercado, o las l칤neas de texto de Movimientos..."></textarea>

            <div
                class="mt-4 bg-black/40 p-4 rounded-lg font-mono text-xs h-48 overflow-y-auto border border-slate-800/50">
                <template x-for="log in logs" :key="log.id">
                    <div class="mb-1 border-l-2 pl-2" :class="{
                                    'border-green-500 text-green-400': log.type === 'success',
                                    'border-red-500 text-red-400': log.type === 'error',
                                    'border-yellow-500 text-yellow-300': log.type === 'warning',
                                    'border-blue-500 text-slate-400': log.type === 'info'
                                }">
                        <span x-text="log.message"></span>
                    </div>
                </template>
            </div>
        </div>
    </div>

    </main>
    </div>

    <!-- BOTTOM NAV -->
    <nav class="bottom-nav">
        <template x-for="item in navItems" :key="item.id">
            <a href="#" @click.prevent="currentView = item.id" class="nav-item"
                :class="{ 'active': currentView === item.id }">
                <i :class="item.icon"></i>
                <span x-text="item.label" class="mt-1" style="font-size: 10px;"></span>
            </a>
        </template>
    </nav>

    <script>
        function gamePlayApp() {
            return {
                collapsed: false,
                currentView: 'dashboard',
                navItems: [
                    { id: 'dashboard', label: 'Inicio', icon: 'fas fa-home' },
                    { id: 'intelligence', label: 'Intel.', icon: 'fas fa-brain' },
                    { id: 'negocios', label: 'Negocios', icon: 'fas fa-chart-pie' },
                    { id: 'jugadores', label: 'Mercado', icon: 'fas fa-users' },
                    { id: 'importar', label: 'Ajustes', icon: 'fas fa-cog' }
                ],

                managers: {
                    "Vigar FC": { initialBudget: 103000000, teamValue: 0, clauseExpenses: 0, name: "Vigar FC" },
                    "GOLENCIERRO FC": { initialBudget: 103000000, teamValue: 0, clauseExpenses: 0, name: "GOLENCIERRO FC" },
                    "Pablinistan FC": { initialBudget: 103000000, teamValue: 0, clauseExpenses: 0, name: "Pablinistan FC" },
                    "Alcatamy eSports By": { initialBudget: 100000000, teamValue: 0, clauseExpenses: 0, name: "Alcatamy eSports By" },
                    "Visite La Manga FC": { initialBudget: 100000000, teamValue: 0, clauseExpenses: 0, name: "Visite La Manga FC" },
                    "Morenazos FC": { initialBudget: 100000000, teamValue: 0, clauseExpenses: 0, name: "Morenazos FC" }
                },
                movements: [],
                pendingMovements: [],
                marketData: typeof MARKET_DATA !== 'undefined' ? MARKET_DATA : {},
                marketInfo: typeof MARKET_INFO !== 'undefined' ? MARKET_INFO : {},
                marketTrends: typeof MARKET_TRENDS !== 'undefined' ? MARKET_TRENDS : {},

                // Persistence
                logs: [],
                rawInput: '',

                tradingHistory: { closedDeals: [], rosters: {}, managerStats: {} },

                filters: { search: '', team: 'all', type: 'all' },
                playerFilters: { search: '', owner: 'all', sort: 'value_desc' },

                // COMPUTED
                get filteredMovements() {
                    return this.movements.filter(m => {
                        const s = this.filters.search.toLowerCase();
                        const matchSearch = !s || m.player.toLowerCase().includes(s) || m.buyer.toLowerCase().includes(s) || m.seller.toLowerCase().includes(s);
                        const matchTeam = this.filters.team === 'all' || m.buyer === this.filters.team || m.seller === this.filters.team;
                        const matchType = this.filters.type === 'all' ||
                            (this.filters.type === 'transfer' && m.type === 'transfer') ||
                            (this.filters.type === 'market' && (m.buyer === 'Mercado' || m.seller === 'Mercado')) ||
                            (this.filters.type === 'reward' && m.type === 'reward') ||
                            (this.filters.type === 'clause' && m.type === 'shield');
                        return matchSearch && matchTeam && matchType;
                    }).sort((a, b) => this.parseDate(b.date) - this.parseDate(a.date));
                },

                get marketValuation() {
                    if (!Object.keys(this.tradingHistory.rosters).length) this.reconstructTradingHistory();

                    // First calculate initial balances
                    const balances = {};
                    Object.values(this.managers).forEach(m => balances[m.name] = m.initialBudget - (m.clauseExpenses || 0));

                    // Process balances
                    this.movements.forEach(m => {
                        const amt = parseInt(m.amount) || 0;
                        if (m.type === 'transfer') {
                            if (balances[m.buyer] !== undefined) balances[m.buyer] -= amt;
                            if (balances[m.seller] !== undefined) balances[m.seller] += amt;
                        } else if (m.type === 'reward' && balances[m.beneficiary] !== undefined) {
                            balances[m.beneficiary] += amt;
                        }
                    });

                    return Object.keys(this.tradingHistory.rosters).map(mgr => {
                        const roster = this.tradingHistory.rosters[mgr];
                        let val = 0;
                        let inv = 0;
                        Object.keys(roster).forEach(pName => {
                            let v = this.marketData[pName] || 0;
                            if (v === 0) {
                                // Fuzzy match
                                const match = Object.keys(this.marketData).find(k => k.toLowerCase() === pName.toLowerCase() || k.includes(pName) || pName.includes(k));
                                if (match) v = this.marketData[match];
                            }
                            val += v;
                            inv += roster[pName].cost;
                        });

                        return {
                            name: mgr,
                            marketValue: val,
                            invested: inv,
                            unrealizedProfit: val - inv,
                            balance: balances[mgr] || 0
                        };
                    });
                },

                get bestDeals() { return [...this.tradingHistory.closedDeals].sort((a, b) => b.profit - a.profit); },
                get worstDeals() { return [...this.tradingHistory.closedDeals].sort((a, b) => a.profit - b.profit); },

                get filteredPlayers() {
                    if (!Object.keys(this.tradingHistory.rosters).length) this.reconstructTradingHistory();

                    const ownedPlayers = {};
                    Object.keys(this.tradingHistory.rosters).forEach(mgr => {
                        Object.keys(this.tradingHistory.rosters[mgr]).forEach(pName => {
                            ownedPlayers[pName] = { owner: mgr, cost: this.tradingHistory.rosters[mgr][pName].cost };
                        });
                    });

                    let allPlayers = Object.keys(this.marketData).map(name => ({
                        name: name,
                        value: this.marketData[name],
                        trendPct: this.marketTrends[name]?.pct || 0,
                        owner: ownedPlayers[name]?.owner || null,
                        cost: ownedPlayers[name]?.cost || 0
                    }));

                    // Add missing owned players
                    Object.keys(ownedPlayers).forEach(pName => {
                        if (!this.marketData[pName]) {
                            allPlayers.push({ name: pName, value: 0, owner: ownedPlayers[pName].owner, cost: ownedPlayers[pName].cost });
                        }
                    });

                    return allPlayers.filter(p => {
                        const s = this.playerFilters.search.toLowerCase();
                        const matchSearch = !s || p.name.toLowerCase().includes(s);
                        const matchOwner = this.playerFilters.owner === 'all' ||
                            (this.playerFilters.owner === 'owned' && p.owner) ||
                            (this.playerFilters.owner === 'free' && !p.owner);
                        return matchSearch && matchOwner;
                    }).sort((a, b) => {
                        if (this.playerFilters.sort === 'value_desc') return b.value - a.value;
                        if (this.playerFilters.sort === 'value_asc') return a.value - b.value;
                        if (this.playerFilters.sort === 'cost_desc') return (b.cost || 0) - (a.cost || 0);
                        return 0;
                    });
                },

                // METHODS
                async initApp() {
                    // Firebase Sync
                    const dbRef = db.ref('fantasy_gameplay_data');
                    dbRef.on('value', (snapshot) => {
                        const data = snapshot.val();
                        if (data) {
                            // Merge Strategy: Prefer Cloud if newer? Or just overwrite?
                            // User wants real-time sync. Overwrite is standard.
                            this.movements = data.movements || [];
                            if (data.managers) this.managers = data.managers;
                            if (data.marketData) this.marketData = data.marketData;
                            this.reconstructTradingHistory();
                            this.addLog('Sincronizado con Nube', 'success');

                            // Backup to Local
                            localStorage.setItem('fantasy_gameplay_data', JSON.stringify(data));
                        }
                    });

                    // Fallback Local
                    const saved = localStorage.getItem('fantasy_gameplay_data');
                    if (saved) {
                        try {
                            const parsed = JSON.parse(saved);
                            this.movements = parsed.movements || [];
                            if (parsed.managers) {
                                // Merge logic...
                                this.managers = { ...this.managers, ...parsed.managers };
                            }
                            if (parsed.marketData) this.marketData = parsed.marketData;
                            if (parsed.marketInfo) this.marketInfo = parsed.marketInfo;
                            this.addLog('Datos cargados de memoria', 'success');
                        } catch (e) { console.error(e); }
                    } else if (typeof DEFAULT_MOVEMENTS !== 'undefined') {
                        // First Run: Load Historical Data
                        console.log("Loading default movements...");
                        this.processInput(DEFAULT_MOVEMENTS);

                        // Load Market Data from Global Constants
                        if (typeof MARKET_DATA !== 'undefined') this.marketData = MARKET_DATA;
                        if (typeof MARKET_INFO !== 'undefined') this.marketInfo = MARKET_INFO;

                        this.addLog('Hist칩rico inicial cargado', 'success');
                    }

                    this.reconstructTradingHistory();

                    this.$watch('movements', () => { this.debouncedSaveData(); this.reconstructTradingHistory(); });
                    this.$watch('marketData', () => { this.debouncedSaveData(); this.reconstructTradingHistory(); });
                },

                formatMoney(amount) {
                    return new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 }).format(amount);
                },

                addLog(msg, type = 'info') {
                    this.logs.unshift({ id: Date.now(), message: msg, type, timestamp: Date.now() });
                },

                // CORE LOGIC V2
                reconstructTradingHistory() {
                    // Sorting crucial for replay
                    const sorted = [...this.movements].sort((a, b) => this.parseDate(a.date) - this.parseDate(b.date));
                    const rosters = {};
                    const managerStats = {};
                    const closedDeals = [];

                    Object.keys(this.managers).forEach(m => {
                        rosters[m] = {};
                        managerStats[m] = { profit: 0, sales: 0, buys: 0 };
                    });

                    sorted.forEach(m => {
                        const amt = parseInt(m.amount) || 0;
                        if (m.type === 'transfer') {
                            // Seller
                            if (this.managers[m.seller] || rosters[m.seller]) {
                                if (!rosters[m.seller]) rosters[m.seller] = {};

                                if (rosters[m.seller][m.player]) {
                                    const buyPrice = rosters[m.seller][m.player].cost;
                                    const profit = amt - buyPrice;
                                    const roi = buyPrice > 0 ? (profit / buyPrice) * 100 : 0;
                                    closedDeals.push({ player: m.player, manager: m.seller, buyPrice, sellPrice: amt, profit, roi, date: m.date });
                                    if (managerStats[m.seller]) managerStats[m.seller].profit += profit;
                                    delete rosters[m.seller][m.player];
                                }
                            }
                            // Buyer
                            if (this.managers[m.buyer] || rosters[m.buyer]) {
                                if (!rosters[m.buyer]) rosters[m.buyer] = {};
                                rosters[m.buyer][m.player] = { cost: amt, date: m.date };
                            }
                        }
                    });

                    this.tradingHistory = { closedDeals, rosters, managerStats };
                },

                saveData() {
                    const data = {
                        movements: this.movements,
                        marketData: this.marketData,
                        managers: this.managers,
                        lastUpdate: Date.now()
                    };
                    // Save to Cloud
                    db.ref('fantasy_gameplay_data').set(data).catch(e => console.error(e));
                    // Save to Local
                    localStorage.setItem('fantasy_gameplay_data', JSON.stringify(data));
                },
                debouncedSaveData() { clearTimeout(this._tm); this._tm = setTimeout(() => this.saveData(), 1000); },

                parseDate(dateStr) {
                    if (!dateStr || dateStr === 'NODATE') return 0;
                    if (dateStr.match(/^\d{2}\/\d{2}\/\d{4}/)) {
                        const [d, m, y] = dateStr.split(' ')[0].split('/');
                        return new Date(y, m - 1, d).getTime();
                    }
                    return 0;
                },

                calculateTotalVolume() { return this.movements.reduce((acc, m) => acc + (parseInt(m.amount) || 0), 0); },
                calculateMarketTotal() { return Object.values(this.marketData).reduce((a, b) => a + b, 0); },

                calculateBidPatterns() {
                    const stats = {};
                    this.movements.forEach(m => {
                        if (m.type === 'transfer' && m.amount > 0) {
                            if (!stats[m.buyer]) stats[m.buyer] = { total: 0, round: 0, strategic: 0, overbidSum: 0, overbidCount: 0 };

                            stats[m.buyer].total++;
                            if (m.amount % 1000 === 0) stats[m.buyer].round++;
                            if (m.amount % 10 === 1) stats[m.buyer].strategic++;

                            // Estimate Overbid vs Current Value (Proxy)
                            const mv = this.marketData[m.player];
                            if (mv && mv > 0) {
                                const overbid = ((m.amount - mv) / mv) * 100;
                                stats[m.buyer].overbidSum += overbid;
                                stats[m.buyer].overbidCount++;
                            }
                        }
                    });

                    const result = {};
                    Object.keys(stats).forEach(k => {
                        const s = stats[k];
                        result[k] = {
                            total: s.total,
                            round: s.round,
                            strategic: s.strategic,
                            avgOverbid: s.overbidCount > 0 ? (s.overbidSum / s.overbidCount).toFixed(1) : 0
                        };
                    });
                    // Sort by Total Activity
                    return Object.entries(result).sort((a, b) => b[1].total - a[1].total).reduce((acc, [k, v]) => ({ ...acc, [k]: v }), {});
                },

                calculatePsychology() {
                    const stats = {};
                    Object.keys(this.managers).forEach(m => stats[m] = {
                        spread: { total: 0, count: 0, pos: {} },
                        holding: [],
                        weakHand: 0
                    });

                    // 1. Holding Period & Spread
                    const playerAcqDate = {};

                    this.movements.slice().reverse().forEach(m => { // Chronological
                        if (m.type === 'transfer') {
                            const date = this.parseDate(m.date);

                            // Buyer Logic (Acquisition)
                            playerAcqDate[m.player] = date;

                            // Seller Logic (Retention)
                            if (m.seller !== 'Mercado' && stats[m.seller]) {
                                // Calculate Holding
                                // We need when seller bought this player. 
                                // Simplified: if we tracked it.
                                // Complex: We need full tracing. Logic already exists in rosters? 
                                // Let's use simpleheuristic: if we moved it before?
                                // Improved: Use roster tracking.
                            }

                            // Spread Logic (Psychology)
                            if (m.buyer !== 'Mercado' && stats[m.buyer]) {
                                const val = this.marketData[m.player] || 0; // WARNING: Current Value Proxy
                                if (val > 0) {
                                    const spread = ((m.amount - val) / val) * 100;
                                    stats[m.buyer].spread.total += spread;
                                    stats[m.buyer].spread.count++;

                                    // Segment by Position
                                    const pos = this.marketInfo[m.player]?.position || 'UNK';
                                    if (!stats[m.buyer].spread.pos[pos]) stats[m.buyer].spread.pos[pos] = { sum: 0, count: 0 };
                                    stats[m.buyer].spread.pos[pos].sum += spread;
                                    stats[m.buyer].spread.pos[pos].count++;
                                }
                            }
                        }
                    });

                    return Object.keys(stats).map(name => {
                        const s = stats[name];
                        const avgSpread = s.spread.count ? (s.spread.total / s.spread.count) : 0;
                        const posSpreads = {};
                        Object.keys(s.spread.pos).forEach(p => {
                            posSpreads[p] = (s.spread.pos[p].sum / s.spread.pos[p].count).toFixed(1);
                        });

                        return {
                            name,
                            avgSpread: avgSpread.toFixed(1),
                            posSpreads
                        };
                    });
                },

                get cheatSheet() {
                    // Logic: Analyze trends, overbids, and needs
                    const opportunities = [];
                    const psychology = this.calculatePsychology();

                    // Simple Strategy: Free players with high value or trend
                    this.filteredPlayers.forEach(p => {
                        if (!p.owner) { // Free
                            // Rule 1: Rising Star
                            if (p.trendPct > 2) {
                                opportunities.push({
                                    player: p.name,
                                    vm: p.value,
                                    reason: 'Subida fuerte (' + p.trendPct + '%). Especulaci칩n.',
                                    bid: p.value * 1.05 // +5%
                                });
                            }
                            // Rule 2: Top Value available
                            else if (p.value > 10000000) {
                                opportunities.push({
                                    player: p.name,
                                    vm: p.value,
                                    reason: 'Crack libre. Pujar fuerte.',
                                    bid: p.value * 1.15 // +15% default
                                });
                            }
                        }
                    });

                    return opportunities.sort((a, b) => b.vm - a.vm).slice(0, 10);
                },

                calculateNeedMap() {
                    if (!Object.keys(this.tradingHistory.rosters).length) this.reconstructTradingHistory();
                    const map = {};

                    Object.keys(this.tradingHistory.rosters).forEach(mgr => {
                        map[mgr] = { DL: 0, MC: 0, DF: 0, PT: 0, total: 0 };
                        Object.keys(this.tradingHistory.rosters[mgr]).forEach(pName => {
                            const pos = this.marketInfo[pName]?.position; // Need match
                            if (pos) {
                                if (pos.includes('DL')) map[mgr].DL++;
                                else if (pos.includes('MC')) map[mgr].MC++;
                                else if (pos.includes('DF')) map[mgr].DF++;
                                else if (pos.includes('PT')) map[mgr].PT++; // Analitica uses PT? Check scrap
                            }
                            map[mgr].total++;
                        });
                    });
                    return map;
                },

                // ROBUST PARSERS (FROM v1)
                processInput() {
                    const text = this.rawInput;
                    if (!text.trim()) return;

                    const startTime = performance.now();

                    // HTML Detection
                    if (text.includes('comuniate') || text.includes('ficha_jugador') || text.includes('label-posicion')) {
                        this.parseComuniateData(text);
                        return;
                    }
                    if (text.includes('<html') || text.includes('MuiTypography') || text.includes('__NEXT_DATA__')) {
                        this.parseMarketDataRegex(text); // Use Regex fallback for reliability
                        return;
                    }

                    const existingIds = new Set(this.movements.map(m => m.id));
                    const pendingIds = new Set(this.pendingMovements.map(m => m.id));
                    const lines = text.split('\n');
                    let tempDate = null;

                    // Regex Patterns
                    const reSmartFormat = /^\[([^\]]+)\] (.+)/;
                    const reDate = /(\d{2}\/\d{2}\/\d{4})/;
                    const reTransfer = /(.+?) ha (comprado|vendido) al jugador (.+?) (?:de|a) (.+?) por ([\d\.]+)[]?/;
                    const reShield = /(.+?) ha blindado a (.+)/i;
                    const reRewardJornada = /En la jornada (\d+), (.+?) ha ganado ([\d\.]+)[]?/i;
                    const reTeamValue = /([^\n]+)\s+(\d+)\s+PFSY\s+([\d\.]+)/; // Team value heuristic

                    const normalizeDate = (d) => {
                        if (/^\d{1,2}:\d{2}$/.test(d)) {
                            const today = new Date();
                            return `${String(today.getDate()).padStart(2, '0')}/${String(today.getMonth() + 1).padStart(2, '0')}/${today.getFullYear()} ${d}`;
                        }
                        return d || 'NODATE';
                    };

                    lines.forEach(line => {
                        line = line.trim();
                        if (!line || line.startsWith('#')) return;

                        let dateKey = tempDate;
                        let textToParse = line;

                        const smartMatch = line.match(reSmartFormat);
                        if (smartMatch) { dateKey = smartMatch[1].trim(); textToParse = smartMatch[2]; }
                        else if (reDate.test(line)) { tempDate = line.match(reDate)[1]; return; }

                        // Transfer
                        let match = textToParse.match(reTransfer);
                        if (match) {
                            const [_, actor, action, player, other, amtStr] = match;
                            const amount = parseInt(amtStr.replace(/\./g, ''));
                            const buyer = action === 'comprado' ? actor.trim() : other.trim();
                            const seller = action === 'comprado' ? other.trim() : actor.trim();
                            const id = `transfer_${normalizeDate(dateKey)}_${buyer}_${seller}_${player}_${amount}`;

                            if (!pendingIds.has(id) && !existingIds.has(id)) {
                                pendingIds.add(id);
                                this.pendingMovements.push({ id, type: 'transfer', buyer, seller, player, amount, date: normalizeDate(dateKey) });
                            }
                            return;
                        }

                        // Shield
                        match = textToParse.match(reShield);
                        if (match) {
                            const id = `shield_${normalizeDate(dateKey)}_${match[1].trim()}_${match[2].trim()}`;
                            if (!pendingIds.has(id) && !existingIds.has(id)) {
                                pendingIds.add(id);
                                this.pendingMovements.push({ id, type: 'shield', beneficiary: match[1].trim(), player: match[2].trim(), amount: 0, date: normalizeDate(dateKey) });
                            }
                            return;
                        }

                        // Reward
                        match = textToParse.match(reRewardJornada);
                        if (match) {
                            const id = `reward_jor${match[1]}_${match[2].trim()}`;
                            if (!pendingIds.has(id) && !existingIds.has(id)) {
                                pendingIds.add(id);
                                this.pendingMovements.push({ id, type: 'reward', subtype: 'jornada', beneficiary: match[2].trim(), amount: parseInt(match[3].replace(/\./g, '')), date: normalizeDate(dateKey) });
                            }
                        }
                    });

                    if (this.pendingMovements.length > 0) this.addLog(`Detectados ${this.pendingMovements.length} movimientos.`, 'info');
                    else this.addLog('No se detectaron movimientos.', 'warning');
                },

                parseComuniateData(text) {
                    // Create a dummy DOM to parse HTML string
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(text, 'text/html');
                    const cards = doc.querySelectorAll('.ficha_jugador');
                    let count = 0;

                    cards.forEach(card => {
                        // Name
                        let name = "Unknown";
                        const nameEl = card.querySelector('.titulo_ficha_jugador');
                        if (nameEl) name = nameEl.textContent.trim();
                        else {
                            // Fallback
                            const lines = card.textContent.split('\n');
                            for (let line of lines) {
                                line = line.trim();
                                if (line.length > 3 && !line.includes('') && !['PT', 'DF', 'MD', 'MC', 'DL'].some(p => line.includes(p))) {
                                    name = line;
                                    break;
                                }
                            }
                        }

                        // Position & Points
                        let pos = "UNK";
                        let points = 0;
                        const badges = card.querySelectorAll('.label-posicion');
                        badges.forEach(b => {
                            const txt = b.textContent.trim().toUpperCase();
                            if (['PT', 'DF', 'MD', 'MC', 'DL', 'CEN'].includes(txt)) pos = txt;
                            else if (!isNaN(parseInt(txt)) || (txt.startsWith('-') && !isNaN(parseInt(txt.substring(1))))) {
                                points = parseInt(txt);
                            }
                        });

                        // Price
                        let price = 0;
                        const content = card.textContent;
                        const moneyMatch = content.match(/([\d\.]+)/);
                        if (moneyMatch) {
                            price = parseInt(moneyMatch[1].replace(/\./g, ''));
                        }

                        // Trend (Optional but cool if present)
                        const trendEl = card.querySelector('.success, .danger');
                        let trend = 0;
                        if (trendEl) {
                            try {
                                trend = parseInt(trendEl.textContent.replace(/\./g, '').replace('', '').replace('+', '').trim());
                            } catch (e) { }
                        }

                        if (name !== 'Unknown' && price > 0) {
                            this.marketData[name] = price;
                            this.marketInfo[name] = { position: pos, points: points, value: price }; // Rich Update

                            // Calc Trend Pct
                            let pct = 0;
                            if ((price - trend) > 0) pct = (trend / (price - trend)) * 100;
                            this.marketTrends[name] = { trend: trend, trendPct: parseFloat(pct.toFixed(1)) };

                            count++;
                        }
                    });

                    this.addLog(`Comuniate Parse: ${count} jugadores actualizados.`, 'success');
                    this.debouncedSaveData();
                },

                parseMarketDataRegex(text) {
                    const parts = text.split('class="MuiBox-root css-1j0r1in"');
                    let count = 0;
                    parts.forEach(part => {
                        const nameMatch = part.match(/MuiTypography-body2[^>]*>\s*([^<]+)<\/p>/);
                        const valMatch = part.match(/MuiTypography-body1[^>]*>\s*([\d\.]+) <\/p>/);
                        if (nameMatch && valMatch) {
                            const name = nameMatch[1].trim();
                            const val = parseInt(valMatch[1].replace(/\./g, ''));
                            this.marketData[name] = val;
                            count++;
                        }
                    });
                    this.addLog(`Mercado (HTML Regex) actualizado: ${count} jugadores`, 'success');
                    this.debouncedSaveData();
                },

                confirmImport() {
                    this.movements = [...this.movements, ...this.pendingMovements];
                    this.pendingMovements = [];
                    this.saveData();
                    this.reconstructTradingHistory();
                    this.addLog('Importaci칩n confirmada', 'success');
                    this.rawInput = '';
                },
                cancelImport() { this.pendingMovements = []; this.rawInput = ''; }
            }
        }
    </script>
</body>

</html>