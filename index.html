<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GamePlay Manager | Fantasy League</title>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚öΩ</text></svg>">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    animation: {
                        'gradient-x': 'gradient-x 3s ease infinite',
                    },
                    keyframes: {
                        'gradient-x': {
                            '0%, 100%': {
                                'background-size': '200% 200%',
                                'background-position': 'left center'
                            },
                            '50%': {
                                'background-size': '200% 200%',
                                'background-position': 'right center'
                            },
                        },
                    },
                    colors: {
                        gray: {
                            850: '#1f2937',
                            900: '#111827',
                            950: '#030712',
                        },
                        neon: {
                            blue: '#00f3ff',
                            green: '#00ff9d',
                            pink: '#ff00d4',
                            purple: '#bc13fe'
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="market_data.js"></script>
    <script src="movements_data.js"></script>
    <!-- Chart.js for Data Visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
        }

        .glass-panel {
            background: rgba(31, 41, 55, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #111827;
        }

        ::-webkit-scrollbar-thumb {
            background: #374151;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #4b5563;
        }
    </style>
</head>

<body class="bg-gray-950 text-gray-100 min-h-screen selection:bg-neon-blue selection:text-black" x-data="gamePlayApp()"
    x-init="initApp()">

    <!-- Navbar -->
    <nav class="sticky top-0 z-50 glass-panel border-b border-gray-800">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <!-- Logo -->
                <div class="flex items-center gap-2 sm:gap-3">
                    <div
                        class="w-8 h-8 rounded bg-gradient-to-br from-neon-blue to-neon-purple flex items-center justify-center font-bold text-black text-xs">
                        GP</div>
                    <span
                        class="font-bold text-lg sm:text-xl tracking-tight bg-clip-text text-transparent bg-gradient-to-r from-neon-blue to-neon-purple">GamePlay</span>
                    <span
                        class="hidden sm:inline ml-1 px-2 py-0.5 rounded-full bg-yellow-500/10 text-yellow-400 text-[10px] tracking-widest font-bold border border-yellow-500/30 uppercase">Premium</span>
                    <!-- Sync Status Indicator -->
                    <span class="flex items-center gap-1 text-xs"
                        :title="syncStatus === 'synced' ? 'Sincronizado con Firebase' : syncStatus === 'syncing' ? 'Guardando...' : 'Error de sincronizaci√≥n'">
                        <span x-show="syncStatus === 'synced'" class="text-green-400">‚úì</span>
                        <span x-show="syncStatus === 'syncing'" class="text-yellow-400 animate-pulse">‚ü≥</span>
                        <span x-show="syncStatus === 'error'" class="text-red-400">‚úó</span>
                    </span>
                </div>

                <!-- Desktop Navigation -->
                <div class="hidden lg:flex space-x-3 xl:space-x-4">
                    <button @click="currentTab = 'dashboard'" :class="{'text-neon-blue': currentTab === 'dashboard'}"
                        class="hover:text-white transition-colors text-sm font-medium px-2 py-1">Dashboard</button>
                    <button @click="currentTab = 'parser'" :class="{'text-neon-green': currentTab === 'parser'}"
                        class="hover:text-white transition-colors text-sm font-medium px-2 py-1">Parser</button>
                    <button @click="currentTab = 'stats'" :class="{'text-neon-pink': currentTab === 'stats'}"
                        class="hover:text-white transition-colors text-sm font-medium px-2 py-1">Stats</button>
                    <button @click="currentTab = 'clauses'" :class="{'text-neon-purple': currentTab === 'clauses'}"
                        class="hover:text-white transition-colors text-sm font-medium px-2 py-1">Cl√°usulas</button>
                    <button @click="currentTab = 'market'" :class="{'text-cyan-400': currentTab === 'market'}"
                        class="hover:text-white transition-colors text-sm font-medium px-2 py-1 flex items-center gap-1">
                        <span>üìà</span> Mercado
                    </button>
                    <button @click="currentTab = 'movements'" :class="{'text-orange-400': currentTab === 'movements'}"
                        class="hover:text-white transition-colors text-sm font-medium px-2 py-1 flex items-center gap-1">
                        <span>üìã</span> Historial
                    </button>
                    <button @click="currentTab = 'advanced'" :class="{'text-yellow-400': currentTab === 'advanced'}"
                        class="hover:text-white transition-colors text-sm font-medium px-2 py-1 flex items-center gap-1">
                        <span>üöÄ</span> M√©tricas
                    </button>
                </div>

                <!-- Mobile Menu Button -->
                <button @click="mobileMenuOpen = !mobileMenuOpen"
                    class="lg:hidden p-2 rounded-lg hover:bg-gray-800 transition-colors">
                    <svg x-show="!mobileMenuOpen" class="w-6 h-6 text-gray-300" fill="none" stroke="currentColor"
                        viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 6h16M4 12h16M4 18h16" />
                    </svg>
                    <svg x-show="mobileMenuOpen" x-cloak class="w-6 h-6 text-gray-300" fill="none" stroke="currentColor"
                        viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
        </div>

        <!-- Mobile Menu Dropdown -->
        <div x-show="mobileMenuOpen" x-cloak x-transition:enter="transition ease-out duration-200"
            x-transition:enter-start="opacity-0 -translate-y-2" x-transition:enter-end="opacity-100 translate-y-0"
            x-transition:leave="transition ease-in duration-150" x-transition:leave-start="opacity-100 translate-y-0"
            x-transition:leave-end="opacity-0 -translate-y-2"
            class="lg:hidden border-t border-gray-800 bg-gray-900/95 backdrop-blur-xl">
            <div class="grid grid-cols-2 gap-1 p-3">
                <button @click="currentTab = 'dashboard'; mobileMenuOpen = false"
                    :class="currentTab === 'dashboard' ? 'bg-neon-blue/20 text-neon-blue border-neon-blue' : 'bg-gray-800/50 text-gray-300 border-transparent'"
                    class="p-3 rounded-xl text-sm font-medium border transition-all flex items-center justify-center gap-2">
                    üìä Dashboard
                </button>
                <button @click="currentTab = 'parser'; mobileMenuOpen = false"
                    :class="currentTab === 'parser' ? 'bg-neon-green/20 text-neon-green border-neon-green' : 'bg-gray-800/50 text-gray-300 border-transparent'"
                    class="p-3 rounded-xl text-sm font-medium border transition-all flex items-center justify-center gap-2">
                    ‚ú® Parser
                </button>
                <button @click="currentTab = 'stats'; mobileMenuOpen = false"
                    :class="currentTab === 'stats' ? 'bg-neon-pink/20 text-neon-pink border-neon-pink' : 'bg-gray-800/50 text-gray-300 border-transparent'"
                    class="p-3 rounded-xl text-sm font-medium border transition-all flex items-center justify-center gap-2">
                    üìà Stats
                </button>
                <button @click="currentTab = 'clauses'; mobileMenuOpen = false"
                    :class="currentTab === 'clauses' ? 'bg-neon-purple/20 text-neon-purple border-neon-purple' : 'bg-gray-800/50 text-gray-300 border-transparent'"
                    class="p-3 rounded-xl text-sm font-medium border transition-all flex items-center justify-center gap-2">
                    ‚öñÔ∏è Cl√°usulas
                </button>
                <button @click="currentTab = 'market'; mobileMenuOpen = false"
                    :class="currentTab === 'market' ? 'bg-cyan-400/20 text-cyan-400 border-cyan-400' : 'bg-gray-800/50 text-gray-300 border-transparent'"
                    class="p-3 rounded-xl text-sm font-medium border transition-all flex items-center justify-center gap-2">
                    üìà Mercado
                </button>
                <button @click="currentTab = 'movements'; mobileMenuOpen = false"
                    :class="currentTab === 'movements' ? 'bg-orange-400/20 text-orange-400 border-orange-400' : 'bg-gray-800/50 text-gray-300 border-transparent'"
                    class="p-3 rounded-xl text-sm font-medium border transition-all flex items-center justify-center gap-2">
                    üìã Historial
                </button>
                <button @click="currentTab = 'advanced'; mobileMenuOpen = false"
                    :class="currentTab === 'advanced' ? 'bg-yellow-400/20 text-yellow-400 border-yellow-400' : 'bg-gray-800/50 text-gray-300 border-transparent'"
                    class="col-span-2 p-3 rounded-xl text-sm font-medium border transition-all flex items-center justify-center gap-2">
                    üöÄ M√©tricas Avanzadas
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

        <!-- DASHBOARD VIEW -->
        <div x-show="currentTab === 'dashboard'" x-transition.opacity>
            <!-- Header Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <!-- Total Mercado -->
                <div class="glass-panel rounded-xl p-6 relative overflow-hidden group">
                    <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                        <svg class="w-16 h-16 text-neon-blue" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                            </path>
                        </svg>
                    </div>
                    <p class="text-sm text-gray-400 font-medium">Dinero en Juego (Total Saldos)</p>
                    <h3 class="text-2xl font-bold mt-2 text-neon-blue" x-text="formatMoney(calculateTotalBalance())">
                    </h3>
                </div>

                <!-- Total Valor Equipos -->
                <div class="glass-panel rounded-xl p-6 relative overflow-hidden group">
                    <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                        <svg class="w-16 h-16 text-neon-green" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z">
                            </path>
                        </svg>
                    </div>
                    <p class="text-sm text-gray-400 font-medium">Valor Total Plantillas</p>
                    <h3 class="text-2xl font-bold mt-2 text-neon-green" x-text="formatMoney(calculateTotalTeamValue())">
                    </h3>
                </div>

                <!-- Movimientos Registrados -->
                <div class="glass-panel rounded-xl p-6 relative overflow-hidden group">
                    <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                        <svg class="w-16 h-16 text-neon-pink" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path>
                        </svg>
                    </div>
                    <p class="text-sm text-gray-400 font-medium">Movimientos Procesados</p>
                    <h3 class="text-2xl font-bold mt-2 text-neon-pink" x-text="getTotalMovements()"></h3>
                </div>

                <!-- Gasto en Cl√°usulas -->
                <div class="glass-panel rounded-xl p-6 relative overflow-hidden group">
                    <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                        <svg class="w-16 h-16 text-neon-purple" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z">
                            </path>
                        </svg>
                    </div>
                    <p class="text-sm text-gray-400 font-medium">Gasto Total Cl√°usulas</p>
                    <h3 class="text-2xl font-bold mt-2 text-neon-purple" x-text="formatMoney(calculateTotalClauses())">
                    </h3>
                </div>
            </div>

            <!-- Main Table -->
            <div class="glass-panel rounded-xl overflow-hidden shadow-2xl">
                <div class="px-6 py-4 border-b border-gray-700 bg-gray-900/50 flex justify-between items-center">
                    <h2 class="text-lg font-bold text-white">Clasificaci√≥n Financiera</h2>
                    <span class="text-xs text-gray-500 flex items-center gap-1">
                        <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                        En vivo
                    </span>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead>
                            <tr class="text-gray-400 text-xs uppercase bg-gray-900/30">
                                <th class="px-6 py-3 font-semibold">Manager</th>
                                <th class="px-6 py-3 font-semibold text-right">Saldo Caja</th>
                                <th class="px-6 py-3 font-semibold text-right">Valor Equipo</th>
                                <th class="px-6 py-3 font-semibold text-right">Patrimonio</th>
                                <th class="px-6 py-3 font-semibold text-right text-neon-blue">Puja M√°xima</th>
                                <th class="px-6 py-3 font-semibold text-right text-red-400">Gasto Cl√°usulas</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-800">
                            <template x-for="m in sortedManagers" :key="m.name">
                                <tr class="hover:bg-white/5 transition-colors group">
                                    <td class="px-6 py-4">
                                        <div class="flex items-center gap-3">
                                            <div class="w-8 h-8 rounded bg-gray-800 flex items-center justify-center font-bold text-gray-300 border border-gray-700"
                                                x-text="m.name.substring(0,2).toUpperCase()"></div>
                                            <span
                                                class="font-medium text-white group-hover:text-neon-blue transition-colors"
                                                x-text="m.name"></span>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 text-right font-mono text-gray-300"
                                        x-text="formatMoney(m.balance)"></td>
                                    <td class="px-6 py-4 text-right font-mono text-gray-300"
                                        x-text="formatMoney(m.teamValue)"></td>
                                    <td class="px-6 py-4 text-right font-mono font-bold text-white"
                                        x-text="formatMoney(m.balance + m.teamValue)"></td>
                                    <td class="px-6 py-4 text-right font-mono font-bold text-neon-blue"
                                        x-text="formatMoney(calculateMaxBid(m))"></td>
                                    <td class="px-6 py-4 text-right font-mono text-red-400"
                                        x-text="formatMoney(m.clauseExpenses)"></td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- CHARTS SECTION -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-8">
                <!-- Patrimony Comparison Chart -->
                <div class="glass-panel rounded-xl p-6">
                    <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
                        üìä Comparativa de Patrimonio
                    </h3>
                    <div class="h-64">
                        <canvas id="patrimonyChart"></canvas>
                    </div>
                </div>

                <!-- Trading Activity by Day -->
                <div class="glass-panel rounded-xl p-6">
                    <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
                        üìà Actividad de Fichajes
                    </h3>
                    <div class="h-64">
                        <canvas id="activityChart"></canvas>
                    </div>
                </div>
            </div>

        </div>

        <!-- MAGIC PARSER VIEW -->
        <div x-show="currentTab === 'parser'" x-transition.opacity>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Input Area -->
                <div class="lg:col-span-2 space-y-6">
                    <div class="glass-panel rounded-xl p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold text-white flex items-center gap-2">
                                <svg class="w-5 h-5 text-neon-green" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />
                                </svg>
                                Magic Parser
                            </h2>
                            <div class="flex gap-2">
                                <!-- Bot√≥n Importar Archivo -->
                                <label
                                    class="px-4 py-2 bg-neon-blue/10 hover:bg-neon-blue/20 text-neon-blue border border-neon-blue/50 rounded-lg text-sm font-bold transition-all hover:scale-105 active:scale-95 flex items-center gap-2 cursor-pointer">
                                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                                    </svg>
                                    Importar .txt
                                    <input type="file" accept=".txt" @change="importFromFile($event)" class="hidden" />
                                </label>
                                <!-- Bot√≥n Procesar Texto -->
                                <button @click="processInput()"
                                    class="px-4 py-2 bg-neon-green/10 hover:bg-neon-green/20 text-neon-green border border-neon-green/50 rounded-lg text-sm font-bold transition-all hover:scale-105 active:scale-95 flex items-center gap-2">
                                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                    Procesar Datos
                                </button>
                            </div>
                        </div>
                        <p class="text-sm text-gray-400 mb-2">Copia y pega texto directamente desde la app de Fantasy
                            (Movimientos de mercado, valores de equipo, premios).</p>
                        <textarea x-model="rawInput"
                            class="w-full h-96 bg-gray-900/50 border border-gray-700 rounded-lg p-4 font-mono text-sm text-gray-300 focus:ring-2 focus:ring-neon-blue focus:border-transparent outline-none resize-none"
                            placeholder="Paste your raw data here..."></textarea>
                    </div>

                    <!-- PREVIEW AREA -->
                    <div x-show="pendingMovements.length > 0" x-transition
                        class="glass-panel rounded-xl p-6 border border-neon-blue/30">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold text-white">Vista Previa (<span
                                    x-text="pendingMovements.length"></span> √≠tems)</h3>
                            <div class="flex gap-3">
                                <button @click="cancelImport()"
                                    class="px-4 py-2 bg-red-500/10 hover:bg-red-500/20 text-red-400 border border-red-500/50 rounded-lg text-sm font-bold transition-all">Cancelar</button>
                                <button @click="confirmImport()"
                                    class="px-4 py-2 bg-neon-blue hover:bg-neon-blue/80 text-black border border-transparent rounded-lg text-sm font-bold transition-all shadow-[0_0_15px_rgba(0,243,255,0.3)] animate-pulse">Confirmar
                                    Importaci√≥n</button>
                            </div>
                        </div>
                        <div class="overflow-x-auto max-h-96 rounded-lg border border-gray-700">
                            <table class="w-full text-left text-sm">
                                <thead class="bg-gray-800 text-gray-400 text-xs uppercase sticky top-0">
                                    <tr>
                                        <th class="p-3">Fecha</th>
                                        <th class="p-3">Tipo</th>
                                        <th class="p-3">Detalle</th>
                                        <th class="p-3 text-right">Cantidad</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-700 bg-gray-900/50">
                                    <template x-for="pm in pendingMovements" :key="pm.id">
                                        <tr>
                                            <td class="p-3 font-mono text-xs text-gray-500" x-text="pm.date"></td>
                                            <td class="p-3">
                                                <span class="px-2 py-0.5 rounded text-xs font-bold"
                                                    :class="pm.type === 'transfer' ? 'bg-blue-900/50 text-blue-300' : 'bg-yellow-900/50 text-yellow-300'"
                                                    x-text="pm.type.toUpperCase()"></span>
                                            </td>
                                            <td class="p-3 text-gray-300">
                                                <div x-show="pm.type === 'transfer'">
                                                    <span x-text="pm.player" class="font-bold text-white"></span>
                                                    <span class="text-xs text-gray-500 block">
                                                        <span x-text="pm.seller"></span> ‚ûú <span
                                                            x-text="pm.buyer"></span>
                                                    </span>
                                                </div>
                                                <div x-show="pm.type === 'reward'">
                                                    <span x-text="pm.beneficiary" class="font-bold"></span>
                                                    <span class="text-xs text-gray-500 block"
                                                        x-text="pm.subtype"></span>
                                                </div>
                                            </td>
                                            <td class="p-3 text-right font-mono"
                                                :class="pm.type === 'transfer' ? 'text-neon-green' : 'text-neon-purple'"
                                                x-text="formatMoney(pm.amount)"></td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Log / Guide Area -->
                <div class="space-y-6">
                    <div class="glass-panel rounded-xl p-6">
                        <h3 class="text-md font-bold text-white mb-4">Registro de Procesamiento</h3>
                        <div class="h-64 overflow-y-auto space-y-2 pr-2 font-mono text-xs">
                            <template x-for="log in logs" :key="log.id">
                                <div class="p-2 rounded bg-black/20 border-l-2"
                                    :class="log.type === 'success' ? 'border-green-500 text-green-400' : (log.type === 'info' ? 'border-blue-500 text-blue-300' : 'border-yellow-500 text-yellow-300')">
                                    <span class="opacity-50" x-text="log.time"></span>
                                    <span x-text="log.msg"></span>
                                </div>
                            </template>
                            <div x-show="logs.length === 0" class="text-gray-600 text-center italic mt-10">Esperando
                                datos...</div>
                        </div>
                    </div>


                </div>
            </div>
        </div>

        <!-- MOVEMENTS VIEW -->
        <div x-show="currentTab === 'movements'" x-transition.opacity>
            <!-- Filters -->
            <div
                class="glass-panel p-4 rounded-xl mb-6 flex flex-wrap gap-4 items-center sticky top-20 z-40 backdrop-blur-md bg-gray-900/80 border border-neon-blue/20">
                <div class="flex-grow relative">
                    <svg class="w-5 h-5 absolute left-3 top-2.5 text-gray-500" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                    <input type="text" x-model="filters.search" placeholder="Buscar jugador, equipo..."
                        class="w-full bg-gray-900 border border-gray-700 rounded-lg pl-10 pr-4 py-2 text-white focus:ring-1 focus:ring-neon-blue outline-none">
                </div>

                <select x-model="filters.team"
                    class="bg-gray-900 border border-gray-700 rounded-lg px-4 py-2 text-white outline-none">
                    <option value="all">Todos los Equipos</option>
                    <template x-for="m in Object.keys(managers)" :key="m">
                        <option :value="m" x-text="m"></option>
                    </template>
                </select>

                <select x-model="filters.type"
                    class="bg-gray-900 border border-gray-700 rounded-lg px-4 py-2 text-white outline-none">
                    <option value="all">Todos los Tipos</option>
                    <option value="transfer">Transferencias</option>
                    <option value="reward">Premios</option>
                    <option value="shield">Blindajes</option>
                </select>

                <div class="text-xs text-gray-400 font-mono">
                    <span x-text="filteredMovements.length"></span> resultados
                </div>
            </div>

            <!-- Table -->
            <div class="glass-panel rounded-xl overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-gray-800 text-gray-400 text-xs uppercase">
                            <tr>
                                <th class="p-3">Fecha</th>
                                <th class="p-3">Tipo</th>
                                <th class="p-3">Detalle</th>
                                <th class="p-3 text-right">Importe</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-700 bg-gray-900/50">
                            <template x-for="(mov, index) in filteredMovements" :key="mov.id || index">
                                <tr class="hover:bg-white/5 transition-colors">
                                    <td class="p-3 font-mono text-xs text-gray-500" x-text="mov.date"></td>
                                    <td class="p-3">
                                        <span class="px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider"
                                            :class="{
                                                 'bg-blue-900/50 text-blue-300': mov.type === 'transfer',
                                                 'bg-yellow-900/50 text-yellow-300': mov.type === 'reward',
                                                 'bg-purple-900/50 text-purple-300': mov.type === 'shield'
                                             }" x-text="mov.type"></span>
                                    </td>
                                    <td class="p-3">
                                        <div x-show="mov.type === 'transfer'">
                                            <div class="font-bold text-white flex items-center gap-2">
                                                <span x-text="mov.player"></span>
                                            </div>
                                            <div class="text-xs text-gray-500 mt-1">
                                                <span x-text="mov.seller" class="font-medium"
                                                    :class="mov.seller === filters.team ? 'text-neon-blue' : ''"></span>
                                                <span class="mx-1">‚ûú</span>
                                                <span x-text="mov.buyer" class="font-medium"
                                                    :class="mov.buyer === filters.team ? 'text-neon-green' : ''"></span>
                                            </div>
                                        </div>
                                        <div x-show="mov.type !== 'transfer'">
                                            <span x-text="mov.details || mov.subtype || mov.type"
                                                class="text-white"></span>
                                            <span x-show="mov.beneficiary" x-text="'PARA: ' + mov.beneficiary"
                                                class="text-xs text-gray-500 block mt-1"></span>
                                        </div>
                                    </td>
                                    <td class="p-3 text-right font-mono"
                                        :class="mov.amount > 0 ? 'text-green-400' : 'text-gray-500'"
                                        x-text="formatMoney(mov.amount)"></td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                    <div x-show="filteredMovements.length === 0"
                        class="p-12 text-center text-gray-500 flex flex-col items-center">
                        <svg class="w-12 h-12 mb-4 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                        <p>No se encontraron movimientos con estos filtros.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- CLAUSES VIEW -->
        <div x-show="currentTab === 'clauses'" x-transition.opacity>
            <div class="max-w-3xl mx-auto glass-panel rounded-xl p-8">
                <h2 class="text-2xl font-bold text-white mb-6 text-neon-purple flex items-center gap-2">
                    <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    Gesti√≥n de Cl√°usulas
                </h2>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <!-- Manual Input -->
                    <div>
                        <label class="block text-sm font-medium text-gray-400 mb-2">Manager</label>
                        <select x-model="clauseForm.manager"
                            class="w-full bg-gray-900 border border-gray-700 rounded-lg p-3 text-white focus:ring-1 focus:ring-neon-purple outline-none">
                            <option value="">Selecciona un equipo</option>
                            <template x-for="m in sortedManagers" :key="m.name">
                                <option :value="m.name" x-text="m.name"></option>
                            </template>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-400 mb-2">Importe Gastado (‚Ç¨)</label>
                        <input type="number" x-model="clauseForm.amount"
                            class="w-full bg-gray-900 border border-gray-700 rounded-lg p-3 text-white focus:ring-1 focus:ring-neon-purple outline-none"
                            placeholder="Ej: 5000000">
                    </div>
                </div>
                <button @click="addClauseExpense()"
                    class="w-full py-3 bg-neon-purple/20 hover:bg-neon-purple/30 text-neon-purple border border-neon-purple/50 rounded-lg font-bold transition-all">
                    Registrar Gasto de Cl√°usula
                </button>

                <!-- Bulk Import -->
                <div class="mt-8 pt-8 border-t border-gray-800">
                    <h3 class="text-lg font-semibold text-white mb-4">Importar CSV (Equipo [TAB] Importe)</h3>
                    <textarea x-model="clauseBulkInput"
                        class="w-full h-32 bg-gray-900/50 border border-gray-700 rounded-lg p-4 font-mono text-xs text-gray-400"
                        placeholder="Alcatamy eSports By	168.850.000 ‚Ç¨..."></textarea>
                    <button @click="processClauseBulk()"
                        class="mt-3 px-4 py-2 text-xs bg-gray-800 hover:bg-gray-700 text-white rounded border border-gray-600">Importar
                        Lote</button>
                </div>
            </div>
        </div>

        <!-- STATS VIEW -->
        <div x-show="currentTab === 'stats'" x-transition.opacity>

            <h3 class="text-white font-bold mb-6 text-2xl flex items-center gap-2">
                <svg class="w-6 h-6 text-neon-pink" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                </svg>
                Anal√≠tica de Mercado (30 KPIs)
            </h3>

            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-6 gap-4 mb-8">
                <template x-for="stat in advancedStats">
                    <div
                        class="p-4 rounded-xl bg-gray-900/40 border border-gray-800 hover:border-neon-blue/30 transition-all group">
                        <p class="text-[10px] text-gray-500 uppercase tracking-wider group-hover:text-neon-blue transition-colors"
                            x-text="stat.label"></p>
                        <p class="text-lg font-bold font-mono mt-1" :class="stat.c" x-text="stat.val"></p>
                        <p x-show="stat.sub" class="text-xs text-gray-400 mt-1 truncate font-medium" x-text="stat.sub">
                        </p>
                    </div>
                </template>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                <div class="glass-panel p-6 rounded-xl">
                    <h3 class="text-white font-bold mb-4">Patrimonio vs Tiempo</h3>
                    <canvas id="patrimonyChart" height="200"></canvas>
                </div>
                <div class="glass-panel p-6 rounded-xl">
                    <h3 class="text-white font-bold mb-4">Ingresos por Premios</h3>
                    <canvas id="rewardsChart" height="200"></canvas>
                </div>
            </div>

            <div class="glass-panel p-6 rounded-xl">
                <h3 class="text-white font-bold mb-6 text-lg">Top 10 Fichajes M√°s Caros</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm">
                        <thead class="text-xs uppercase text-gray-500 bg-gray-900/20">
                            <tr>
                                <th class="p-3">Jugador</th>
                                <th class="p-3">Comprador</th>
                                <th class="p-3">Vendedor</th>
                                <th class="p-3 text-right">Precio</th>
                                <th class="p-3 text-right">Fecha</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-800">
                            <template x-for="mov in getTopTransfers()" :key="mov.id">
                                <tr class="hover:bg-white/5">
                                    <td class="p-3 text-white font-medium" x-text="mov.player"></td>
                                    <td class="p-3 text-blue-300" x-text="mov.buyer"></td>
                                    <td class="p-3 text-red-300" x-text="mov.seller"></td>
                                    <td class="p-3 text-right font-mono text-neon-green"
                                        x-text="formatMoney(mov.amount)"></td>
                                    <td class="p-3 text-right text-gray-500 text-xs" x-text="mov.date"></td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ADVANCED METRICS VIEW -->
        <div x-show="currentTab === 'advanced'" x-transition.opacity class="space-y-8">
            <h2 class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-neon-pink to-yellow-400">
                üìä M√©tricas de Mercado & ROI</h2>

            <!-- Manager Analysis -->
            <div class="glass-panel p-6 rounded-xl">
                <h3 class="text-lg font-bold mb-4 text-white">Rendimiento por Manager</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-gray-400">
                        <thead class="text-xs uppercase bg-gray-800 text-neon-blue">
                            <tr>
                                <th class="px-4 py-3">Manager</th>
                                <th class="px-4 py-3 text-right">Inversi√≥n Total</th>
                                <th class="px-4 py-3 text-right">Ventas Totales</th>
                                <th class="px-4 py-3 text-right">Beneficio Cerrado</th>
                                <th class="px-4 py-3 text-right">Valor Plantilla Actual</th>
                                <th class="px-4 py-3 text-right">Beneficio Latente</th>
                                <th class="px-4 py-3 text-right">ROI (Realizado + Latente)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="stat in marketValuation" :key="stat.name">
                                <tr class="border-b border-gray-800 hover:bg-gray-800/50">
                                    <td class="px-4 py-3 font-medium text-white" x-text="stat.name"></td>
                                    <td class="px-4 py-3 text-right"
                                        x-text="formatMoney(tradingHistory.managerStats[stat.name]?.buys || 0)"></td>
                                    <td class="px-4 py-3 text-right"
                                        x-text="formatMoney(tradingHistory.managerStats[stat.name]?.sales || 0)"></td>
                                    <td class="px-4 py-3 text-right"
                                        :class="(tradingHistory.managerStats[stat.name]?.profit || 0) > 0 ? 'text-green-400' : 'text-red-400'"
                                        x-text="formatMoney(tradingHistory.managerStats[stat.name]?.profit || 0)"></td>
                                    <td class="px-4 py-3 text-right text-yellow-300"
                                        x-text="formatMoney(stat.marketValue)"></td>
                                    <td class="px-4 py-3 text-right"
                                        :class="stat.unrealizedProfit > 0 ? 'text-green-400' : 'text-red-400'"
                                        x-text="formatMoney(stat.unrealizedProfit)"></td>
                                    <td class="px-4 py-3 text-right font-bold">
                                        <span
                                            x-text="((((tradingHistory.managerStats[stat.name]?.profit || 0) + stat.unrealizedProfit) / ((tradingHistory.managerStats[stat.name]?.buys || 1) + 1)) * 100).toFixed(1) + '%'"></span>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Top Deals Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Best Deals -->
                <div class="glass-panel p-6 rounded-xl">
                    <h3 class="text-lg font-bold mb-4 text-green-400">üî• Top 10 Mejores Negocios (Cerrados)</h3>
                    <div class="space-y-3">
                        <template x-for="(deal, idx) in bestDeals.slice(0, 10)" :key="idx">
                            <div
                                class="flex justify-between items-center p-2 bg-gray-800/30 rounded border border-gray-700/50">
                                <div>
                                    <div class="font-bold text-white" x-text="deal.player"></div>
                                    <div class="text-xs text-gray-500" x-text="deal.manager + ' ‚Ä¢ ' + deal.date"></div>
                                </div>
                                <div class="text-right">
                                    <div class="text-green-400 font-bold" x-text="'+' + formatMoney(deal.profit)"></div>
                                    <div class="text-xs text-gray-400" x-text="'ROI: ' + deal.roi.toFixed(1) + '%'">
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Worst Deals -->
                <div class="glass-panel p-6 rounded-xl">
                    <h3 class="text-lg font-bold mb-4 text-red-400">üìâ Top 10 Peores Negocios (Cerrados)</h3>
                    <div class="space-y-3">
                        <template x-for="(deal, idx) in worstDeals.slice(0, 10)" :key="idx">
                            <div
                                class="flex justify-between items-center p-2 bg-gray-800/30 rounded border border-gray-700/50">
                                <div>
                                    <div class="font-bold text-white" x-text="deal.player"></div>
                                    <div class="text-xs text-gray-500" x-text="deal.manager + ' ‚Ä¢ ' + deal.date"></div>
                                </div>
                                <div class="text-right">
                                    <div class="text-red-400 font-bold" x-text="formatMoney(deal.profit)"></div>
                                    <div class="text-xs text-gray-400" x-text="'Compra: ' + formatMoney(deal.buyPrice)">
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>

            <!-- Most Expensive Lists -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Top Sales -->
                <div class="glass-panel p-6 rounded-xl">
                    <h3 class="text-lg font-bold mb-4 text-neon-blue">üí∞ Top 15 Ventas M√°s Caras</h3>
                    <div class="max-h-96 overflow-y-auto pr-2">
                        <ul class="space-y-2">
                            <template x-for="(mov, idx) in topSales.slice(0, 15)" :key="idx">
                                <li class="flex justify-between text-sm border-b border-gray-800 pb-1">
                                    <span class="text-gray-300"><span x-text="idx+1"></span>. <span x-text="mov.player"
                                            class="font-bold text-white"></span> <span class="text-xs text-gray-500"
                                            x-text="'(' + mov.seller + ')'"></span></span>
                                    <span class="text-neon-blue font-mono" x-text="formatMoney(mov.amount)"></span>
                                </li>
                            </template>
                        </ul>
                    </div>
                </div>
                <!-- Top Compras -->
                <div class="glass-panel p-6 rounded-xl">
                    <h3 class="text-lg font-bold mb-4 text-neon-pink">üíé Top 15 Compras M√°s Caras</h3>
                    <div class="max-h-96 overflow-y-auto pr-2">
                        <ul class="space-y-2">
                            <template x-for="(mov, idx) in topPurchases.slice(0, 15)" :key="idx">
                                <li class="flex justify-between text-sm border-b border-gray-800 pb-1">
                                    <span class="text-gray-300"><span x-text="idx+1"></span>. <span x-text="mov.player"
                                            class="font-bold text-white"></span> <span class="text-xs text-gray-500"
                                            x-text="'(' + mov.buyer + ')'"></span></span>
                                    <span class="text-neon-pink font-mono" x-text="formatMoney(mov.amount)"></span>
                                </li>
                            </template>
                        </ul>
                    </div>
                </div>
            </div>

        </div>

        <!-- =============== ANALYTICS TAB =============== -->
        <div x-show="currentTab === 'advanced'" x-cloak class="space-y-8"
            x-init="$watch('currentTab', val => { if(val === 'advanced') rebuildManagerAnalytics(); })">

            <h2 class="text-2xl font-bold text-yellow-400 flex items-center gap-2">
                üß† Inteligencia de Managers
            </h2>

            <!-- Manager Selector -->
            <div class="glass-panel p-6 rounded-xl">
                <label class="block text-sm font-medium text-gray-400 mb-2">Selecciona un Manager para analizar</label>
                <select x-model="selectedAnalyticsManager"
                    @change="selectedManagerData = getManagerAnalytics(selectedAnalyticsManager)"
                    class="w-full md:w-1/3 bg-gray-900 border border-gray-700 rounded-lg p-3 text-white focus:ring-1 focus:ring-yellow-500 outline-none">
                    <option value="">-- Todos los Managers --</option>
                    <template x-for="m in sortedManagers" :key="m.name">
                        <option :value="m.name" x-text="m.name"></option>
                    </template>
                </select>
            </div>

            <!-- Manager Analytics Cards (when one is selected) -->
            <template x-if="selectedAnalyticsManager">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <!-- Overbid Index -->
                    <div class="glass-panel p-6 rounded-xl border-l-4 border-yellow-500">
                        <p class="text-xs text-gray-400 uppercase tracking-wider">üìä Overbid Index</p>
                        <h3 class="text-3xl font-bold mt-2"
                            :class="getManagerAnalytics(selectedAnalyticsManager).avgSpread > 10 ? 'text-red-400' : getManagerAnalytics(selectedAnalyticsManager).avgSpread > 5 ? 'text-yellow-400' : 'text-green-400'">
                            <span
                                x-text="(getManagerAnalytics(selectedAnalyticsManager).avgSpread >= 0 ? '+' : '') + getManagerAnalytics(selectedAnalyticsManager).avgSpread.toFixed(1) + '%'"></span>
                        </h3>
                        <p class="text-xs text-gray-500 mt-1">Promedio de sobrepuja</p>
                    </div>

                    <!-- Dominant Pattern -->
                    <div class="glass-panel p-6 rounded-xl border-l-4 border-purple-500">
                        <p class="text-xs text-gray-400 uppercase tracking-wider">üéØ Patr√≥n de Puja</p>
                        <h3 class="text-xl font-bold mt-2 text-purple-400">
                            <span
                                x-text="{ 'plusOne': 'Puja +1‚Ç¨', 'roundMillion': 'Millones redondos', 'roundHundredK': 'Cien miles', 'roundTenK': 'Diez miles', 'custom': 'Personalizado', 'repeating': 'N√∫meros repetidos' }[getManagerAnalytics(selectedAnalyticsManager).dominantPattern] || 'Sin datos'"></span>
                        </h3>
                        <p class="text-xs text-gray-500 mt-1">
                            <span
                                x-text="getManagerAnalytics(selectedAnalyticsManager).dominantPatternPct?.toFixed(0) + '% de sus pujas'"></span>
                        </p>
                    </div>

                    <!-- Squad Size -->
                    <div class="glass-panel p-6 rounded-xl border-l-4 border-blue-500">
                        <p class="text-xs text-gray-400 uppercase tracking-wider">üë• Plantilla</p>
                        <h3 class="text-3xl font-bold mt-2 text-blue-400">
                            <span x-text="getManagerAnalytics(selectedAnalyticsManager).squadSize || 0"></span>
                            <span class="text-sm text-gray-500">jugadores</span>
                        </h3>
                    </div>

                    <!-- Total Purchases -->
                    <div class="glass-panel p-6 rounded-xl border-l-4 border-green-500">
                        <p class="text-xs text-gray-400 uppercase tracking-wider">üõí Operaciones</p>
                        <h3 class="text-3xl font-bold mt-2 text-green-400">
                            <span x-text="getManagerAnalytics(selectedAnalyticsManager).purchases?.length || 0"></span>
                            <span class="text-sm text-gray-500">fichajes</span>
                        </h3>
                    </div>
                </div>
            </template>

            <!-- Spread by Position (when manager selected) -->
            <template x-if="selectedAnalyticsManager">
                <div class="glass-panel p-6 rounded-xl">
                    <h3 class="text-lg font-bold mb-4 text-yellow-400">üìà Spread por Posici√≥n</h3>
                    <p class="text-xs text-gray-400 mb-4">Cu√°nto sobrepuja este manager seg√∫n la posici√≥n del jugador
                    </p>
                    <div class="grid grid-cols-4 gap-4">
                        <template x-for="pos in ['PT', 'DF', 'MD', 'DL']" :key="pos">
                            <div class="text-center p-4 bg-gray-900/50 rounded-lg">
                                <div class="text-2xl mb-2" x-text="{'PT':'üß§','DF':'üõ°Ô∏è','MD':'‚ö°','DL':'‚öΩ'}[pos]"></div>
                                <div class="font-bold text-lg"
                                    :class="getManagerAnalytics(selectedAnalyticsManager).spreadByPosition[pos] > 15 ? 'text-red-400' : getManagerAnalytics(selectedAnalyticsManager).spreadByPosition[pos] > 5 ? 'text-yellow-400' : 'text-green-400'"
                                    x-text="(getManagerAnalytics(selectedAnalyticsManager).spreadByPosition[pos] >= 0 ? '+' : '') + (getManagerAnalytics(selectedAnalyticsManager).spreadByPosition[pos] || 0).toFixed(1) + '%'">
                                </div>
                                <div class="text-xs text-gray-500 mt-1" x-text="pos"></div>
                            </div>
                        </template>
                    </div>
                    <div class="mt-4 p-3 bg-gray-800/50 rounded-lg border border-gray-700">
                        <p class="text-sm text-gray-300">
                            üí° <strong>Estrategia vs <span x-text="selectedAnalyticsManager"></span>:</strong>
                            <span x-text="(() => {
                                const data = getManagerAnalytics(selectedAnalyticsManager);
                                const maxPos = Object.entries(data.spreadByPosition).sort((a,b) => b[1] - a[1])[0];
                                const minPos = Object.entries(data.spreadByPosition).filter(e => e[1] !== 0).sort((a,b) => a[1] - b[1])[0];
                                if (!maxPos || !minPos) return 'Sin datos suficientes';
                                return `Sobrepuja agresivamente en ${maxPos[0]} (+${maxPos[1].toFixed(1)}%), pero es taca√±o en ${minPos[0]} (+${minPos[1].toFixed(1)}%)`;
                            })()"></span>
                        </p>
                    </div>
                </div>
            </template>

            <!-- NEED MAP - All Managers -->
            <div class="glass-panel p-6 rounded-xl">
                <h3 class="text-lg font-bold mb-4 text-orange-400">üó∫Ô∏è Mapa de Necesidades</h3>
                <p class="text-xs text-gray-400 mb-4">D√©ficit de cada manager por posici√≥n (100% = necesita
                    urgentemente)</p>
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead>
                            <tr class="text-gray-400 text-xs uppercase bg-gray-900/30">
                                <th class="px-4 py-3 font-semibold">Manager</th>
                                <th class="px-4 py-3 font-semibold text-center">üß§ PT</th>
                                <th class="px-4 py-3 font-semibold text-center">üõ°Ô∏è DF</th>
                                <th class="px-4 py-3 font-semibold text-center">‚ö° MD</th>
                                <th class="px-4 py-3 font-semibold text-center">‚öΩ DL</th>
                                <th class="px-4 py-3 font-semibold text-center">Plantilla</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="m in sortedManagers" :key="m.name">
                                <tr class="border-b border-gray-800 hover:bg-gray-800/50">
                                    <td class="px-4 py-3 font-medium text-white" x-text="m.name"></td>
                                    <template x-for="pos in ['PT', 'DF', 'MD', 'DL']" :key="pos">
                                        <td class="px-4 py-3 text-center">
                                            <span class="inline-block px-2 py-1 rounded text-xs font-bold"
                                                :class="getManagerAnalytics(m.name).needMap[pos] >= 50 ? 'bg-red-500/30 text-red-400' : getManagerAnalytics(m.name).needMap[pos] >= 20 ? 'bg-yellow-500/30 text-yellow-400' : 'bg-green-500/30 text-green-400'"
                                                x-text="getManagerAnalytics(m.name).needMap[pos].toFixed(0) + '%'">
                                            </span>
                                        </td>
                                    </template>
                                    <td class="px-4 py-3 text-center text-gray-400"
                                        x-text="getManagerAnalytics(m.name).squadSize || 0"></td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Overbid Ranking - All Managers -->
            <div class="glass-panel p-6 rounded-xl">
                <h3 class="text-lg font-bold mb-4 text-red-400">üî• Ranking de Sobrepuja</h3>
                <p class="text-xs text-gray-400 mb-4">Qui√©n paga m√°s de m√°s en cada posici√≥n</p>
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead>
                            <tr class="text-gray-400 text-xs uppercase bg-gray-900/30">
                                <th class="px-4 py-3 font-semibold">Manager</th>
                                <th class="px-4 py-3 font-semibold text-right">Spread Medio</th>
                                <th class="px-4 py-3 font-semibold text-center">üß§ PT</th>
                                <th class="px-4 py-3 font-semibold text-center">üõ°Ô∏è DF</th>
                                <th class="px-4 py-3 font-semibold text-center">‚ö° MD</th>
                                <th class="px-4 py-3 font-semibold text-center">‚öΩ DL</th>
                                <th class="px-4 py-3 font-semibold text-center">Patr√≥n</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="m in sortedManagers" :key="m.name + '_spread'">
                                <tr class="border-b border-gray-800 hover:bg-gray-800/50">
                                    <td class="px-4 py-3 font-medium text-white" x-text="m.name"></td>
                                    <td class="px-4 py-3 text-right font-mono"
                                        :class="getManagerAnalytics(m.name).avgSpread > 10 ? 'text-red-400' : getManagerAnalytics(m.name).avgSpread > 5 ? 'text-yellow-400' : 'text-green-400'"
                                        x-text="(getManagerAnalytics(m.name).avgSpread >= 0 ? '+' : '') + getManagerAnalytics(m.name).avgSpread.toFixed(1) + '%'">
                                    </td>
                                    <template x-for="pos in ['PT', 'DF', 'MD', 'DL']" :key="pos + '_cell'">
                                        <td class="px-4 py-3 text-center text-sm"
                                            :class="getManagerAnalytics(m.name).spreadByPosition[pos] > 10 ? 'text-red-400' : getManagerAnalytics(m.name).spreadByPosition[pos] > 5 ? 'text-yellow-400' : 'text-gray-400'"
                                            x-text="(getManagerAnalytics(m.name).spreadByPosition[pos]?.toFixed(1) || '0') + '%'">
                                        </td>
                                    </template>
                                    <td class="px-4 py-3 text-center">
                                        <span class="text-xs px-2 py-1 rounded bg-purple-500/20 text-purple-400"
                                            x-text="{ 'plusOne': '+1‚Ç¨', 'roundMillion': 'M', 'roundHundredK': '100K', 'roundTenK': '10K', 'custom': '?', 'repeating': '555' }[getManagerAnalytics(m.name).dominantPattern] || '?'">
                                        </span>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Market Trends from MARKET_TRENDS -->
            <div class="glass-panel p-6 rounded-xl" x-data="{ trendSearch: '' }">
                <h3 class="text-lg font-bold mb-4 text-green-400">üìä Tendencias de Mercado (Hoy)</h3>
                <p class="text-xs text-gray-400 mb-4">Variaci√≥n de precio respecto al d√≠a anterior (datos de
                    guiafantasy.com)</p>

                <input type="text" x-model="trendSearch" placeholder="Buscar jugador..."
                    class="w-full md:w-1/3 mb-4 bg-gray-900 border border-gray-700 rounded-lg p-2 text-white focus:ring-1 focus:ring-green-500 outline-none">

                <div class="overflow-x-auto max-h-96">
                    <table class="w-full text-left text-sm">
                        <thead class="sticky top-0 bg-gray-900">
                            <tr class="text-gray-400 text-xs uppercase">
                                <th class="px-3 py-2">Jugador</th>
                                <th class="px-3 py-2 text-right">Valor Actual</th>
                                <th class="px-3 py-2 text-right">Variaci√≥n</th>
                                <th class="px-3 py-2 text-right">%</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template
                                x-for="[player, value] in Object.entries(marketData).filter(([p]) => p.toLowerCase().includes(trendSearch.toLowerCase())).slice(0, 50)"
                                :key="player">
                                <tr class="border-b border-gray-800 hover:bg-gray-800/50">
                                    <td class="px-3 py-2 font-medium text-white" x-text="player"></td>
                                    <td class="px-3 py-2 text-right font-mono text-gray-300"
                                        x-text="formatMoney(value)"></td>
                                    <td class="px-3 py-2 text-right font-mono"
                                        :class="(typeof MARKET_TRENDS !== 'undefined' && MARKET_TRENDS[player]?.trend > 0) ? 'text-green-400' : (typeof MARKET_TRENDS !== 'undefined' && MARKET_TRENDS[player]?.trend < 0) ? 'text-red-400' : 'text-gray-500'"
                                        x-text="typeof MARKET_TRENDS !== 'undefined' && MARKET_TRENDS[player] ? formatMoney(MARKET_TRENDS[player].trend) : '-'">
                                    </td>
                                    <td class="px-3 py-2 text-right font-mono"
                                        :class="(typeof MARKET_TRENDS !== 'undefined' && MARKET_TRENDS[player]?.trendPct > 0) ? 'text-green-400' : (typeof MARKET_TRENDS !== 'undefined' && MARKET_TRENDS[player]?.trendPct < 0) ? 'text-red-400' : 'text-gray-500'">
                                        <span x-show="typeof MARKET_TRENDS !== 'undefined' && MARKET_TRENDS[player]"
                                            x-text="(MARKET_TRENDS[player]?.trendPct > 0 ? '‚ñ≤ +' : MARKET_TRENDS[player]?.trendPct < 0 ? '‚ñº ' : '') + (MARKET_TRENDS[player]?.trendPct?.toFixed(2) || '0') + '%'"></span>
                                        <span x-show="typeof MARKET_TRENDS === 'undefined' || !MARKET_TRENDS[player]"
                                            class="text-gray-600">-</span>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>

        </div>

        <!-- =============== MARKET EXPLORER TAB =============== -->
        <div x-show="currentTab === 'market'" x-cloak class="space-y-6">
            <h2 class="text-2xl font-bold text-cyan-400 flex items-center gap-2">
                üìà Explorador de Mercado
                <span class="text-sm font-normal text-gray-400"
                    x-text="'(' + Object.keys(marketData).length + ' jugadores)'"></span>
            </h2>

            <!-- Filters & Sorting -->
            <div class="glass-panel p-4 rounded-xl">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-xs text-gray-400 mb-1">Buscar Jugador</label>
                        <input type="text" x-model="marketExplorer.searchQuery" placeholder="Nombre..."
                            class="w-full bg-gray-900 border border-gray-700 rounded-lg p-2 text-white text-sm">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-400 mb-1">Posici√≥n</label>
                        <select x-model="marketExplorer.positionFilter"
                            class="w-full bg-gray-900 border border-gray-700 rounded-lg p-2 text-white text-sm">
                            <option value="all">Todas</option>
                            <option value="PT">üß§ Portero</option>
                            <option value="DF">üõ°Ô∏è Defensa</option>
                            <option value="MD">‚ö° Mediocampista</option>
                            <option value="DL">‚öΩ Delantero</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs text-gray-400 mb-1">Ordenar por</label>
                        <select x-model="marketExplorer.sortBy"
                            class="w-full bg-gray-900 border border-gray-700 rounded-lg p-2 text-white text-sm">
                            <option value="value">Valor de Mercado</option>
                            <option value="points">Puntos Totales</option>
                            <option value="trend">Cambio Diario (‚Ç¨)</option>
                            <option value="trendPct">Cambio Diario (%)</option>
                            <option value="ppm">Puntos por Mill√≥n</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs text-gray-400 mb-1">Direcci√≥n</label>
                        <select x-model="marketExplorer.sortDir"
                            class="w-full bg-gray-900 border border-gray-700 rounded-lg p-2 text-white text-sm">
                            <option value="desc">‚Üì Mayor a Menor</option>
                            <option value="asc">‚Üë Menor a Mayor</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Market KPIs -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="glass-panel p-4 rounded-xl text-center">
                    <p class="text-xs text-gray-400">üî• Mayor Subida Hoy</p>
                    <p class="font-bold text-green-400 text-sm mt-1" x-text="(() => {
                        if (typeof MARKET_TRENDS === 'undefined') return '-';
                        const sorted = Object.entries(MARKET_TRENDS).sort((a,b) => (b[1]?.trendPct || 0) - (a[1]?.trendPct || 0));
                        return sorted[0] ? sorted[0][0] + ' (+' + sorted[0][1]?.trendPct?.toFixed(1) + '%)' : '-';
                    })()"></p>
                </div>
                <div class="glass-panel p-4 rounded-xl text-center">
                    <p class="text-xs text-gray-400">üìâ Mayor Bajada Hoy</p>
                    <p class="font-bold text-red-400 text-sm mt-1" x-text="(() => {
                        if (typeof MARKET_TRENDS === 'undefined') return '-';
                        const sorted = Object.entries(MARKET_TRENDS).sort((a,b) => (a[1]?.trendPct || 0) - (b[1]?.trendPct || 0));
                        return sorted[0] ? sorted[0][0] + ' (' + sorted[0][1]?.trendPct?.toFixed(1) + '%)' : '-';
                    })()"></p>
                </div>
                <div class="glass-panel p-4 rounded-xl text-center">
                    <p class="text-xs text-gray-400">üíé M√°s Valioso</p>
                    <p class="font-bold text-yellow-400 text-sm mt-1" x-text="(() => {
                        const sorted = Object.entries(marketData).sort((a,b) => b[1] - a[1]);
                        return sorted[0] ? sorted[0][0] : '-';
                    })()"></p>
                </div>
                <div class="glass-panel p-4 rounded-xl text-center">
                    <p class="text-xs text-gray-400">‚≠ê Mejor PPM</p>
                    <p class="font-bold text-purple-400 text-sm mt-1" x-text="(() => {
                        if (typeof MARKET_INFO === 'undefined') return '-';
                        const ppm = Object.entries(MARKET_INFO).map(([name, info]) => ({
                            name, ppm: (info.points || 0) / ((marketData[name] || 1) / 1000000)
                        })).sort((a,b) => b.ppm - a.ppm);
                        return ppm[0] ? ppm[0].name + ' (' + ppm[0].ppm.toFixed(2) + ')' : '-';
                    })()"></p>
                </div>
            </div>

            <!-- Players Table -->
            <div class="glass-panel p-4 rounded-xl overflow-x-auto max-h-[600px] overflow-y-auto">
                <!-- Watchlist Toggle -->
                <div class="flex justify-between items-center mb-3">
                    <span class="text-sm text-gray-400"
                        x-text="'Mostrando ' + (showWatchlistOnly ? watchlist.length + ' seguidos' : 'todos los jugadores')"></span>
                    <button @click="showWatchlistOnly = !showWatchlistOnly"
                        :class="showWatchlistOnly ? 'bg-yellow-500/20 text-yellow-400 border-yellow-500' : 'bg-gray-800 text-gray-400 border-gray-700'"
                        class="px-3 py-1.5 rounded-lg text-sm font-medium border transition-all flex items-center gap-2">
                        <span>‚≠ê</span>
                        <span
                            x-text="showWatchlistOnly ? 'Mostrar Todos' : 'Solo Seguidos (' + watchlist.length + ')'"></span>
                    </button>
                </div>
                <table class="w-full text-left text-sm">
                    <thead class="sticky top-0 bg-gray-900 z-10">
                        <tr class="text-gray-400 text-xs uppercase">
                            <th class="px-2 py-2 w-8">‚≠ê</th>
                            <th class="px-3 py-2">#</th>
                            <th class="px-3 py-2">Jugador</th>
                            <th class="px-3 py-2 text-center">Pos</th>
                            <th class="px-3 py-2 text-right">Valor</th>
                            <th class="px-3 py-2 text-right">Pts</th>
                            <th class="px-3 py-2 text-right">PPM</th>
                            <th class="px-3 py-2 text-right">Cambio ‚Ç¨</th>
                            <th class="px-3 py-2 text-right">Cambio %</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="(player, idx) in (() => {
                            let players = Object.entries(marketData).map(([name, value]) => ({
                                name, value,
                                position: (typeof MARKET_INFO !== 'undefined' && MARKET_INFO[name]?.position) || '?',
                                points: (typeof MARKET_INFO !== 'undefined' && MARKET_INFO[name]?.points) || 0,
                                trend: (typeof MARKET_TRENDS !== 'undefined' && MARKET_TRENDS[name]?.trend) || 0,
                                trendPct: (typeof MARKET_TRENDS !== 'undefined' && MARKET_TRENDS[name]?.trendPct) || 0,
                                ppm: ((typeof MARKET_INFO !== 'undefined' && MARKET_INFO[name]?.points) || 0) / (value / 1000000)
                            }));
                            
                            // Filter by search
                            if (marketExplorer.searchQuery) {
                                players = players.filter(p => p.name.toLowerCase().includes(marketExplorer.searchQuery.toLowerCase()));
                            }
                            // Filter by position
                            if (marketExplorer.positionFilter !== 'all') {
                                players = players.filter(p => p.position === marketExplorer.positionFilter);
                            }
                            // Filter by watchlist
                            if (showWatchlistOnly) {
                                players = players.filter(p => watchlist.includes(p.name));
                            }
                            // Sort
                            const sortKey = marketExplorer.sortBy;
                            players.sort((a, b) => marketExplorer.sortDir === 'desc' ? b[sortKey] - a[sortKey] : a[sortKey] - b[sortKey]);
                            return players.slice(0, 100);
                        })()" :key="player.name">
                            <tr class="border-b border-gray-800 hover:bg-gray-800/50">
                                <td class="px-2 py-2 text-center">
                                    <button @click="toggleWatchlist(player.name)"
                                        class="text-lg hover:scale-125 transition-transform"
                                        :class="isInWatchlist(player.name) ? 'text-yellow-400' : 'text-gray-600 hover:text-gray-400'">
                                        <span x-text="isInWatchlist(player.name) ? '‚òÖ' : '‚òÜ'"></span>
                                    </button>
                                </td>
                                <td class="px-3 py-2 text-gray-500" x-text="idx + 1"></td>
                                <td class="px-3 py-2 font-medium text-white" x-text="player.name"></td>
                                <td class="px-3 py-2 text-center">
                                    <span class="px-2 py-0.5 rounded text-xs font-bold"
                                        :class="{'bg-yellow-500/20 text-yellow-400': player.position === 'PT', 'bg-blue-500/20 text-blue-400': player.position === 'DF', 'bg-green-500/20 text-green-400': player.position === 'MD', 'bg-red-500/20 text-red-400': player.position === 'DL'}"
                                        x-text="player.position"></span>
                                </td>
                                <td class="px-3 py-2 text-right font-mono text-gray-300"
                                    x-text="formatMoney(player.value)"></td>
                                <td class="px-3 py-2 text-right font-bold text-cyan-400" x-text="player.points"></td>
                                <td class="px-3 py-2 text-right font-mono text-purple-400"
                                    x-text="player.ppm.toFixed(2)"></td>
                                <td class="px-3 py-2 text-right font-mono"
                                    :class="player.trend > 0 ? 'text-green-400' : player.trend < 0 ? 'text-red-400' : 'text-gray-500'"
                                    x-text="(player.trend > 0 ? '+' : '') + formatMoney(player.trend)"></td>
                                <td class="px-3 py-2 text-right font-mono"
                                    :class="player.trendPct > 0 ? 'text-green-400' : player.trendPct < 0 ? 'text-red-400' : 'text-gray-500'"
                                    x-text="(player.trendPct > 0 ? '‚ñ≤ +' : player.trendPct < 0 ? '‚ñº ' : '') + player.trendPct.toFixed(2) + '%'">
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- =============== MOVEMENTS HISTORY TAB =============== -->
        <div x-show="currentTab === 'movements'" x-cloak class="space-y-6">
            <div class="flex justify-between items-center flex-wrap gap-4">
                <h2 class="text-2xl font-bold text-orange-400 flex items-center gap-2">
                    üìã Historial de Movimientos
                    <span class="text-sm font-normal text-gray-400"
                        x-text="'(' + movements.length + ' operaciones)'"></span>
                </h2>
                <div class="flex gap-2">
                    <button @click="resetData()"
                        class="px-4 py-2 bg-yellow-500/20 hover:bg-yellow-500/30 text-yellow-400 border border-yellow-500/50 rounded-lg text-sm font-medium flex items-center gap-2 transition-all">
                        ‚ö†Ô∏è Restablecer Datos
                    </button>
                    <button @click="removeDuplicates()"
                        class="px-4 py-2 bg-red-500/20 hover:bg-red-500/30 text-red-400 border border-red-500/50 rounded-lg text-sm font-medium flex items-center gap-2 transition-all">
                        üßπ Limpiar Duplicados
                    </button>
                    <button @click="exportMovementsCSV()"
                        class="px-4 py-2 bg-green-500/20 hover:bg-green-500/30 text-green-400 border border-green-500/50 rounded-lg text-sm font-medium flex items-center gap-2 transition-all">
                        üìÅ Exportar CSV
                    </button>
                </div>
            </div>

            <!-- Movement KPIs -->
            <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                <div class="glass-panel p-4 rounded-xl text-center">
                    <p class="text-xs text-gray-400">üí∞ Volumen Total</p>
                    <p class="font-bold text-xl text-green-400"
                        x-text="formatMoney(movements.filter(m => m.type === 'transfer').reduce((sum, m) => sum + m.amount, 0))">
                    </p>
                </div>
                <div class="glass-panel p-4 rounded-xl text-center">
                    <p class="text-xs text-gray-400">üìä Media por Fichaje</p>
                    <p class="font-bold text-xl text-cyan-400" x-text="(() => {
                        const transfers = movements.filter(m => m.type === 'transfer');
                        return transfers.length ? formatMoney(transfers.reduce((s, m) => s + m.amount, 0) / transfers.length) : '-';
                    })()"></p>
                </div>
                <div class="glass-panel p-4 rounded-xl text-center">
                    <p class="text-xs text-gray-400">üèÜ Fichaje m√°s Caro</p>
                    <p class="font-bold text-sm text-yellow-400" x-text="(() => {
                        const transfers = movements.filter(m => m.type === 'transfer').sort((a,b) => b.amount - a.amount);
                        return transfers[0] ? transfers[0].player + ' (' + formatMoney(transfers[0].amount) + ')' : '-';
                    })()"></p>
                </div>
                <div class="glass-panel p-4 rounded-xl text-center">
                    <p class="text-xs text-gray-400">üë§ Manager M√°s Activo</p>
                    <p class="font-bold text-sm text-purple-400" x-text="(() => {
                        const counts = {};
                        movements.filter(m => m.type === 'transfer').forEach(m => {
                            counts[m.buyer] = (counts[m.buyer] || 0) + 1;
                        });
                        const sorted = Object.entries(counts).sort((a,b) => b[1] - a[1]);
                        return sorted[0] ? sorted[0][0] + ' (' + sorted[0][1] + ')' : '-';
                    })()"></p>
                </div>
                <div class="glass-panel p-4 rounded-xl text-center">
                    <p class="text-xs text-gray-400">‚öΩ Jugador M√°s Traspasado</p>
                    <p class="font-bold text-sm text-pink-400" x-text="(() => {
                        const counts = {};
                        movements.filter(m => m.type === 'transfer').forEach(m => {
                            counts[m.player] = (counts[m.player] || 0) + 1;
                        });
                        const sorted = Object.entries(counts).sort((a,b) => b[1] - a[1]);
                        return sorted[0] ? sorted[0][0] + ' (' + sorted[0][1] + 'x)' : '-';
                    })()"></p>
                </div>
            </div>

            <!-- Filters -->
            <div class="glass-panel p-4 rounded-xl">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-xs text-gray-400 mb-1">Buscar</label>
                        <input type="text" x-model="movementsTab.searchQuery" placeholder="Jugador o equipo..."
                            class="w-full bg-gray-900 border border-gray-700 rounded-lg p-2 text-white text-sm">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-400 mb-1">Manager</label>
                        <select x-model="movementsTab.managerFilter"
                            class="w-full bg-gray-900 border border-gray-700 rounded-lg p-2 text-white text-sm">
                            <option value="all">Todos</option>
                            <template x-for="m in Object.keys(managers)" :key="m">
                                <option :value="m" x-text="m"></option>
                            </template>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs text-gray-400 mb-1">Tipo</label>
                        <select x-model="movementsTab.typeFilter"
                            class="w-full bg-gray-900 border border-gray-700 rounded-lg p-2 text-white text-sm">
                            <option value="all">Todos</option>
                            <option value="transfer">Traspasos</option>
                            <option value="reward">Recompensas</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button
                            @click="movementsTab = {searchQuery: '', managerFilter: 'all', dateFrom: '', dateTo: '', typeFilter: 'all'}"
                            class="w-full bg-gray-700 hover:bg-gray-600 text-white rounded-lg p-2 text-sm transition">
                            üîÑ Limpiar Filtros
                        </button>
                    </div>
                </div>
            </div>

            <!-- Movements Table -->
            <div class="glass-panel p-4 rounded-xl overflow-x-auto max-h-[500px] overflow-y-auto">
                <table class="w-full text-left text-sm">
                    <thead class="sticky top-0 bg-gray-900 z-10">
                        <tr class="text-gray-400 text-xs uppercase">
                            <th class="px-3 py-2 cursor-pointer hover:text-white"
                                @click="movementsTab.sortBy = 'date'; movementsTab.sortDir = movementsTab.sortDir === 'desc' ? 'asc' : 'desc'">
                                Fecha <span x-show="movementsTab.sortBy === 'date'"
                                    x-text="movementsTab.sortDir === 'desc' ? '‚ñº' : '‚ñ≤'"></span>
                            </th>
                            <th class="px-3 py-2 cursor-pointer hover:text-white"
                                @click="movementsTab.sortBy = 'type'; movementsTab.sortDir = movementsTab.sortDir === 'desc' ? 'asc' : 'desc'">
                                Tipo <span x-show="movementsTab.sortBy === 'type'"
                                    x-text="movementsTab.sortDir === 'desc' ? '‚ñº' : '‚ñ≤'"></span>
                            </th>
                            <th class="px-3 py-2 cursor-pointer hover:text-white"
                                @click="movementsTab.sortBy = 'player'; movementsTab.sortDir = movementsTab.sortDir === 'desc' ? 'asc' : 'desc'">
                                Jugador <span x-show="movementsTab.sortBy === 'player'"
                                    x-text="movementsTab.sortDir === 'desc' ? '‚ñº' : '‚ñ≤'"></span>
                            </th>
                            <th class="px-3 py-2">De</th>
                            <th class="px-3 py-2">A</th>
                            <th class="px-3 py-2 text-right cursor-pointer hover:text-white"
                                @click="movementsTab.sortBy = 'amount'; movementsTab.sortDir = movementsTab.sortDir === 'desc' ? 'asc' : 'desc'">
                                Importe <span x-show="movementsTab.sortBy === 'amount'"
                                    x-text="movementsTab.sortDir === 'desc' ? '‚ñº' : '‚ñ≤'"></span>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="(mov, idx) in (() => {
                            let filtered = [...movements];
                            if (movementsTab.searchQuery) {
                                const q = movementsTab.searchQuery.toLowerCase();
                                filtered = filtered.filter(m => (m.player && m.player.toLowerCase().includes(q)) || (m.buyer && m.buyer.toLowerCase().includes(q)) || (m.seller && m.seller.toLowerCase().includes(q)) || (m.beneficiary && m.beneficiary.toLowerCase().includes(q)));
                            }
                            if (movementsTab.managerFilter !== 'all') {
                                filtered = filtered.filter(m => m.buyer === movementsTab.managerFilter || m.seller === movementsTab.managerFilter || m.beneficiary === movementsTab.managerFilter);
                            }
                            if (movementsTab.typeFilter !== 'all') {
                                filtered = filtered.filter(m => m.type === movementsTab.typeFilter);
                            }
                            filtered.sort((a, b) => {
                                const parseD = (d) => { if (!d || d === 'Sin fecha') return Date.now(); const p = d.split(' ')[0].split('/'); return p.length >= 3 ? new Date(parseInt(p[2]), parseInt(p[1])-1, parseInt(p[0])).getTime() : 0; };
                                let cmp = 0;
                                if (movementsTab.sortBy === 'date') cmp = parseD(b.date) - parseD(a.date);
                                else if (movementsTab.sortBy === 'type') cmp = (a.type || '').localeCompare(b.type || '');
                                else if (movementsTab.sortBy === 'player') cmp = (a.player || a.beneficiary || '').localeCompare(b.player || b.beneficiary || '');
                                else if (movementsTab.sortBy === 'amount') cmp = (b.amount || 0) - (a.amount || 0);
                                return movementsTab.sortDir === 'asc' ? -cmp : cmp;
                            });
                            return filtered.slice(0, 200);
                        })()" :key="mov.id || idx">
                            <tr class="border-b border-gray-800 hover:bg-gray-800/50">
                                <td class="px-3 py-2 text-gray-400 text-xs" x-text="mov.date"></td>
                                <td class="px-3 py-2">
                                    <span class="px-2 py-0.5 rounded text-xs font-bold"
                                        :class="mov.type === 'transfer' ? 'bg-blue-500/20 text-blue-400' : 'bg-green-500/20 text-green-400'"
                                        x-text="mov.type === 'transfer' ? 'üîÑ Traspaso' : 'üéÅ Reward'"></span>
                                </td>
                                <td class="px-3 py-2 font-medium text-white" x-text="mov.player"></td>
                                <td class="px-3 py-2 text-red-400 cursor-pointer hover:underline"
                                    @click="selectedManagerDetail = mov.seller; showManagerModal = true"
                                    x-text="mov.seller"></td>
                                <td class="px-3 py-2 text-green-400 cursor-pointer hover:underline"
                                    @click="selectedManagerDetail = mov.buyer; showManagerModal = true"
                                    x-text="mov.buyer"></td>
                                <td class="px-3 py-2 text-right font-mono text-yellow-400"
                                    x-text="formatMoney(mov.amount)"></td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- =============== MANAGER DETAIL MODAL =============== -->
        <div x-show="showManagerModal" x-cloak
            class="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4"
            @click.self="showManagerModal = false">
            <div
                class="bg-gray-900 rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto border border-gray-700 shadow-2xl">
                <!-- Header -->
                <div class="sticky top-0 bg-gray-900 border-b border-gray-700 p-6 flex justify-between items-center">
                    <h3 class="text-2xl font-bold text-white flex items-center gap-2">
                        üë§ <span x-text="selectedManagerDetail"></span>
                    </h3>
                    <button @click="showManagerModal = false" class="text-gray-400 hover:text-white text-2xl">√ó</button>
                </div>

                <template x-if="selectedManagerDetail && managers[selectedManagerDetail]">
                    <div class="p-6 space-y-6">
                        <!-- Manager Stats -->
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="glass-panel p-4 rounded-xl text-center">
                                <p class="text-xs text-gray-400">üí∞ Balance</p>
                                <p class="font-bold text-lg text-green-400"
                                    x-text="formatMoney(sortedManagers.find(m => m.name === selectedManagerDetail)?.balance || 0)">
                                </p>
                            </div>
                            <div class="glass-panel p-4 rounded-xl text-center">
                                <p class="text-xs text-gray-400">üìä Valor Plantilla</p>
                                <p class="font-bold text-lg text-cyan-400"
                                    x-text="formatMoney(managers[selectedManagerDetail]?.teamValue || 0)"></p>
                            </div>
                            <div class="glass-panel p-4 rounded-xl text-center">
                                <p class="text-xs text-gray-400">‚öñÔ∏è Cl√°usulas</p>
                                <p class="font-bold text-lg text-red-400"
                                    x-text="formatMoney(managers[selectedManagerDetail]?.clauseExpenses || 0)"></p>
                            </div>
                            <div class="glass-panel p-4 rounded-xl text-center">
                                <p class="text-xs text-gray-400">üè¶ Patrimonio</p>
                                <p class="font-bold text-lg text-yellow-400"
                                    x-text="formatMoney((sortedManagers.find(m => m.name === selectedManagerDetail)?.balance || 0) + (managers[selectedManagerDetail]?.teamValue || 0))">
                                </p>
                            </div>
                        </div>

                        <!-- Current Squad -->
                        <div class="glass-panel p-4 rounded-xl">
                            <h4 class="font-bold text-lg text-white mb-4">‚öΩ Plantilla Actual</h4>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm">
                                    <thead>
                                        <tr class="text-gray-400 text-xs uppercase border-b border-gray-700">
                                            <th class="px-3 py-2 text-left">Jugador</th>
                                            <th class="px-3 py-2 text-right">Coste</th>
                                            <th class="px-3 py-2 text-right">Valor Actual</th>
                                            <th class="px-3 py-2 text-right">+/-</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <template
                                            x-for="(data, player) in (tradingHistory.rosters[selectedManagerDetail] || {})"
                                            :key="player">
                                            <tr class="border-b border-gray-800">
                                                <td class="px-3 py-2 text-white" x-text="player"></td>
                                                <td class="px-3 py-2 text-right text-gray-400"
                                                    x-text="formatMoney(data.cost)"></td>
                                                <td class="px-3 py-2 text-right text-cyan-400"
                                                    x-text="formatMoney(marketData[player] || 0)"></td>
                                                <td class="px-3 py-2 text-right font-bold"
                                                    :class="(marketData[player] || 0) - data.cost > 0 ? 'text-green-400' : 'text-red-400'"
                                                    x-text="((marketData[player] || 0) - data.cost > 0 ? '+' : '') + formatMoney((marketData[player] || 0) - data.cost)">
                                                </td>
                                            </tr>
                                        </template>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Recent Movements -->
                        <div class="glass-panel p-4 rounded-xl">
                            <h4 class="font-bold text-lg text-white mb-4">üìã √öltimos Movimientos</h4>
                            <div class="space-y-2 max-h-64 overflow-y-auto">
                                <template
                                    x-for="mov in movements.filter(m => m.buyer === selectedManagerDetail || m.seller === selectedManagerDetail).slice(0, 20)"
                                    :key="mov.date + mov.player">
                                    <div
                                        class="flex justify-between items-center p-2 bg-gray-800/50 rounded-lg text-sm">
                                        <div>
                                            <span class="text-gray-400 text-xs" x-text="mov.date"></span>
                                            <span class="ml-2 font-medium text-white" x-text="mov.player"></span>
                                        </div>
                                        <div class="text-right">
                                            <span
                                                :class="mov.buyer === selectedManagerDetail ? 'text-green-400' : 'text-red-400'"
                                                x-text="(mov.buyer === selectedManagerDetail ? '‚Üê Compra' : '‚Üí Venta')"></span>
                                            <span class="ml-2 font-mono text-yellow-400"
                                                x-text="formatMoney(mov.amount)"></span>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
        </div>

    </main>

    <!-- MOBILE BOTTOM NAVIGATION -->
    <nav class="lg:hidden fixed bottom-0 left-0 right-0 z-50 glass-panel border-t border-gray-800"
        style="padding-bottom: env(safe-area-inset-bottom);">
        <!-- Popup Menu (outside buttons for proper layering) -->
        <div x-show="mobileMenuOpen" x-cloak x-transition:enter="transition ease-out duration-200"
            x-transition:enter-start="opacity-0 translate-y-2" x-transition:enter-end="opacity-100 translate-y-0"
            @click.outside="mobileMenuOpen = false"
            class="absolute bottom-full right-2 mb-2 w-48 glass-panel rounded-xl border border-gray-700 shadow-2xl p-2 space-y-1 z-[60]">
            <button @click="currentTab = 'stats'; mobileMenuOpen = false"
                class="w-full text-left px-3 py-2.5 rounded-lg text-sm flex items-center gap-2 hover:bg-gray-800 active:bg-gray-700"
                :class="currentTab === 'stats' ? 'text-neon-pink bg-neon-pink/10' : 'text-gray-300'">
                üìà Estad√≠sticas
            </button>
            <button @click="currentTab = 'clauses'; mobileMenuOpen = false"
                class="w-full text-left px-3 py-2.5 rounded-lg text-sm flex items-center gap-2 hover:bg-gray-800 active:bg-gray-700"
                :class="currentTab === 'clauses' ? 'text-neon-purple bg-neon-purple/10' : 'text-gray-300'">
                ‚öñÔ∏è Cl√°usulas
            </button>
            <button @click="currentTab = 'advanced'; mobileMenuOpen = false"
                class="w-full text-left px-3 py-2.5 rounded-lg text-sm flex items-center gap-2 hover:bg-gray-800 active:bg-gray-700"
                :class="currentTab === 'advanced' ? 'text-yellow-400 bg-yellow-400/10' : 'text-gray-300'">
                üöÄ M√©tricas
            </button>
        </div>

        <!-- Navigation Buttons -->
        <div class="flex justify-around items-center px-1 py-1.5">
            <button @click="currentTab = 'dashboard'"
                :class="currentTab === 'dashboard' ? 'text-neon-blue' : 'text-gray-500'"
                class="flex flex-col items-center justify-center p-1.5 min-w-[60px]">
                <span class="text-lg">üìä</span>
                <span class="text-[9px] mt-0.5">Dashboard</span>
            </button>
            <button @click="currentTab = 'parser'"
                :class="currentTab === 'parser' ? 'text-neon-green' : 'text-gray-500'"
                class="flex flex-col items-center justify-center p-1.5 min-w-[60px]">
                <span class="text-lg">‚ú®</span>
                <span class="text-[9px] mt-0.5">Parser</span>
            </button>
            <button @click="currentTab = 'market'" :class="currentTab === 'market' ? 'text-cyan-400' : 'text-gray-500'"
                class="flex flex-col items-center justify-center p-1.5 min-w-[60px]">
                <span class="text-lg">üìà</span>
                <span class="text-[9px] mt-0.5">Mercado</span>
            </button>
            <button @click="currentTab = 'movements'"
                :class="currentTab === 'movements' ? 'text-orange-400' : 'text-gray-500'"
                class="flex flex-col items-center justify-center p-1.5 min-w-[60px]">
                <span class="text-lg">üìã</span>
                <span class="text-[9px] mt-0.5">Historial</span>
            </button>
            <button @click="mobileMenuOpen = !mobileMenuOpen"
                :class="mobileMenuOpen ? 'text-yellow-400' : 'text-gray-500'"
                class="flex flex-col items-center justify-center p-1.5 min-w-[60px]">
                <span class="text-lg">‚ãØ</span>
                <span class="text-[9px] mt-0.5">M√°s</span>
            </button>
        </div>
    </nav>

    <!-- Add padding at bottom for mobile nav -->
    <div class="lg:hidden h-16"></div>

    <!-- LOGIC -->
    <script>
        // CONFIGURACI√ìN DE FIREBASE (PRODUCCI√ìN)
        const firebaseConfig = {
            apiKey: "AIzaSyBzlYu7dTaEvIIt7VehdhVwqOLS2BLnqDQ",
            authDomain: "mercato-fbdcc.firebaseapp.com",
            databaseURL: "https://mercato-fbdcc-default-rtdb.firebaseio.com",
            projectId: "mercato-fbdcc",
            storageBucket: "mercato-fbdcc.firebasestorage.app",
            messagingSenderId: "865841758007",
            appId: "1:865841758007:web:ac53121bc37d00574864b2",
            measurementId: "G-0WQNPFTYNF"
        };

        let db = null;
        let dbRef = null;

        // Intentar inicializar Firebase
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.database();
            console.log("Firebase initialized successfully with Realtime Database");
        } catch (e) {
            console.error("Firebase load error", e);
        }

        function gamePlayApp() {
            return {
                currentTab: 'dashboard',
                mobileMenuOpen: false,
                syncStatus: 'synced', // 'synced', 'syncing', 'error'
                rawInput: '',
                clauseBulkInput: '',
                clauseForm: { manager: '', amount: '' },
                logs: [],

                // DATA MODEL
                isRemoteUpdate: false, // Flag to prevent circular updates
                managers: {
                    "Vigar FC": { initialBudget: 103000000, teamValue: 0, clauseExpenses: 0, name: "Vigar FC" },
                    "GOLENCIERRO FC": { initialBudget: 103000000, teamValue: 0, clauseExpenses: 0, name: "GOLENCIERRO FC" },
                    "Pablinistan FC": { initialBudget: 103000000, teamValue: 0, clauseExpenses: 0, name: "Pablinistan FC" },
                    "Alcatamy eSports By": { initialBudget: 100000000, teamValue: 0, clauseExpenses: 0, name: "Alcatamy eSports By" },
                    "Visite La Manga FC": { initialBudget: 103000000, teamValue: 0, clauseExpenses: 0, name: "Visite La Manga FC" },
                    "Morenazos FC": { initialBudget: 103000000, teamValue: 0, clauseExpenses: 0, name: "Morenazos FC" }
                },
                movements: [], // Array flat de todos los movimientos
                pendingMovements: [], // Staging area
                marketData: typeof MARKET_DATA !== 'undefined' ? MARKET_DATA : {},
                filters: {
                    search: '',
                    team: 'all',
                    type: 'all'
                },
                tradingHistory: { closedDeals: [], rosters: {}, managerStats: {} },

                // WATCHLIST
                watchlist: JSON.parse(localStorage.getItem('fantasy_watchlist') || '[]'),
                showWatchlistOnly: false,

                // ANALYTICS STATE
                managerAnalytics: {
                    // Will be populated per manager: { purchases: [], avgSpread: 0, spreadByPosition: {}, patterns: {} }
                },
                selectedAnalyticsManager: '',

                // MANAGER COMPARATOR
                comparatorManager1: '',
                comparatorManager2: '',
                showComparator: false,

                // MARKET EXPLORER STATE
                marketExplorer: {
                    sortBy: 'value',     // value, points, trend, trendPct
                    sortDir: 'desc',
                    positionFilter: 'all', // all, PT, DF, MD, DL
                    searchQuery: ''
                },

                // MOVEMENTS TAB STATE
                movementsTab: {
                    searchQuery: '',
                    managerFilter: 'all',
                    dateFrom: '',
                    dateTo: '',
                    typeFilter: 'all',  // all, transfer, reward
                    sortBy: 'date',     // date, type, player, amount
                    sortDir: 'desc'     // asc, desc
                },

                // MANAGER DETAIL MODAL
                selectedManagerDetail: null,
                showManagerModal: false,

                get filteredMovements() {
                    return this.movements.filter(m => {
                        const search = this.filters.search.toLowerCase();
                        const matchesSearch = !search ||
                            m.player.toLowerCase().includes(search) ||
                            m.buyer.toLowerCase().includes(search) ||
                            m.seller.toLowerCase().includes(search);
                        const matchesTeam = this.filters.team === 'all' || m.buyer === this.filters.team || m.seller === this.filters.team;
                        const matchesType = this.filters.type === 'all' || m.type === this.filters.type;
                        return matchesSearch && matchesTeam && matchesType;
                    });
                },

                reconstructTradingHistory() {
                    const sorted = [...this.movements].sort((a, b) => this.parseDate(a.date) - this.parseDate(b.date));
                    const rosters = {};
                    const closedDeals = [];
                    const managerStats = {};

                    Object.keys(this.managers).forEach(m => {
                        rosters[m] = {};
                        managerStats[m] = { name: m, buys: 0, sales: 0, profit: 0, dealsCount: 0 };
                    });

                    sorted.forEach(m => {
                        const amt = parseInt(m.amount) || 0;
                        if (m.type === 'transfer') {
                            if (rosters[m.seller] && rosters[m.seller][m.player]) {
                                const cost = rosters[m.seller][m.player].cost;
                                const profit = amt - cost;
                                const roi = cost > 0 ? (profit / cost) * 100 : 0;
                                closedDeals.push({ player: m.player, manager: m.seller, buyPrice: cost, sellPrice: amt, profit, roi, date: m.date });
                                if (managerStats[m.seller]) {
                                    managerStats[m.seller].sales += amt;
                                    managerStats[m.seller].profit += profit;
                                    managerStats[m.seller].dealsCount++;
                                }
                                delete rosters[m.seller][m.player];
                            } else if (managerStats[m.seller]) {
                                managerStats[m.seller].sales += amt;
                            }
                            if (managerStats[m.buyer]) {
                                if (!rosters[m.buyer]) rosters[m.buyer] = {};
                                rosters[m.buyer][m.player] = { cost: amt, date: m.date };
                                managerStats[m.buyer].buys += amt;
                            }
                        }
                    });
                    this.tradingHistory = { closedDeals, rosters, managerStats };
                },
                get topSales() { return [...this.movements].filter(m => m.type === 'transfer').sort((a, b) => parseInt(b.amount) - parseInt(a.amount)).slice(0, 50); },
                get topPurchases() { return this.topSales; },
                get bestDeals() { if (!this.tradingHistory.closedDeals.length) this.reconstructTradingHistory(); return [...this.tradingHistory.closedDeals].sort((a, b) => b.profit - a.profit).slice(0, 50); },
                get worstDeals() { if (!this.tradingHistory.closedDeals.length) this.reconstructTradingHistory(); return [...this.tradingHistory.closedDeals].sort((a, b) => a.profit - b.profit).slice(0, 50); },
                get marketValuation() {
                    if (!Object.keys(this.tradingHistory.rosters).length) this.reconstructTradingHistory();
                    return Object.keys(this.tradingHistory.rosters).map(mgr => {
                        let totalValue = 0;
                        let totalInvested = 0;
                        const roster = this.tradingHistory.rosters[mgr];
                        Object.keys(roster).forEach(pName => {
                            let val = this.marketData[pName] || 0;
                            if (val === 0) { const found = Object.keys(this.marketData).find(k => k.includes(pName) || pName.includes(k)); if (found) val = this.marketData[found]; }
                            totalValue += val;
                            totalInvested += roster[pName].cost;
                        });
                        return { name: mgr, marketValue: totalValue, invested: totalInvested, unrealizedProfit: totalValue - totalInvested };
                    });
                },

                async initApp() {
                    // Initialize debouncers
                    this.debouncedSaveData = this.debounce(() => this.saveData(), 2000);
                    this.debouncedUpdateCharts = this.debounce(() => this.updateCharts(), 2000);

                    this.loadData();

                    this.$watch('managers', () => {
                        if (!this.isRemoteUpdate) this.debouncedSaveData();
                    }, { deep: true });
                    this.$watch('movements', () => {
                        if (!this.isRemoteUpdate) this.debouncedSaveData();
                        this.debouncedUpdateCharts();
                    });
                    this.$watch('currentTab', (val) => {
                        if (val === 'dashboard') {
                            this.$nextTick(() => this.updateCharts());
                        }
                    });

                    // Initial chart render after data loads
                    setTimeout(() => this.updateCharts(), 1000);
                },

                // UTILS
                debounce(func, wait) {
                    let timeout;
                    return (...args) => {
                        const later = () => {
                            clearTimeout(timeout);
                            func.apply(this, args);
                        };
                        clearTimeout(timeout);
                        timeout = setTimeout(later, wait);
                    };
                },

                // CHARTS
                patrimonyChart: null,
                activityChart: null,

                updateCharts() {
                    // Only update if on dashboard tab
                    if (this.currentTab !== 'dashboard') return;

                    this.$nextTick(() => {
                        // Patrimony Chart
                        const patrimonyCtx = document.getElementById('patrimonyChart');
                        if (patrimonyCtx) {
                            const data = this.sortedManagers.map(m => ({
                                name: m.name.split(' ')[0], // Short name
                                balance: m.balance,
                                teamValue: m.teamValue,
                                patrimony: m.balance + m.teamValue
                            }));

                            if (this.patrimonyChart) {
                                this.patrimonyChart.destroy();
                            }

                            this.patrimonyChart = new Chart(patrimonyCtx, {
                                type: 'bar',
                                data: {
                                    labels: data.map(d => d.name),
                                    datasets: [
                                        {
                                            label: 'Saldo',
                                            data: data.map(d => d.balance / 1000000),
                                            backgroundColor: 'rgba(59, 130, 246, 0.7)',
                                            borderColor: 'rgba(59, 130, 246, 1)',
                                            borderWidth: 1
                                        },
                                        {
                                            label: 'Plantilla',
                                            data: data.map(d => d.teamValue / 1000000),
                                            backgroundColor: 'rgba(34, 197, 94, 0.7)',
                                            borderColor: 'rgba(34, 197, 94, 1)',
                                            borderWidth: 1
                                        }
                                    ]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    plugins: {
                                        legend: { labels: { color: '#9ca3af' } }
                                    },
                                    scales: {
                                        x: {
                                            stacked: true,
                                            ticks: { color: '#9ca3af' },
                                            grid: { color: 'rgba(255,255,255,0.05)' }
                                        },
                                        y: {
                                            stacked: true,
                                            ticks: {
                                                color: '#9ca3af',
                                                callback: v => v + 'M‚Ç¨'
                                            },
                                            grid: { color: 'rgba(255,255,255,0.05)' }
                                        }
                                    }
                                }
                            });
                        }

                        // Activity Chart - Trading volume by manager
                        const activityCtx = document.getElementById('activityChart');
                        if (activityCtx) {
                            const managerActivity = {};
                            Object.keys(this.managers).forEach(m => {
                                managerActivity[m] = { buys: 0, sales: 0 };
                            });

                            this.movements.filter(m => m.type === 'transfer').forEach(m => {
                                if (managerActivity[m.buyer]) managerActivity[m.buyer].buys++;
                                if (managerActivity[m.seller]) managerActivity[m.seller].sales++;
                            });

                            const labels = Object.keys(managerActivity).map(n => n.split(' ')[0]);
                            const buys = Object.values(managerActivity).map(v => v.buys);
                            const sales = Object.values(managerActivity).map(v => v.sales);

                            if (this.activityChart) {
                                this.activityChart.destroy();
                            }

                            this.activityChart = new Chart(activityCtx, {
                                type: 'bar',
                                data: {
                                    labels,
                                    datasets: [
                                        {
                                            label: 'Compras',
                                            data: buys,
                                            backgroundColor: 'rgba(34, 197, 94, 0.7)',
                                            borderColor: 'rgba(34, 197, 94, 1)',
                                            borderWidth: 1
                                        },
                                        {
                                            label: 'Ventas',
                                            data: sales,
                                            backgroundColor: 'rgba(239, 68, 68, 0.7)',
                                            borderColor: 'rgba(239, 68, 68, 1)',
                                            borderWidth: 1
                                        }
                                    ]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    plugins: {
                                        legend: { labels: { color: '#9ca3af' } }
                                    },
                                    scales: {
                                        x: {
                                            ticks: { color: '#9ca3af' },
                                            grid: { color: 'rgba(255,255,255,0.05)' }
                                        },
                                        y: {
                                            ticks: { color: '#9ca3af' },
                                            grid: { color: 'rgba(255,255,255,0.05)' }
                                        }
                                    }
                                }
                            });
                        }
                    });
                },

                formatMoney(amount) {
                    return new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 }).format(amount);
                },

                addLog(msg, type = 'info') {
                    const time = new Date().toLocaleTimeString();
                    this.logs.unshift({ id: Date.now(), time, msg, type });
                },

                // WATCHLIST FUNCTIONS
                isInWatchlist(playerName) {
                    return this.watchlist.includes(playerName);
                },

                toggleWatchlist(playerName) {
                    const idx = this.watchlist.indexOf(playerName);
                    if (idx > -1) {
                        this.watchlist.splice(idx, 1);
                    } else {
                        this.watchlist.push(playerName);
                    }
                    localStorage.setItem('fantasy_watchlist', JSON.stringify(this.watchlist));
                },

                // MANAGER COMPARATOR
                getCompareData() {
                    const m1 = this.managers[this.comparatorManager1];
                    const m2 = this.managers[this.comparatorManager2];
                    if (!m1 || !m2) return null;

                    const m1Buys = this.movements.filter(m => m.type === 'transfer' && m.buyer === this.comparatorManager1).length;
                    const m1Sales = this.movements.filter(m => m.type === 'transfer' && m.seller === this.comparatorManager1).length;
                    const m2Buys = this.movements.filter(m => m.type === 'transfer' && m.buyer === this.comparatorManager2).length;
                    const m2Sales = this.movements.filter(m => m.type === 'transfer' && m.seller === this.comparatorManager2).length;

                    return {
                        m1: {
                            name: this.comparatorManager1,
                            balance: m1.balance,
                            teamValue: m1.teamValue,
                            patrimony: m1.balance + m1.teamValue,
                            clauses: m1.clauseExpenses,
                            buys: m1Buys,
                            sales: m1Sales
                        },
                        m2: {
                            name: this.comparatorManager2,
                            balance: m2.balance,
                            teamValue: m2.teamValue,
                            patrimony: m2.balance + m2.teamValue,
                            clauses: m2.clauseExpenses,
                            buys: m2Buys,
                            sales: m2Sales
                        }
                    };
                },

                // REMOVE DUPLICATE MOVEMENTS (ROBUST)
                parseDate(dateStr) {
                    if (!dateStr || dateStr === 'Sin fecha' || dateStr === 'NODATE') return 0;
                    const parts = dateStr.split(' ')[0].split('/');
                    if (parts.length === 3) {
                        return new Date(parseInt(parts[2]), parseInt(parts[1]) - 1, parseInt(parts[0])).getTime();
                    }
                    return 0;
                },

                isDuplicate(m1, m2) {
                    if (m1.player !== m2.player) return false;
                    if (m1.buyer !== m2.buyer) return false;
                    if (m1.seller !== m2.seller) return false;
                    if (parseInt(m1.amount) !== parseInt(m2.amount)) return false;

                    const t1 = this.parseDate(m1.date);
                    const t2 = this.parseDate(m2.date);
                    // 24 hours tolerance (86400000 ms)
                    return Math.abs(t1 - t2) <= 86400000;
                },

                removeDuplicates() {
                    const unique = [];
                    const duplicates = [];

                    // Sort by date desc to keep most recent versions preferred? 
                    // Actually we iterate and check if we already have a match.
                    // O(N^2) is bad for 3000 items (9M ops). 
                    // Optimization: Group by player+amount signature?

                    const signatureMap = new Map();

                    this.movements.forEach(mov => {
                        const sig = `${mov.player}_${mov.amount}`;
                        if (!signatureMap.has(sig)) {
                            signatureMap.set(sig, []);
                        }

                        // Check against potential duplicates in same signature group
                        const potentials = signatureMap.get(sig);
                        const isDup = potentials.some(existing => this.isDuplicate(mov, existing));

                        if (!isDup) {
                            potentials.push(mov);
                            unique.push(mov);
                        } else {
                            duplicates.push(mov);
                        }
                    });

                    if (duplicates.length > 0) {
                        this.movements = unique;
                        this.saveData();
                        this.addLog(`üßπ Eliminados ${duplicates.length} duplicados (Robusto)`, 'success');
                    } else {
                        this.addLog('‚úì No se encontraron duplicados', 'info');
                    }
                },

                // RESET DATA
                async resetData() {
                    if (!confirm('¬øEst√°s seguro de que quieres borrar todo y restablecer los datos originales? Esta acci√≥n no se puede deshacer.')) return;

                    this.movements = [];
                    this.pendingMovements = [];
                    this.marketData = {};
                    this.addLog('üßπ Datos borrados. Iniciando restablecimiento...', 'info');

                    // Use DEFAULT_MOVEMENTS from movements_data.js
                    if (typeof DEFAULT_MOVEMENTS !== 'undefined') {
                        this.rawInput = DEFAULT_MOVEMENTS;
                        this.processInput();
                        this.confirmImport();
                        this.addLog('‚úÖ Datos restablecidos correctamente desde archivo original.', 'success');
                    } else {
                        this.addLog('‚ö†Ô∏è No se encontr√≥ DEFAULT_MOVEMENTS.', 'error');
                    }
                    this.saveData();
                },

                // CSV EXPORT
                exportMovementsCSV() {
                    const headers = ['Fecha', 'Tipo', 'Jugador', 'Comprador', 'Vendedor', 'Cantidad'];
                    const rows = this.movements.map(m => [
                        m.date || '',
                        m.type || '',
                        m.player || '',
                        m.buyer || '',
                        m.seller || '',
                        m.amount || ''
                    ]);
                    this.downloadCSV('movimientos.csv', headers, rows);
                },

                exportWatchlistCSV() {
                    const headers = ['Jugador', 'Valor', 'Posici√≥n', 'Puntos', 'PPM', 'Cambio ‚Ç¨', 'Cambio %'];
                    const rows = this.watchlist.map(name => {
                        const value = this.marketData[name] || 0;
                        const info = (typeof MARKET_INFO !== 'undefined' && MARKET_INFO[name]) || {};
                        const trend = (typeof MARKET_TRENDS !== 'undefined' && MARKET_TRENDS[name]) || {};
                        return [
                            name,
                            value,
                            info.position || '',
                            info.points || 0,
                            ((info.points || 0) / (value / 1000000)).toFixed(2),
                            trend.trend || 0,
                            (trend.trendPct || 0).toFixed(2) + '%'
                        ];
                    });
                    this.downloadCSV('watchlist.csv', headers, rows);
                },

                downloadCSV(filename, headers, rows) {
                    const csvContent = [headers.join(';'), ...rows.map(r => r.join(';'))].join('\n');
                    const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = filename;
                    link.click();
                    this.addLog(`üìÅ Exportado: ${filename}`, 'success');
                },

                // CALCS
                calculateTotalBalance() {
                    return Object.values(this.managers).reduce((acc, m) => acc + m.balance, 0);
                },
                calculateTotalTeamValue() {
                    return Object.values(this.managers).reduce((acc, m) => acc + m.teamValue, 0);
                },
                calculateTotalClauses() {
                    return Object.values(this.managers).reduce((acc, m) => acc + m.clauseExpenses, 0);
                },
                calculateMaxBid(manager) {
                    // Formula: Saldo + (ValorEquipo * 0.20)
                    return manager.balance + (manager.teamValue * 0.20);
                },

                // ===== ANALYTICS FUNCTIONS =====

                // Detect bidding pattern from an amount
                detectBidPattern(amount) {
                    const amountStr = String(amount);
                    const lastDigits = amount % 1000000;
                    const last4 = amount % 10000;
                    const last3 = amount % 1000;

                    // +1 pattern (ends in 001, 01, 1)
                    if (lastDigits === 1 || last4 === 1 || last3 === 1) return 'plusOne';

                    // Round number (ends in multiple zeros)
                    if (amount % 1000000 === 0) return 'roundMillion';
                    if (amount % 100000 === 0) return 'roundHundredK';
                    if (amount % 10000 === 0) return 'roundTenK';

                    // Custom/specific patterns
                    if (amountStr.endsWith('555') || amountStr.endsWith('999')) return 'repeating';

                    return 'custom';
                },

                // Calculate spread percentage
                calculateSpread(purchasePrice, marketValue) {
                    if (!marketValue || marketValue === 0) return 0;
                    return ((purchasePrice - marketValue) / marketValue) * 100;
                },

                // Rebuild full analytics from movements
                rebuildManagerAnalytics() {
                    const analytics = {};
                    const managerNames = Object.keys(this.managers);

                    // Initialize analytics for each manager
                    managerNames.forEach(name => {
                        analytics[name] = {
                            purchases: [],
                            sales: [],
                            avgSpread: 0,
                            spreadByPosition: { PT: [], DF: [], MD: [], DL: [] },
                            patterns: { plusOne: 0, roundMillion: 0, roundHundredK: 0, roundTenK: 0, repeating: 0, custom: 0 },
                            holdingPeriods: [],
                            panicSales: 0, // "Weak hands" indicator
                            needMap: { PT: 0, DF: 0, MD: 0, DL: 0 }
                        };
                    });

                    // First pass: collect all purchases with their market values
                    const purchasesByPlayer = {}; // Track original purchase for ROI

                    this.movements.filter(m => m.type === 'transfer' && m.buyer !== 'LALIGA').forEach(mov => {
                        const buyer = mov.buyer;
                        if (!analytics[buyer]) return;

                        const player = mov.player;
                        const purchasePrice = parseInt(mov.amount);

                        // Get market value at time of purchase (use current as approximation)
                        const marketValue = this.marketData[player] || 0;
                        const position = (typeof MARKET_INFO !== 'undefined' && MARKET_INFO[player])
                            ? MARKET_INFO[player].position : 'MD';

                        // Calculate spread
                        const spread = this.calculateSpread(purchasePrice, marketValue);

                        // Detect pattern
                        const pattern = this.detectBidPattern(purchasePrice);

                        // Store purchase
                        const purchaseRecord = {
                            player,
                            price: purchasePrice,
                            marketValue,
                            spread,
                            position,
                            pattern,
                            date: mov.date,
                            seller: mov.seller
                        };

                        analytics[buyer].purchases.push(purchaseRecord);
                        analytics[buyer].patterns[pattern]++;

                        if (position && analytics[buyer].spreadByPosition[position]) {
                            analytics[buyer].spreadByPosition[position].push(spread);
                        }

                        // Track for ROI calculation
                        if (!purchasesByPlayer[player]) purchasesByPlayer[player] = [];
                        purchasesByPlayer[player].push({ buyer, price: purchasePrice, date: mov.date });
                    });

                    // Second pass: calculate averages
                    managerNames.forEach(name => {
                        const mgr = analytics[name];

                        // Average spread
                        if (mgr.purchases.length > 0) {
                            const totalSpread = mgr.purchases.reduce((sum, p) => sum + p.spread, 0);
                            mgr.avgSpread = totalSpread / mgr.purchases.length;
                        }

                        // Average spread by position
                        Object.keys(mgr.spreadByPosition).forEach(pos => {
                            const spreads = mgr.spreadByPosition[pos];
                            mgr.spreadByPosition[pos] = spreads.length > 0
                                ? spreads.reduce((a, b) => a + b, 0) / spreads.length
                                : 0;
                        });

                        // Calculate dominant pattern
                        const patternCounts = mgr.patterns;
                        mgr.dominantPattern = Object.entries(patternCounts)
                            .sort((a, b) => b[1] - a[1])[0]?.[0] || 'custom';
                        mgr.dominantPatternPct = mgr.purchases.length > 0
                            ? (patternCounts[mgr.dominantPattern] / mgr.purchases.length) * 100
                            : 0;
                    });

                    // Calculate Need Map using tradingHistory rosters
                    if (Object.keys(this.tradingHistory.rosters).length === 0) {
                        this.reconstructTradingHistory();
                    }

                    const idealSquad = { PT: 2, DF: 5, MD: 5, DL: 3 };

                    managerNames.forEach(name => {
                        const roster = this.tradingHistory.rosters[name] || {};
                        const positionCounts = { PT: 0, DF: 0, MD: 0, DL: 0 };

                        Object.keys(roster).forEach(player => {
                            const pos = (typeof MARKET_INFO !== 'undefined' && MARKET_INFO[player])
                                ? MARKET_INFO[player].position : 'MD';
                            if (positionCounts[pos] !== undefined) {
                                positionCounts[pos]++;
                            }
                        });

                        // Calculate need as percentage (100% = completely missing)
                        analytics[name].needMap = {
                            PT: Math.max(0, (1 - positionCounts.PT / idealSquad.PT) * 100),
                            DF: Math.max(0, (1 - positionCounts.DF / idealSquad.DF) * 100),
                            MD: Math.max(0, (1 - positionCounts.MD / idealSquad.MD) * 100),
                            DL: Math.max(0, (1 - positionCounts.DL / idealSquad.DL) * 100)
                        };

                        analytics[name].squadSize = Object.keys(roster).length;
                    });

                    this.managerAnalytics = analytics;
                    return analytics;
                },

                // Get analytics for a specific manager (with lazy rebuild)
                getManagerAnalytics(managerName) {
                    if (!this.managerAnalytics[managerName] ||
                        !this.managerAnalytics[managerName].purchases) {
                        this.rebuildManagerAnalytics();
                    }
                    return this.managerAnalytics[managerName] || {
                        purchases: [],
                        avgSpread: 0,
                        spreadByPosition: { PT: 0, DF: 0, MD: 0, DL: 0 },
                        patterns: {},
                        needMap: { PT: 0, DF: 0, MD: 0, DL: 0 }
                    };
                },

                // Get bid recommendation for a player
                getBidRecommendation(player, marketValue) {
                    // Find managers with enough balance to compete
                    const competitors = this.sortedManagers.filter(m =>
                        this.calculateMaxBid(m) > marketValue && m.name !== 'LALIGA'
                    );

                    if (competitors.length === 0) {
                        return {
                            recommendedBid: marketValue + 1,
                            reason: 'Sin competencia - puja m√≠nima'
                        };
                    }

                    // Find highest typical spread among competitors
                    let maxSpread = 0;
                    let topCompetitor = '';

                    competitors.forEach(comp => {
                        const analytics = this.getManagerAnalytics(comp.name);
                        const position = (typeof MARKET_INFO !== 'undefined' && MARKET_INFO[player])
                            ? MARKET_INFO[player].position : 'MD';
                        const posSpread = analytics.spreadByPosition[position] || analytics.avgSpread;

                        if (posSpread > maxSpread) {
                            maxSpread = posSpread;
                            topCompetitor = comp.name;
                        }
                    });

                    const recommendedBid = Math.ceil(marketValue * (1 + (maxSpread + 1) / 100));

                    return {
                        recommendedBid,
                        competitor: topCompetitor,
                        competitorSpread: maxSpread,
                        reason: `${topCompetitor} puja +${maxSpread.toFixed(1)}% en esta posici√≥n`
                    };
                },

                get sortedManagers() {
                    // ‚ö° OPTIMIZADO: Calcular todos los balances en UNA SOLA pasada O(n)
                    // en lugar de O(n*m) que bloqueaba el navegador

                    // Inicializar balances con presupuesto inicial - cl√°usulas
                    const balances = {};
                    Object.values(this.managers).forEach(m => {
                        balances[m.name] = m.initialBudget - m.clauseExpenses;
                    });

                    // Una sola pasada por todos los movimientos
                    this.movements.forEach(mov => {
                        if (mov.type === 'transfer') {
                            if (balances[mov.buyer] !== undefined) balances[mov.buyer] -= mov.amount;
                            if (balances[mov.seller] !== undefined) balances[mov.seller] += mov.amount;
                        } else if (mov.type === 'reward' && balances[mov.beneficiary] !== undefined) {
                            balances[mov.beneficiary] += mov.amount;
                        }
                    });

                    // Crear array con balances calculados
                    const computedManagers = Object.values(this.managers).map(m => ({
                        ...m,
                        balance: balances[m.name] || 0
                    }));

                    // Ordenar por patrimonio (balance + teamValue)
                    return computedManagers.sort((a, b) => (b.balance + b.teamValue) - (a.balance + a.teamValue));
                },

                get advancedStats() {
                    let s = {
                        totalSpent: 0, totalIncome: 0,
                        opsTotal: 0, opsLiga: 0, opsInter: 0,
                        maxTransfer: { p: '-', a: 0 }, maxSale: { p: '-', a: 0 },
                        playerCounts: {}, managerStats: {},
                        rewardsJ: 0, rewards11: 0
                    };

                    // Init managers stats
                    Object.keys(this.managers).forEach(k => s.managerStats[k] = { buy: 0, sell: 0, ops: 0, rewards: 0 });

                    this.movements.forEach(m => {
                        if (m.type === 'transfer') {
                            s.opsTotal++;
                            if (m.buyer === 'LALIGA' || m.seller === 'LALIGA') s.opsLiga++;
                            else s.opsInter++;

                            if (m.buyer !== 'LALIGA') {
                                s.totalSpent += m.amount;
                                if (s.managerStats[m.buyer]) { s.managerStats[m.buyer].buy += m.amount; s.managerStats[m.buyer].ops++; }
                            }
                            if (m.seller !== 'LALIGA') {
                                s.totalIncome += m.amount;
                                if (s.managerStats[m.seller]) { s.managerStats[m.seller].sell += m.amount; s.managerStats[m.seller].ops++; }
                            }

                            // Max Records
                            if (m.amount > s.maxTransfer.a && m.buyer !== 'LALIGA') s.maxTransfer = { p: m.player, a: m.amount, m: m.buyer };
                            if (m.amount > s.maxSale.a && m.seller !== 'LALIGA') s.maxSale = { p: m.player, a: m.amount, m: m.seller };

                            // Player popularity
                            s.playerCounts[m.player] = (s.playerCounts[m.player] || 0) + 1;

                        } else if (m.type === 'reward') {
                            if (m.subtype === 'jornada') s.rewardsJ += m.amount;
                            if (m.subtype === '11ideal') s.rewards11 += m.amount;
                            if (s.managerStats[m.beneficiary]) s.managerStats[m.beneficiary].rewards += m.amount;
                        }
                    });

                    // Calculated Stats
                    const sortedManagersBySpent = Object.entries(s.managerStats).sort((a, b) => b[1].buy - a[1].buy);
                    const sortedManagersByIncome = Object.entries(s.managerStats).sort((a, b) => b[1].sell - a[1].sell);
                    const sortedPlayers = Object.entries(s.playerCounts).sort((a, b) => b[1] - a[1]);
                    const mostActiveManager = Object.entries(s.managerStats).sort((a, b) => b[1].ops - a[1].ops)[0];

                    // Profit/Loss Analysis (Simplified: Sold Price - Bought Price for same player same manager?)
                    // Too complex for flat list without tracking ownership. Using general aggregates.

                    return [
                        // BLOQUE 1: MACROECONOMIA
                        { label: 'Volumen Total Mercado', val: this.formatMoney(s.totalSpent + s.totalIncome), c: 'text-white' },
                        { label: 'Gasto Total Managers', val: this.formatMoney(s.totalSpent), c: 'text-red-400' },
                        { label: 'Ingresos Totales', val: this.formatMoney(s.totalIncome), c: 'text-green-400' },
                        { label: 'Balance Neto Global', val: this.formatMoney(s.totalIncome - s.totalSpent), c: 'text-blue-400' },

                        // BLOQUE 2: OPERATIVA
                        { label: 'Total Operaciones', val: s.opsTotal, c: 'text-white' },
                        { label: 'Ops con LALIGA', val: s.opsLiga, c: 'text-gray-400' },
                        { label: 'Ops entre Managers', val: s.opsInter, c: 'text-neon-pink' },
                        { label: 'Jugador M√°s Trasmferido', val: sortedPlayers[0] ? `${sortedPlayers[0][0]} (${sortedPlayers[0][1]})` : '-', c: 'text-yellow-300' },

                        // BLOQUE 3: RECORDS
                        { label: 'Fichaje M√°s Caro', val: this.formatMoney(s.maxTransfer.a), sub: s.maxTransfer.p, c: 'text-neon-green' },
                        { label: 'Venta M√°s Cara', val: this.formatMoney(s.maxSale.a), sub: s.maxSale.p, c: 'text-neon-blue' },
                        { label: 'Media Gasto/Fichaje', val: this.formatMoney(s.opsTotal ? s.totalSpent / s.opsTotal : 0), c: 'text-gray-300' },
                        { label: 'Gasto en Cl√°usulas', val: this.formatMoney(this.calculateTotalClauses()), c: 'text-neon-purple' },

                        // BLOQUE 4: RANKING MANAGERS
                        { label: 'Mayor Comprador', val: sortedManagersBySpent[0]?.[0] || '-', sub: this.formatMoney(sortedManagersBySpent[0]?.[1].buy || 0), c: 'text-red-300' },
                        { label: 'Mayor Vendedor', val: sortedManagersByIncome[0]?.[0] || '-', sub: this.formatMoney(sortedManagersByIncome[0]?.[1].sell || 0), c: 'text-green-300' },
                        { label: 'Manager M√°s Activo', val: mostActiveManager?.[0] || '-', sub: `${mostActiveManager?.[1].ops || 0} ops`, c: 'text-blue-300' },
                        { label: 'Menor Gasto', val: sortedManagersBySpent[sortedManagersBySpent.length - 1]?.[0] || '-', sub: this.formatMoney(sortedManagersBySpent[sortedManagersBySpent.length - 1]?.[1].buy || 0), c: 'text-gray-400' },

                        // BLOQUE 5: PREMIOS
                        { label: 'Total Premios Jornada', val: this.formatMoney(s.rewardsJ), c: 'text-yellow-400' },
                        { label: 'Total Premios 11 Ideal', val: this.formatMoney(s.rewards11), c: 'text-yellow-200' },
                        { label: 'Ratio Inversi√≥n/Valor', val: ((s.totalSpent / this.calculateTotalTeamValue()) * 100).toFixed(1) + '%', c: 'text-gray-400' },
                        { label: 'Liquidez del Sistema', val: ((this.calculateTotalBalance() / (this.calculateTotalBalance() + this.calculateTotalTeamValue())) * 100).toFixed(1) + '%', c: 'text-gray-400' },

                        // RANDOM / CURIOSITIES
                        { label: 'Ticket Medio Venta', val: this.formatMoney(s.opsTotal ? s.totalIncome / s.opsTotal : 0), c: 'text-gray-500' },
                        { label: 'Fichaje Record (Manager)', val: s.maxTransfer.m, c: 'text-xs text-gray-400' },
                        { label: 'Venta Record (Manager)', val: s.maxSale.m, c: 'text-xs text-gray-400' },
                        { label: 'Total Movimientos', val: this.movements.length, c: 'text-white' }
                    ];
                },

                getTopTransfers() {
                    return this.movements
                        .filter(m => m.type === 'transfer')
                        .sort((a, b) => b.amount - a.amount)
                        .slice(0, 50);
                },

                getTotalMovements() {
                    return this.movements.length;
                },

                // FILE IMPORT
                importFromFile(event) {
                    const file = event.target.files[0];
                    if (!file) return;

                    if (!file.name.endsWith('.txt')) {
                        this.addLog('Error: Solo se permiten archivos .txt', 'warning');
                        return;
                    }

                    this.addLog(`Leyendo archivo: ${file.name}...`, 'info');

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const content = e.target.result;
                        const lineCount = content.split('\n').length;
                        this.addLog(`Archivo cargado: ${lineCount} l√≠neas`, 'success');

                        // Poner contenido en el textarea y procesarlo
                        this.rawInput = content;
                        this.processInput();
                    };
                    reader.onerror = () => {
                        this.addLog('Error al leer el archivo', 'warning');
                    };
                    reader.readAsText(file, 'UTF-8');

                    // Reset input para permitir reimportar mismo archivo
                    event.target.value = '';
                },

                // DATA PROCESSING
                parseMarketData(htmlContent) {
                    try {
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(htmlContent, 'text/html');
                        // Strategy: Look for specific class structures
                        // Cards usually share a common class or structure. 
                        // We found names in 'MuiTypography-body2' and price in 'MuiTypography-body1'.

                        const nameNodes = Array.from(doc.querySelectorAll('p[class*="MuiTypography-body2"]'));
                        let updatedCount = 0;

                        nameNodes.forEach(node => {
                            const name = node.textContent.trim();
                            // Value is usually in the NEXT sibling container or similar structure.
                            // Looking at the provided HTML structure:
                            // Name is inside a div.
                            // Market Value is inside the same parent container, usually a <p> with body1 class coming AFTER the name div.

                            // Traverse up to the card container might be safer, but let's try finding the next body1.
                            // The HTML showed: <div>...<p name>...</div> <p value>...

                            // Attempt to find value node in proximity
                            // We can use a Regex on the `innerHTML` of the parent card to be safer if DOM traversal is tricky.
                            // But let's try DOM traversal:
                            // Go up to the card wrapper (usually contains the image, name, values)
                            let cardParams = node.closest('div.MuiBox-root.css-1j0r1in') || node.parentElement.parentElement;

                            if (cardParams) {
                                const valueNode = cardParams.querySelector('p[class*="MuiTypography-body1"]');
                                if (valueNode) {
                                    const valStr = valueNode.textContent.replace(/[‚Ç¨\.]/g, '').trim();
                                    const val = parseInt(valStr);
                                    if (!isNaN(val)) {
                                        this.marketData[name] = val;
                                        updatedCount++;
                                    }
                                }
                            }
                        });

                        this.addLog(`Mercado actualizado: ${updatedCount} jugadores.`, 'success');
                        this.debouncedSaveData();
                        this.debouncedUpdateCharts(); // Recalc stats

                    } catch (e) {
                        console.error(e);
                        this.addLog('Error analizando HTML de mercado', 'error');
                        // Fallback to Regex if DOM fails?
                        this.parseMarketDataRegex(htmlContent);
                    }
                },

                parseMarketDataRegex(text) {
                    // Fallback Regex
                    const parts = text.split('class="MuiBox-root css-1j0r1in"');
                    let count = 0;
                    parts.forEach(part => {
                        const nameMatch = part.match(/MuiTypography-body2[^>]*>\s*([^<]+)<\/p>/);
                        const valMatch = part.match(/MuiTypography-body1[^>]*>\s*([\d\.]+) ‚Ç¨<\/p>/);

                        if (nameMatch && valMatch) {
                            const name = nameMatch[1].trim();
                            const val = parseInt(valMatch[1].replace(/\./g, ''));
                            this.marketData[name] = val;
                            count++;
                        }
                    });
                    if (count > 0) this.addLog(`Mercado actualizado (Regex): ${count} jugadores.`, 'success');
                },

                // Parse team values from PFSY format
                parseTeamValues(text) {
                    const managerNames = Object.keys(this.managers);
                    let updatedCount = 0;

                    // Clean and split text
                    const lines = text.split('\n').map(l => l.trim()).filter(l => l);

                    // Find each manager and extract their team value
                    managerNames.forEach(managerName => {
                        // Find the line with this manager (partial match)
                        const managerIdx = lines.findIndex(l =>
                            managerName.toLowerCase().includes(l.toLowerCase()) ||
                            l.toLowerCase().includes(managerName.split(' ')[0].toLowerCase())
                        );

                        if (managerIdx === -1) return;

                        // Look for a value in nearby lines (within next 5 lines)
                        for (let i = managerIdx; i < Math.min(managerIdx + 6, lines.length); i++) {
                            const line = lines[i];
                            // Look for large numbers (team values are 100M+)
                            // Format: 654.648.354 or 654,648,354 or just digits
                            const valueMatch = line.match(/^[\d‚Ç¨\s\.,]+$/);
                            if (valueMatch) {
                                const cleanValue = line.replace(/[‚Ç¨\s\.]/g, '').replace(',', '.');
                                const value = parseInt(cleanValue);
                                if (value > 10000000) { // More than 10M = likely team value
                                    this.managers[managerName].teamValue = value;
                                    updatedCount++;
                                    break;
                                }
                            }
                        }
                    });

                    if (updatedCount > 0) {
                        this.addLog(`‚úÖ Valores de equipo actualizados: ${updatedCount} managers`, 'success');
                        this.saveData();
                        this.rawInput = '';
                    } else {
                        this.addLog('‚ö†Ô∏è No se encontraron valores de equipo v√°lidos', 'warning');
                    }
                },

                processInput() {
                    const text = this.rawInput;
                    if (!text.trim()) return;

                    const startTime = performance.now();
                    let addedCount = 0;

                    // ‚ö° DETECCI√ìN HTML (Mercado)
                    if (text.includes('<html') || text.includes('MuiTypography') || text.includes('__NEXT_DATA__')) {
                        this.parseMarketData(text);
                        return;
                    }

                    // ‚ö° DETECCI√ìN VALORES DE EQUIPO (formato PFSY)
                    if (text.includes('PFSY') && (text.includes('Alcatamy') || text.includes('Vigar') || text.includes('GOLENCIERRO') || text.includes('Pablinistan') || text.includes('Morenazos') || text.includes('Manga'))) {
                        this.parseTeamValues(text);
                        return;
                    }

                    // ‚ö° OPTIMIZACI√ìN: Build signature map for efficient duplicate checking
                    // Signature: player_amount (since these are most distinguishing factors usually)
                    const existingSignatureMap = new Map();
                    this.movements.forEach(m => {
                        const sig = `${m.player}_${m.amount}`;
                        if (!existingSignatureMap.has(sig)) existingSignatureMap.set(sig, []);
                        existingSignatureMap.get(sig).push(m);
                    });

                    const pendingIds = new Set(this.pendingMovements.map(m => m.id));

                    const lines = text.split('\n');
                    let tempDate = null;

                    const reSmartFormat = /^\[([^\]]+)\] (.+)/;
                    const reDate = /(\d{2}\/\d{2}\/\d{4})/;
                    const reTransfer = /(.+?) ha (comprado|vendido) al jugador (.+?) (?:de|a) (.+?) por ([\d\.]+)[‚Ç¨]?/;
                    const reShield = /(.+?) ha blindado a (.+)/i;
                    const reRewardJornada = /En la jornada (\d+), (.+?) ha ganado ([\d\.]+)[‚Ç¨]?/i;
                    const reReward11 = /(.+?) ha ganado ([\d\.]+)[‚Ç¨]? por tener.+11 ideal/i;

                    const normalizeDate = (dateStr) => {
                        if (!dateStr || dateStr === 'NODATE') return 'Sin fecha';
                        const today = new Date();
                        const dd = (d) => String(d.getDate()).padStart(2, '0');
                        const mm = (d) => String(d.getMonth() + 1).padStart(2, '0');
                        const yyyy = (d) => d.getFullYear();
                        const formatDate = (d) => `${dd(d)}/${mm(d)}/${yyyy(d)}`;
                        if (/^\d{1,2}:\d{2}$/.test(dateStr)) return `${formatDate(today)} ${dateStr}`;
                        if (/^\d{2}\/\d{2}\/\d{4}/.test(dateStr)) return dateStr;
                        if (/^ayer$/i.test(dateStr.trim())) {
                            const yesterday = new Date(today);
                            yesterday.setDate(today.getDate() - 1);
                            return formatDate(yesterday);
                        }
                        const haceDiasMatch = dateStr.match(/hace\s+(\d+)\s+d[i√≠]as?/i);
                        if (haceDiasMatch) {
                            const daysAgo = parseInt(haceDiasMatch[1]);
                            const pastDate = new Date(today);
                            pastDate.setDate(today.getDate() - daysAgo);
                            return formatDate(pastDate);
                        }
                        if (/hace\s+\d+\s+horas?/i.test(dateStr)) return formatDate(today);
                        return dateStr;
                    };

                    lines.forEach((line, index) => {
                        line = line.trim();
                        if (!line || line.startsWith('#') || line.startsWith('---')) return;

                        let currentDateForLine = tempDate;
                        let textToParse = line;

                        const smartMatch = line.match(reSmartFormat);
                        if (smartMatch) {
                            currentDateForLine = smartMatch[1].trim();
                            textToParse = smartMatch[2];
                        } else if (reDate.test(line)) {
                            tempDate = line.match(reDate)[1];
                            return;
                        }

                        const dateKey = currentDateForLine || tempDate || 'NODATE';

                        // 1. Transferencias
                        let match = textToParse.match(reTransfer);
                        if (match) {
                            const [_, actor, action, player, otherParty, amountStr] = match;
                            const amount = parseInt(amountStr.replace(/\./g, ''));
                            const buyer = action === 'comprado' ? actor.trim() : otherParty.trim();
                            const seller = action === 'comprado' ? otherParty.trim() : actor.trim();
                            const normalizedDateForId = normalizeDate(dateKey);

                            const newMov = {
                                id: `transfer_${normalizedDateForId}_${buyer}_${seller}_${player}_${amount}`,
                                type: 'transfer',
                                buyer,
                                seller,
                                player,
                                amount,
                                date: normalizedDateForId
                            };

                            // Duplicate Check (Robust)
                            const sig = `${player}_${amount}`;
                            const potentials = existingSignatureMap.get(sig);
                            let isDup = false;

                            if (potentials) {
                                isDup = potentials.some(existing => this.isDuplicate(newMov, existing));
                            }

                            if (!isDup && !pendingIds.has(newMov.id)) {
                                pendingIds.add(newMov.id);
                                this.pendingMovements.push(newMov);

                                // Update map locally to catch dups within same import
                                if (!existingSignatureMap.has(sig)) existingSignatureMap.set(sig, []);
                                existingSignatureMap.get(sig).push(newMov);
                            }
                            return;
                        }

                        // Pass-through simpler logic for other types (less prone to fuzzy dupes)
                        // ... (Logic for shields/rewards kept similar but reusing robust flow if needed)
                        // For brevity, keeping simplest ID check for non-transfers or using same loop style?
                        // Let's copy the original block for 2,3,4 but normalized

                        // 2. Blindajes
                        match = textToParse.match(reShield);
                        if (match) {
                            const [_, manager, player] = match;
                            const normalizedDateForId = normalizeDate(dateKey);
                            const id = `shield_${normalizedDateForId}_${manager.trim()}_${player.trim()}`;
                            if (!pendingIds.has(id)) { // Simplistic check for shields ok
                                pendingIds.add(id);
                                this.pendingMovements.push({
                                    id, type: 'shield', beneficiary: manager.trim(), player: player.trim(), amount: 0, details: 'Blindaje', date: normalizedDateForId
                                });
                            }
                            return;
                        }

                        // 3. Premios Jornada
                        match = textToParse.match(reRewardJornada);
                        if (match) {
                            const [_, jornada, beneficiary, amountStr] = match;
                            const amount = parseInt(amountStr.replace(/\./g, ''));
                            const id = `reward_jor${jornada}_${beneficiary.trim()}`;
                            if (!pendingIds.has(id)) {
                                pendingIds.add(id);
                                this.pendingMovements.push({
                                    id, type: 'reward', subtype: 'jornada', beneficiary: beneficiary.trim(), amount, details: `Jornada ${jornada}`, date: normalizeDate(dateKey)
                                });
                            }
                            return;
                        }

                        // 4. Premios 11 Ideal
                        match = textToParse.match(reReward11);
                        if (match) {
                            const [_, beneficiary, amountStr] = match;
                            const amount = parseInt(amountStr.replace(/\./g, ''));
                            const normalizedDateForId = normalizeDate(dateKey);
                            const id = `reward_11_${beneficiary.trim()}_${normalizedDateForId}_${amount}`;
                            if (!pendingIds.has(id)) {
                                pendingIds.add(id);
                                this.pendingMovements.push({
                                    id, type: 'reward', subtype: '11ideal', beneficiary: beneficiary.trim(), amount, details: '11 Ideal', date: normalizedDateForId
                                });
                            }
                            return;
                        }
                    });

                    const elapsed = (performance.now() - startTime).toFixed(0);

                    if (this.pendingMovements.length > 0) {
                        this.addLog(`‚ö° ${this.pendingMovements.length} movimientos en ${elapsed}ms. Revisa la tabla.`, 'info');
                    } else if (addedCount > 0) {
                        this.addLog(`Valores de equipo actualizados.`, 'success');
                        this.rawInput = '';
                    } else {
                        this.addLog(`No se detectaron movimientos nuevos (${elapsed}ms).`, 'warning');
                    }
                },

                confirmImport() {
                    const startTime = performance.now();

                    // ‚ö° OPTIMIZACI√ìN: Batch insert con Map para O(1) lookups
                    const existingMap = new Map(this.movements.map(m => [m.id, m]));
                    let newCount = 0;
                    let updatedCount = 0;

                    // Reverse loop or unshift to keep order from parsed, but ensuring newest are at top?
                    // Pending movements are in parsed order (Top to Bottom of text). 
                    // Usually text is Newest First or Oldest First?
                    // movimientos_smart.txt has newest at top.
                    // So we should iterate pendingMovements in reverse if we want oldest processed first?
                    // Or iterate normal and unshift so the first (newest) ends up at top of movements?

                    // If we unshift:
                    // input: [A, B, C] (A is newest)
                    // 1. unshift A -> [A, ...]
                    // 2. unshift B -> [B, A, ...] 
                    // Wait, that puts B above A.
                    // If A is newest, and we want newest at top (index 0).
                    // We should iterate pending [A, B, C] in REVERSE: C, B, A.
                    // C -> [C]
                    // B -> [B, C]
                    // A -> [A, B, C]
                    // Correct.

                    const toAdd = [];
                    this.pendingMovements.forEach(mov => {
                        // Double check duplicate logic before final add
                        // (Already done in processInput but good to be safe)
                        const existing = existingMap.get(mov.id);
                        if (!existing) {
                            toAdd.push(mov);
                        } else if (mov.date.includes('/') && !existing.date.includes('/')) {
                            existing.date = mov.date;
                            updatedCount++;
                        }
                    });

                    // Add new ones to top in reverse order of the array (since array is likely newest first)
                    // If array is [Newest, ..., Oldest]
                    // We want: [Newest, ..., Oldest, Existing...]
                    // So we can just splicing them in at 0?
                    // this.movements.unshift(...toAdd);

                    // But if toAdd is [A, B, C] (A newest), spread unshift adds them as A, B, C at start?
                    // [].unshift(1, 2) -> [1, 2]
                    // So yes, unshift(...toAdd) keeps order of toAdd and puts at front.

                    if (toAdd.length > 0) {
                        this.movements.unshift(...toAdd);
                        newCount = toAdd.length;
                    }

                    const elapsed = (performance.now() - startTime).toFixed(0);
                    this.addLog(`‚ö° Importaci√≥n: ${newCount} nuevos, ${updatedCount} actualizados (${elapsed}ms)`, 'success');
                    this.pendingMovements = [];
                    this.rawInput = '';
                    this.saveData();
                },

                cancelImport() {
                    this.pendingMovements = [];
                    this.addLog('Importaci√≥n cancelada.', 'info');
                },

                addClauseExpense() {
                    const { manager, amount } = this.clauseForm;
                    if (manager && amount) {
                        if (this.managers[manager]) {
                            this.managers[manager].clauseExpenses += parseInt(amount);
                            this.addLog(`Gasto clausula a√±adido a ${manager}: -${amount}‚Ç¨`, 'success');
                            this.clauseForm.amount = '';
                        }
                    }
                },

                processClauseBulk() {
                    const lines = this.clauseBulkInput.split('\n');
                    let updated = 0;
                    lines.forEach(line => {
                        // Formato: "Equipo [TAB] 168.850.000 ‚Ç¨"
                        const parts = line.split('\t');
                        if (parts.length >= 2) {
                            const name = parts[0].trim();
                            const amountRaw = parts[1].replace(/[‚Ç¨\.\s]/g, '');
                            const amount = parseInt(amountRaw);

                            if (this.managers[name] && !isNaN(amount)) {
                                this.managers[name].clauseExpenses = amount;
                                this.addLog(`Cl√°usulas SET para ${name}: ${this.formatMoney(amount)}`, 'success');
                                updated++;
                            }
                        }
                    });
                    this.clauseBulkInput = '';

                    // Force immediate save to Firebase (don't rely on debounce)
                    if (updated > 0) {
                        this.saveData();
                        this.addLog(`‚úÖ ${updated} cl√°usulas guardadas en Firebase`, 'success');
                    }
                },

                // STORAGE
                // Sanitize keys for Firebase (no dots, special chars)
                sanitizeFirebaseKey(key) {
                    return key.replace(/[.#$\/\[\]]/g, '_')
                        .normalize('NFD').replace(/[\u0300-\u036f]/g, ''); // Remove accents
                },

                unsanitizeFirebaseKey(key) {
                    // This is a one-way operation, we can't fully reverse it
                    // but we store original keys in a separate lookup
                    return key;
                },

                saveData() {
                    // Set syncing status
                    this.syncStatus = 'syncing';

                    // Sanitize marketData keys for Firebase compatibility
                    const sanitizedMarketData = {};
                    Object.entries(this.marketData).forEach(([key, value]) => {
                        sanitizedMarketData[this.sanitizeFirebaseKey(key)] = value;
                    });

                    const data = {
                        managers: this.managers,
                        movements: this.movements,
                        marketData: sanitizedMarketData, // Sanitized keys
                        lastUpdate: Date.now()
                    };

                    if (db) {
                        db.ref('fantasy_data').set(data)
                            .then(() => {
                                console.log('Data saved to Firebase');
                                this.syncStatus = 'synced';
                            })
                            .catch(err => {
                                console.error('Firebase save error:', err);
                                this.syncStatus = 'error';
                            });
                    } else {
                        localStorage.setItem('fantasy_gameplay_data', JSON.stringify(data));
                        this.syncStatus = 'synced';
                    }
                },

                loadData() {
                    if (db) {
                        db.ref('fantasy_data').on('value', snapshot => {
                            const val = snapshot.val();
                            if (val) {
                                this.isRemoteUpdate = true; // Block watchers

                                // Load and Sanitize Managers
                                let loadedManagers = val.managers || {};
                                if (val.marketData) this.marketData = val.marketData; // Load dynamic market data

                                // Official allowed keys
                                const allowedKeys = ["Vigar FC", "GOLENCIERRO FC", "Pablinistan FC", "Alcatamy eSports By", "Visite La Manga FC", "Morenazos FC"];

                                // Merge logic: Copy ONLY allowed keys.
                                // Special migration: If Vigar24 exists but Vigar FC doesn't have data, migrate it?
                                // Better: Just accept Vigar FC if present. If user re-imports clauses, it will be fixed.

                                allowedKeys.forEach(key => {
                                    if (loadedManagers[key]) {
                                        this.managers[key] = loadedManagers[key];
                                    }
                                });

                                // Cleanup invalid keys (e.g. duplicate Alcatamy with spaces)
                                Object.keys(this.managers).forEach(k => {
                                    if (!allowedKeys.includes(k)) delete this.managers[k];
                                });

                                this.movements = val.movements || [];

                                // MIGRATE MOVEMENTS
                                let corrected = 0;
                                const nameMap = { 'Vigar24': 'Vigar FC' };
                                this.movements.forEach(m => {
                                    const proc = n => { if (!n) return n; let c = n.trim(); return nameMap[c] || c; };
                                    if (m.buyer) { let n = proc(m.buyer); if (n !== m.buyer) { m.buyer = n; corrected++; } }
                                    if (m.seller) { let n = proc(m.seller); if (n !== m.seller) { m.seller = n; corrected++; } }
                                    if (m.beneficiary) { let n = proc(m.beneficiary); if (n !== m.beneficiary) { m.beneficiary = n; corrected++; } }
                                });

                                // Allow watchers again after Alpine processes the change
                                this.$nextTick(() => {
                                    this.isRemoteUpdate = false;
                                    if (corrected > 0) this.saveData();
                                });

                                this.addLog(`Sincronizado con Firebase (${this.movements.length} movs). Datos limpiados.`, 'success');
                            }
                        });
                    } else {
                        const local = localStorage.getItem('fantasy_gameplay_data');
                        if (local) {
                            const data = JSON.parse(local);

                            // Sanitize LocalStorage
                            let loadedManagers = data.managers || {};
                            const allowedKeys = ["Vigar FC", "GOLENCIERRO FC", "Pablinistan FC", "Alcatamy eSports By", "Visite La Manga FC", "Morenazos FC"];

                            allowedKeys.forEach(key => {
                                if (loadedManagers[key]) {
                                    this.managers[key] = loadedManagers[key];
                                }
                            });
                            Object.keys(this.managers).forEach(k => {
                                if (!allowedKeys.includes(k)) delete this.managers[k];
                            });

                            this.movements = data.movements || [];

                            // MIGRATE MOVEMENTS (Local)
                            let corrected = 0;
                            const nameMap = { 'Vigar24': 'Vigar FC' };
                            this.movements.forEach(m => {
                                const proc = n => { if (!n) return n; let c = n.trim(); return nameMap[c] || c; };
                                if (m.buyer) { let n = proc(m.buyer); if (n !== m.buyer) { m.buyer = n; corrected++; } }
                                if (m.seller) { let n = proc(m.seller); if (n !== m.seller) { m.seller = n; corrected++; } }
                                if (m.beneficiary) { let n = proc(m.beneficiary); if (n !== m.beneficiary) { m.beneficiary = n; corrected++; } }
                            });
                            if (corrected > 0) this.saveData();

                            this.addLog('Datos cargados de LocalStorage (Limpios)', 'info');
                        }
                    }

                    // If movements are still empty after all loads, inject default history
                    if (this.movements.length === 0 && typeof DEFAULT_MOVEMENTS !== 'undefined') {
                        console.log("No movements found. Loading default history...");
                        this.processInput(DEFAULT_MOVEMENTS);
                        this.addLog('Hist√≥rico inicial cargado autom√°ticamente', 'info');
                    }

                    // Load market data from constants if local is empty
                    if (typeof MARKET_DATA !== 'undefined' && Object.keys(this.marketData).length === 0) {
                        this.marketData = MARKET_DATA;
                    }

                    this.reconstructTradingHistory();
                },

                // CHARTS
                // CHARTS
                parseDate(dateStr) {
                    // Formats: "DD/MM/YYYY", "DD/MM/YYYY HH:MM", "Sin fecha"
                    if (!dateStr || dateStr === 'Sin fecha') return new Date(0);

                    // Handle "Today HH:MM" which normalized looks like "DD/MM/YYYY HH:MM"
                    const [datePart, timePart] = dateStr.split(' ');
                    const [d, m, y] = datePart.split('/');

                    if (!d || !m || !y) return new Date(0);

                    const date = new Date(y, m - 1, d);
                    if (timePart) {
                        const [hh, mm] = timePart.split(':');
                        date.setHours(hh || 0, mm || 0);
                    }
                    return date;
                },

                updateCharts() {
                    const ctx = document.getElementById('patrimonyChart');
                    if (!ctx) return;

                    // 1. Sort movements chronologically
                    const sortedMovs = [...this.movements].sort((a, b) => {
                        return this.parseDate(a.date) - this.parseDate(b.date);
                    });

                    // 2. Replay History
                    const balances = {};
                    // Initialize with managers' initial budget settings
                    // NOTE: If movements are complete history, this works perfectly. 
                    // If partial, it shows relative change from base.
                    const initialBudgets = {};

                    // Colors mapping
                    const colors = {
                        "Vigar FC": '#00f3ff', // Neon Blue
                        "GOLENCIERRO FC": '#00ff9d', // Neon Green
                        "Pablinistan FC": '#ff00d4', // Neon Pink
                        "Alcatamy eSports By": '#bc13fe', // Neon Purple
                        "Visite La Manga FC": '#ffff00', // Yellow
                        "Morenazos FC": '#ff0000'  // Red
                    };

                    Object.keys(this.managers).forEach(k => {
                        balances[k] = this.managers[k].initialBudget;
                        initialBudgets[k] = this.managers[k].initialBudget;
                    });

                    const labels = [];
                    const datasets = Object.keys(this.managers).map(k => ({
                        label: k,
                        data: [], // {x, y}
                        borderColor: colors[k] || '#888',
                        backgroundColor: (colors[k] || '#888') + '20',
                        tension: 0.3,
                        borderWidth: 2,
                        pointRadius: 0 // Clean look
                    }));

                    // Add Start Point (Date 0 or First Movement Date - 1 day)
                    // Simplified: Start pushing data from first movement

                    let currentDateStr = '';

                    sortedMovs.forEach(m => {
                        // Apply Transaction
                        if (m.type === 'transfer') {
                            const amount = parseInt(m.amount);
                            if (balances[m.buyer] !== undefined) balances[m.buyer] -= amount;
                            if (balances[m.seller] !== undefined) balances[m.seller] += amount;
                        } else if (m.type === 'reward') {
                            const amount = parseInt(m.amount);
                            if (balances[m.beneficiary] !== undefined) balances[m.beneficiary] += amount;
                        }

                        // Store point only if date changes (Daily close)
                        const isoDate = this.parseDate(m.date).toLocaleDateString('es-ES'); // DD/MM/YYYY

                        if (isoDate !== currentDateStr) {
                            currentDateStr = isoDate;
                            labels.push(isoDate.substring(0, 5)); // "DD/MM"

                            // Push value for each dataset
                            datasets.forEach(ds => {
                                ds.data.push(balances[ds.label]);
                            });
                        } else {
                            // Update last point value if same day
                            datasets.forEach(ds => {
                                if (ds.data.length > 0) {
                                    ds.data[ds.data.length - 1] = balances[ds.label];
                                }
                            });
                        }
                    });

                    if (window.myChart) window.myChart.destroy();

                    window.myChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: datasets
                        },
                        options: {
                            responsive: true,
                            interaction: {
                                mode: 'index',
                                intersect: false,
                            },
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: { color: '#9ca3af', font: { size: 10 } }
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(17, 24, 39, 0.9)',
                                    titleColor: '#fff',
                                    bodyColor: '#ccc',
                                    borderColor: '#374151',
                                    borderWidth: 1,
                                    callbacks: {
                                        label: function (context) {
                                            let label = context.dataset.label || '';
                                            if (label) {
                                                label += ': ';
                                            }
                                            if (context.parsed.y !== null) {
                                                label += new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 }).format(context.parsed.y);
                                            }
                                            return label;
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    ticks: {
                                        color: '#6b7280',
                                        callback: function (value) { return (value / 1000000).toFixed(0) + 'M'; }
                                    },
                                    grid: { color: '#374151', drawBorder: false }
                                },
                                x: {
                                    ticks: { color: '#9ca3af', maxTicksLimit: 10 },
                                    grid: { display: false }
                                }
                            }
                        }
                    });
                }
            }
        }
    </script>
</body>

</html>