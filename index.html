<!DOCTYPE html>
<html lang="es" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fantasy Manager Pro</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Alpine.js -->
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Market Data -->
    <script src="market_data.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a;
            color: #e2e8f0;
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1e293b;
        }

        ::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }

        .glass-card {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 1rem;
        }

        .sidebar-link {
            transition: all 0.2s;
        }

        .sidebar-link:hover,
        .sidebar-link.active {
            background: rgba(59, 130, 246, 0.1);
            color: #60a5fa;
            border-right: 3px solid #60a5fa;
        }
    </style>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: { bg: '#0f172a', card: '#1e293b' },
                        brand: { blue: '#3b82f6', purple: '#8b5cf6', green: '#10b981', red: '#ef4444' }
                    }
                }
            }
        }
    </script>
</head>

<body class="h-screen overflow-hidden flex text-sm">

    <div x-data="gamePlayApp()" x-init="initApp()" class="flex w-full h-full">

        <!-- SIDEBAR -->
        <aside
            class="w-64 flex-shrink-0 bg-slate-900 border-r border-slate-800 flex flex-col transition-all duration-300"
            :class="{'w-20': collapsed}">
            <div class="h-16 flex items-center justify-center border-b border-slate-800">
                <i class="fas fa-bolt text-yellow-400 text-2xl mr-2"></i>
                <span class="font-bold text-xl tracking-tight" x-show="!collapsed">Fantasy<span
                        class="text-blue-500">Pro</span></span>
            </div>
            <nav class="flex-1 overflow-y-auto py-4 space-y-1">
                <template x-for="item in navItems" :key="item.id">
                    <a @click="currentView = item.id"
                        class="sidebar-link flex items-center px-6 py-3 cursor-pointer text-slate-400 hover:text-white"
                        :class="{'active': currentView === item.id}">
                        <i :class="item.icon + ' w-6 text-center'"></i>
                        <span class="ml-3 font-medium" x-show="!collapsed" x-text="item.label"></span>
                    </a>
                </template>
            </nav>
            <div class="p-4 border-t border-slate-800">
                <button @click="collapsed = !collapsed"
                    class="w-full flex items-center justify-center p-2 rounded-lg hover:bg-slate-800 text-slate-400">
                    <i :class="collapsed ? 'fas fa-chevron-right' : 'fas fa-chevron-left'"></i>
                </button>
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="flex-1 flex flex-col min-w-0 bg-slate-950 overflow-hidden relative">

            <header
                class="h-16 flex items-center justify-between px-8 bg-slate-900/50 backdrop-blur border-b border-slate-800 z-10">
                <h1 class="text-xl font-bold text-white capitalize"
                    x-text="navItems.find(i=>i.id===currentView)?.label"></h1>
                <div class="flex items-center gap-4">
                    <span class="text-xs text-slate-500 bg-slate-800 px-3 py-1 rounded-full border border-slate-700">
                        <i class="fas fa-database mr-1"></i> <span x-text="movements.length + ' movs'"></span>
                    </span>
                    <button
                        class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg text-xs font-semibold shadow-lg shadow-blue-500/20 transition-all flex items-center gap-2"
                        @click="reconstructTradingHistory(); addLog('Datos recalculados', 'info')">
                        <i class="fas fa-sync-alt"></i> Recalcular
                    </button>
                </div>
            </header>

            <div class="flex-1 overflow-y-auto p-8 relative">

                <!-- DASHBOARD -->
                <div x-show="currentView === 'dashboard'" class="space-y-6" x-transition.opacity>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="glass-card p-6 flex flex-col relative overflow-hidden group">
                            <div
                                class="absolute right-0 top-0 p-4 opacity-10 group-hover:scale-110 transition-transform">
                                <i class="fas fa-money-bill-wave text-6xl text-green-500"></i>
                            </div>
                            <span class="text-slate-400 text-xs font-bold uppercase tracking-wider">Volumen
                                Negociado</span>
                            <span class="text-2xl font-bold text-white mt-1"
                                x-text="formatMoney(calculateTotalVolume())"></span>
                        </div>
                        <div class="glass-card p-6 flex flex-col relative overflow-hidden group">
                            <div
                                class="absolute right-0 top-0 p-4 opacity-10 group-hover:scale-110 transition-transform">
                                <i class="fas fa-users text-6xl text-blue-500"></i>
                            </div>
                            <span class="text-slate-400 text-xs font-bold uppercase tracking-wider">Managers</span>
                            <span class="text-2xl font-bold text-white mt-1"
                                x-text="Object.keys(managers).length"></span>
                        </div>
                        <div class="glass-card p-6 flex flex-col relative overflow-hidden group">
                            <div
                                class="absolute right-0 top-0 p-4 opacity-10 group-hover:scale-110 transition-transform">
                                <i class="fas fa-chart-line text-6xl text-purple-500"></i>
                            </div>
                            <span class="text-slate-400 text-xs font-bold uppercase tracking-wider">Mercado
                                (Jugadores)</span>
                            <span class="text-2xl font-bold text-white mt-1"
                                x-text="formatMoney(calculateMarketTotal())"></span>
                            <span class="text-xs text-green-400 mt-1"
                                x-text="Object.keys(marketData).length + ' jugadores'"></span>
                        </div>
                        <div class="glass-card p-6 flex flex-col relative overflow-hidden group">
                            <div
                                class="absolute right-0 top-0 p-4 opacity-10 group-hover:scale-110 transition-transform">
                                <i class="fas fa-trophy text-6xl text-yellow-500"></i>
                            </div>
                            <span class="text-slate-400 text-xs font-bold uppercase tracking-wider">L√≠der
                                (Patrimonio)</span>
                            <span class="text-xl font-bold text-white mt-1 truncate"
                                x-text="marketValuation.sort((a,b)=>(b.marketValue+b.balance)-(a.marketValue+a.balance))[0]?.name || '-'"></span>
                        </div>
                    </div>

                    <div class="glass-card p-6">
                        <h3 class="text-lg font-bold text-white mb-4"><i
                                class="fas fa-trophy text-yellow-400 mr-2"></i>Clasificaci√≥n R√°pida</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left border-collapse">
                                <thead>
                                    <tr class="text-slate-400 border-b border-slate-700 text-xs uppercase">
                                        <th class="p-3">Manager</th>
                                        <th class="p-3 text-right">Caja</th>
                                        <th class="p-3 text-right">Plantilla</th>
                                        <th class="p-3 text-right font-bold text-white">Patrimonio Total</th>
                                        <th class="p-3 text-right text-blue-400">Puja M√°x</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <template
                                        x-for="mgr in marketValuation.sort((a,b) => (b.balance+b.marketValue)-(a.balance+a.marketValue))"
                                        :key="mgr.name">
                                        <tr
                                            class="border-b border-slate-700/50 hover:bg-slate-800/50 transition-colors">
                                            <td class="p-3 font-medium text-white" x-text="mgr.name"></td>
                                            <td class="p-3 text-right text-slate-400" x-text="formatMoney(mgr.balance)">
                                            </td>
                                            <td class="p-3 text-right text-green-400"
                                                x-text="formatMoney(mgr.marketValue)"></td>
                                            <td class="p-3 text-right font-bold text-white"
                                                x-text="formatMoney(mgr.balance + mgr.marketValue)"></td>
                                            <td class="p-3 text-right font-mono text-blue-400"
                                                x-text="formatMoney(mgr.balance + (mgr.marketValue * 0.2))"></td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- CLASIFICACION DETALLADA -->
                <div x-show="currentView === 'clasificacion'" class="space-y-6" x-transition.opacity>
                    <div class="glass-card overflow-hidden">
                        <div class="p-4 bg-slate-900 border-b border-slate-800">
                            <h3 class="text-white font-bold"><i class="fas fa-chart-pie mr-2"></i>An√°lisis Financiero &
                                Inflaci√≥n</h3>
                        </div>
                        <table class="w-full text-left">
                            <thead class="bg-slate-900 border-b border-slate-700">
                                <tr class="text-slate-400 text-xs uppercase">
                                    <th class="p-4">Manager</th>
                                    <th class="p-4 text-right">Inversi√≥n (Coste)</th>
                                    <th class="p-4 text-right">Valor Actual</th>
                                    <th class="p-4 text-right text-green-400">Inflaci√≥n (Latente)</th>
                                    <th class="p-4 text-right text-yellow-400">Profit Realizado</th>
                                    <th class="p-4 text-right text-blue-400">ROI Total</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-800">
                                <template
                                    x-for="mgr in marketValuation.sort((a,b) => b.unrealizedProfit - a.unrealizedProfit)"
                                    :key="mgr.name">
                                    <tr class="hover:bg-slate-800/50 transition-colors">
                                        <td class="p-4 font-semibold text-white" x-text="mgr.name"></td>
                                        <td class="p-4 text-right text-slate-400" x-text="formatMoney(mgr.invested)">
                                        </td>
                                        <td class="p-4 text-right text-white" x-text="formatMoney(mgr.marketValue)">
                                        </td>
                                        <td class="p-4 text-right font-bold"
                                            :class="mgr.unrealizedProfit > 0 ? 'text-green-500' : 'text-red-500'"
                                            x-text="formatMoney(mgr.unrealizedProfit)"></td>
                                        <td class="p-4 text-right font-mono text-yellow-500"
                                            x-text="formatMoney(tradingHistory.managerStats[mgr.name]?.profit || 0)">
                                        </td>
                                        <td class="p-4 text-right font-mono text-blue-400"
                                            x-text="mgr.invested > 0 ? ((mgr.unrealizedProfit / mgr.invested)*100).toFixed(1) + '%' : '0%'">
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- JUGADORES (ALL PLAYERS) -->
                <div x-show="currentView === 'jugadores'" class="space-y-6" x-transition.opacity>
                    <div class="flex flex-wrap gap-4 mb-4">
                        <input type="text" x-model="playerFilters.search" placeholder="üîç Buscar jugador..."
                            class="bg-slate-800 border-slate-700 rounded-lg p-3 text-white flex-grow focus:ring-2 focus:ring-blue-500 outline-none">
                        <select x-model="playerFilters.owner"
                            class="bg-slate-800 border-slate-700 rounded-lg p-3 text-white outline-none">
                            <option value="all">Todos los Estados</option>
                            <option value="free">Solo Libres</option>
                            <option value="owned">Con Due√±o</option>
                        </select>
                        <select x-model="playerFilters.sort"
                            class="bg-slate-800 border-slate-700 rounded-lg p-3 text-white outline-none">
                            <option value="value_desc">Mayor Valor</option>
                            <option value="value_asc">Menor Valor</option>
                            <option value="cost_desc">Mayor Coste</option>
                        </select>
                    </div>

                    <div class="glass-card overflow-hidden">
                        <table class="w-full text-left">
                            <thead class="bg-slate-900 border-b border-slate-700">
                                <tr class="text-slate-400 text-xs uppercase">
                                    <th class="p-4">Jugador</th>
                                    <th class="p-4">Estado / Due√±o</th>
                                    <th class="p-4 text-right">Valor Mercado</th>
                                    <th class="p-4 text-right">Coste Adquisici√≥n</th>
                                    <th class="p-4 text-right">Diff</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-800">
                                <template x-for="p in filteredPlayers.slice(0, 5000)" :key="p.name">
                                    <tr class="hover:bg-slate-800/50 transition-colors">
                                        <td class="p-4 font-medium text-white" x-text="p.name"></td>
                                        <td class="p-4">
                                            <span x-show="p.owner"
                                                class="px-2 py-1 rounded bg-blue-900/40 text-blue-300 text-xs border border-blue-800"
                                                x-text="p.owner"></span>
                                            <span x-show="!p.owner" class="text-slate-600 text-xs italic">Libre
                                                (Mercado)</span>
                                        </td>
                                        <td class="p-4 text-right font-mono text-green-400"
                                            x-text="formatMoney(p.value)"></td>
                                        <td class="p-4 text-right text-slate-500 text-xs"
                                            x-text="p.cost ? formatMoney(p.cost) : '-'"></td>
                                        <td class="p-4 text-right text-xs"
                                            :class="p.value - p.cost > 0 ? 'text-green-500' : 'text-red-500'"
                                            x-text="p.cost ? formatMoney(p.value - p.cost) : '-'"></td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                        <div class="p-4 text-center text-slate-600 text-xs">Mostrando <span
                                x-text="Math.min(5000, filteredPlayers.length)"></span> de <span
                                x-text="filteredPlayers.length"></span> jugadores</div>
                    </div>
                </div>

                <!-- MOVIMIENTOS -->
                <div x-show="currentView === 'movimientos'" class="space-y-6" x-transition.opacity>
                    <div class="glass-card p-4 grid grid-cols-1 md:grid-cols-4 gap-4">
                        <input type="text" x-model="filters.search" placeholder="üîç Buscar..."
                            class="bg-slate-800 border-slate-700 rounded-lg text-white p-2 outline-none focus:ring-1 focus:ring-blue-500">
                        <select x-model="filters.team"
                            class="bg-slate-800 border-slate-700 rounded-lg text-white p-2 outline-none">
                            <option value="all">Todos los Equipos</option>
                            <template x-for="(m, name) in managers" :key="name">
                                <option :value="name" x-text="name"></option>
                            </template>
                        </select>
                        <select x-model="filters.type"
                            class="bg-slate-800 border-slate-700 rounded-lg text-white p-2 outline-none">
                            <option value="all">Todos los tipos</option>
                            <option value="transfer">Traspasos</option>
                            <option value="market">Mercado</option>
                            <option value="clause">Cl√°usulas</option>
                            <option value="reward">Premios</option>
                        </select>
                        <div class="text-right text-xs text-slate-500 flex items-center justify-end"><span
                                x-text="filteredMovements.length"></span> resultados</div>
                    </div>

                    <div class="glass-card overflow-hidden">
                        <table class="w-full">
                            <thead class="bg-slate-900 text-xs uppercase text-slate-400">
                                <tr>
                                    <th class="p-3">Fecha</th>
                                    <th class="p-3">Tipo</th>
                                    <th class="p-3">Descripci√≥n</th>
                                    <th class="p-3 text-right">Importe</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-800">
                                <template x-for="m in filteredMovements.slice(0, 5000)" :key="m.id">
                                    <tr class="hover:bg-slate-800/50">
                                        <td class="p-3 text-slate-400 text-xs whitespace-nowrap" x-text="m.date"></td>
                                        <td class="p-3">
                                            <span class="px-2 py-1 rounded text-[10px] font-bold uppercase" :class="{
                                                    'bg-green-900/50 text-green-300': m.type === 'transfer' && m.amount > 0,
                                                    'bg-red-900/50 text-red-300': m.type === 'transfer' && m.amount < 0,
                                                    'bg-blue-900/50 text-blue-300': m.type === 'shield',
                                                    'bg-yellow-900/50 text-yellow-300': m.type === 'reward'
                                                }" x-text="m.type === 'transfer' ? 'Fichaje' : m.type"></span>
                                        </td>
                                        <td class="p-3 text-sm text-slate-200">
                                            <div class="font-bold" x-text="m.player"></div>
                                            <div class="text-xs text-slate-500 flex items-center gap-2">
                                                <span x-text="m.seller"></span> <i
                                                    class="fas fa-arrow-right text-[10px]"></i> <span
                                                    x-text="m.buyer"></span>
                                            </div>
                                        </td>
                                        <td class="p-3 text-right font-mono text-white" x-text="formatMoney(m.amount)">
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- NEGOCIOS -->
                <div x-show="currentView === 'negocios'" class="space-y-6" x-transition.opacity>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="glass-card p-6">
                            <h3 class="text-lg font-bold text-green-400 mb-4"><i
                                    class="fas fa-chart-line mr-2"></i>Mejores "Flips" (Profit)</h3>
                            <div class="space-y-3">
                                <template x-for="(deal, i) in bestDeals.slice(0,50)" :key="i">
                                    <div
                                        class="flex items-center justify-between p-3 bg-slate-800/40 rounded-lg border border-slate-700/50 hover:bg-slate-800 transition-colors">
                                        <div class="flex items-center gap-3">
                                            <div class="text-green-500 font-bold text-lg w-6 text-center" x-text="i+1">
                                            </div>
                                            <div>
                                                <div class="font-bold text-white" x-text="deal.player"></div>
                                                <div class="text-xs text-slate-400" x-text="deal.manager"></div>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <div class="font-mono text-green-400 font-bold"
                                                x-text="'+' + formatMoney(deal.profit)"></div>
                                            <div class="text-xs text-slate-500" x-text="deal.roi.toFixed(0) + '% ROI'">
                                            </div>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>

                        <div class="glass-card p-6">
                            <h3 class="text-lg font-bold text-red-400 mb-4"><i
                                    class="fas fa-level-down-alt mr-2"></i>Peores "Ruinas" (Loss)</h3>
                            <div class="space-y-3">
                                <template x-for="(deal, i) in worstDeals.slice(0,50)" :key="i">
                                    <div
                                        class="flex items-center justify-between p-3 bg-slate-800/40 rounded-lg border border-slate-700/50 hover:bg-slate-800 transition-colors">
                                        <div class="flex items-center gap-3">
                                            <div class="text-red-500 font-bold text-lg w-6 text-center" x-text="i+1">
                                            </div>
                                            <div>
                                                <div class="font-bold text-white" x-text="deal.player"></div>
                                                <div class="text-xs text-slate-400" x-text="deal.manager"></div>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <div class="font-mono text-red-500 font-bold"
                                                x-text="formatMoney(deal.profit)"></div>
                                            <div class="text-xs text-slate-500">P√©rdida</div>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- IMPORT (Magic Parser) -->
                <div x-show="currentView === 'importar'" class="space-y-6" x-transition.opacity>
                    <div class="glass-card p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-lg font-bold text-white">Importador Inteligente</h2>
                            <button @click="processInput()"
                                class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg font-bold text-sm">
                                <i class="fas fa-bolt mr-2"></i> Procesar
                            </button>
                        </div>

                        <div
                            class="mb-4 p-3 bg-blue-900/20 border border-blue-500/30 rounded-lg text-xs text-blue-300 flex items-center gap-2">
                            <i class="fas fa-info-circle text-lg"></i>
                            <div>
                                <strong>¬øFaltan datos antiguos?</strong>
                                <p>Re-importa tu archivo <code>movimientos_smart.txt</code> pegando su contenido abajo
                                    para restaurar todo el historial en esta nueva versi√≥n V2.0.</p>
                            </div>
                        </div>
                        <textarea x-model="rawInput"
                            class="w-full bg-slate-900/80 text-slate-300 p-4 rounded-lg font-mono text-xs border border-slate-700 focus:border-blue-500 outline-none h-64"
                            placeholder="Pega aqu√≠ el HTML completo de Mercado, o las l√≠neas de texto de Movimientos..."></textarea>

                        <div
                            class="mt-4 bg-black/40 p-4 rounded-lg font-mono text-xs h-48 overflow-y-auto border border-slate-800/50">
                            <template x-for="log in logs" :key="log.id">
                                <div class="mb-1 border-l-2 pl-2" :class="{
                                    'border-green-500 text-green-400': log.type === 'success',
                                    'border-red-500 text-red-400': log.type === 'error',
                                    'border-yellow-500 text-yellow-300': log.type === 'warning',
                                    'border-blue-500 text-slate-400': log.type === 'info'
                                }">
                                    <span x-text="log.message"></span>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <script>
        function gamePlayApp() {
            return {
                collapsed: false,
                currentView: 'dashboard',
                navItems: [
                    { id: 'dashboard', label: 'Dashboard', icon: 'fas fa-home' },
                    { id: 'clasificacion', label: 'Clasificaci√≥n', icon: 'fas fa-ranking-star' },
                    { id: 'jugadores', label: 'Mercado & Jugadores', icon: 'fas fa-users' },
                    { id: 'movimientos', label: 'Movimientos', icon: 'fas fa-exchange-alt' },
                    { id: 'negocios', label: 'Negocios', icon: 'fas fa-briefcase' },
                    { id: 'importar', label: 'Importar / Config', icon: 'fas fa-cogs' }
                ],

                managers: {
                    "Vigar FC": { initialBudget: 103000000, teamValue: 0, clauseExpenses: 0, name: "Vigar FC" },
                    "GOLENCIERRO FC": { initialBudget: 103000000, teamValue: 0, clauseExpenses: 0, name: "GOLENCIERRO FC" },
                    "Pablinistan FC": { initialBudget: 103000000, teamValue: 0, clauseExpenses: 0, name: "Pablinistan FC" },
                    "Alcatamy eSports By": { initialBudget: 100000000, teamValue: 0, clauseExpenses: 0, name: "Alcatamy eSports By" },
                    "Visite La Manga FC": { initialBudget: 100000000, teamValue: 0, clauseExpenses: 0, name: "Visite La Manga FC" },
                    "Morenazos FC": { initialBudget: 100000000, teamValue: 0, clauseExpenses: 0, name: "Morenazos FC" }
                },
                movements: [],
                pendingMovements: [],
                marketData: typeof MARKET_DATA !== 'undefined' ? MARKET_DATA : {},
                logs: [],

                tradingHistory: { closedDeals: [], rosters: {}, managerStats: {} },

                filters: { search: '', team: 'all', type: 'all' },
                playerFilters: { search: '', owner: 'all', sort: 'value_desc' },
                rawInput: '',

                // COMPUTED
                get filteredMovements() {
                    return this.movements.filter(m => {
                        const s = this.filters.search.toLowerCase();
                        const matchSearch = !s || m.player.toLowerCase().includes(s) || m.buyer.toLowerCase().includes(s) || m.seller.toLowerCase().includes(s);
                        const matchTeam = this.filters.team === 'all' || m.buyer === this.filters.team || m.seller === this.filters.team;
                        const matchType = this.filters.type === 'all' ||
                            (this.filters.type === 'transfer' && m.type === 'transfer') ||
                            (this.filters.type === 'market' && (m.buyer === 'Mercado' || m.seller === 'Mercado')) ||
                            (this.filters.type === 'reward' && m.type === 'reward') ||
                            (this.filters.type === 'clause' && m.type === 'shield');
                        return matchSearch && matchTeam && matchType;
                    }).sort((a, b) => this.parseDate(b.date) - this.parseDate(a.date));
                },

                get marketValuation() {
                    if (!Object.keys(this.tradingHistory.rosters).length) this.reconstructTradingHistory();

                    // First calculate initial balances
                    const balances = {};
                    Object.values(this.managers).forEach(m => balances[m.name] = m.initialBudget - (m.clauseExpenses || 0));

                    // Process balances
                    this.movements.forEach(m => {
                        const amt = parseInt(m.amount) || 0;
                        if (m.type === 'transfer') {
                            if (balances[m.buyer] !== undefined) balances[m.buyer] -= amt;
                            if (balances[m.seller] !== undefined) balances[m.seller] += amt;
                        } else if (m.type === 'reward' && balances[m.beneficiary] !== undefined) {
                            balances[m.beneficiary] += amt;
                        }
                    });

                    return Object.keys(this.tradingHistory.rosters).map(mgr => {
                        const roster = this.tradingHistory.rosters[mgr];
                        let val = 0;
                        let inv = 0;
                        Object.keys(roster).forEach(pName => {
                            let v = this.marketData[pName] || 0;
                            if (v === 0) {
                                // Fuzzy match
                                const match = Object.keys(this.marketData).find(k => k.toLowerCase() === pName.toLowerCase() || k.includes(pName) || pName.includes(k));
                                if (match) v = this.marketData[match];
                            }
                            val += v;
                            inv += roster[pName].cost;
                        });

                        return {
                            name: mgr,
                            marketValue: val,
                            invested: inv,
                            unrealizedProfit: val - inv,
                            balance: balances[mgr] || 0
                        };
                    });
                },

                get bestDeals() { return [...this.tradingHistory.closedDeals].sort((a, b) => b.profit - a.profit); },
                get worstDeals() { return [...this.tradingHistory.closedDeals].sort((a, b) => a.profit - b.profit); },

                get filteredPlayers() {
                    if (!Object.keys(this.tradingHistory.rosters).length) this.reconstructTradingHistory();

                    const ownedPlayers = {};
                    Object.keys(this.tradingHistory.rosters).forEach(mgr => {
                        Object.keys(this.tradingHistory.rosters[mgr]).forEach(pName => {
                            ownedPlayers[pName] = { owner: mgr, cost: this.tradingHistory.rosters[mgr][pName].cost };
                        });
                    });

                    let allPlayers = Object.keys(this.marketData).map(name => ({
                        name: name,
                        value: this.marketData[name],
                        owner: ownedPlayers[name]?.owner || null,
                        cost: ownedPlayers[name]?.cost || 0
                    }));

                    // Add missing owned players
                    Object.keys(ownedPlayers).forEach(pName => {
                        if (!this.marketData[pName]) {
                            allPlayers.push({ name: pName, value: 0, owner: ownedPlayers[pName].owner, cost: ownedPlayers[pName].cost });
                        }
                    });

                    return allPlayers.filter(p => {
                        const s = this.playerFilters.search.toLowerCase();
                        const matchSearch = !s || p.name.toLowerCase().includes(s);
                        const matchOwner = this.playerFilters.owner === 'all' ||
                            (this.playerFilters.owner === 'owned' && p.owner) ||
                            (this.playerFilters.owner === 'free' && !p.owner);
                        return matchSearch && matchOwner;
                    }).sort((a, b) => {
                        if (this.playerFilters.sort === 'value_desc') return b.value - a.value;
                        if (this.playerFilters.sort === 'value_asc') return a.value - b.value;
                        if (this.playerFilters.sort === 'cost_desc') return (b.cost || 0) - (a.cost || 0);
                        return 0;
                    });
                },

                // METHODS
                async initApp() {
                    const saved = localStorage.getItem('fantasy_gameplay_data');
                    if (saved) {
                        try {
                            const parsed = JSON.parse(saved);
                            this.movements = parsed.movements || [];
                            // Initial migration of managers if needed
                            if (parsed.managers) {
                                Object.keys(this.managers).forEach(k => {
                                    if (parsed.managers[k]) {
                                        this.managers[k].teamValue = parsed.managers[k].teamValue;
                                        this.managers[k].clauseExpenses = parsed.managers[k].clauseExpenses;
                                    }
                                });
                            }
                            if (parsed.marketData) this.marketData = parsed.marketData;
                            this.addLog('Datos cargados de memoria', 'success');
                        } catch (e) { console.error(e); }
                    }
                    this.reconstructTradingHistory();

                    this.$watch('movements', () => { this.debouncedSaveData(); this.reconstructTradingHistory(); });
                    this.$watch('marketData', () => { this.debouncedSaveData(); this.reconstructTradingHistory(); });
                },

                formatMoney(amount) {
                    return new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 }).format(amount);
                },

                addLog(msg, type = 'info') {
                    this.logs.unshift({ id: Date.now(), message: msg, type, timestamp: Date.now() });
                },

                // CORE LOGIC V2
                reconstructTradingHistory() {
                    // Sorting crucial for replay
                    const sorted = [...this.movements].sort((a, b) => this.parseDate(a.date) - this.parseDate(b.date));
                    const rosters = {};
                    const managerStats = {};
                    const closedDeals = [];

                    Object.keys(this.managers).forEach(m => {
                        rosters[m] = {};
                        managerStats[m] = { profit: 0, sales: 0, buys: 0 };
                    });

                    sorted.forEach(m => {
                        const amt = parseInt(m.amount) || 0;
                        if (m.type === 'transfer') {
                            // Seller
                            if (this.managers[m.seller] || rosters[m.seller]) {
                                if (!rosters[m.seller]) rosters[m.seller] = {};

                                if (rosters[m.seller][m.player]) {
                                    const buyPrice = rosters[m.seller][m.player].cost;
                                    const profit = amt - buyPrice;
                                    const roi = buyPrice > 0 ? (profit / buyPrice) * 100 : 0;
                                    closedDeals.push({ player: m.player, manager: m.seller, buyPrice, sellPrice: amt, profit, roi, date: m.date });
                                    if (managerStats[m.seller]) managerStats[m.seller].profit += profit;
                                    delete rosters[m.seller][m.player];
                                }
                            }
                            // Buyer
                            if (this.managers[m.buyer] || rosters[m.buyer]) {
                                if (!rosters[m.buyer]) rosters[m.buyer] = {};
                                rosters[m.buyer][m.player] = { cost: amt, date: m.date };
                            }
                        }
                    });

                    this.tradingHistory = { closedDeals, rosters, managerStats };
                },

                saveData() {
                    localStorage.setItem('fantasy_gameplay_data', JSON.stringify({
                        movements: this.movements,
                        marketData: this.marketData,
                        managers: this.managers,
                        lastUpdate: Date.now()
                    }));
                },
                debouncedSaveData() { clearTimeout(this._tm); this._tm = setTimeout(() => this.saveData(), 1000); },

                parseDate(dateStr) {
                    if (!dateStr || dateStr === 'NODATE') return 0;
                    if (dateStr.match(/^\d{2}\/\d{2}\/\d{4}/)) {
                        const [d, m, y] = dateStr.split(' ')[0].split('/');
                        return new Date(y, m - 1, d).getTime();
                    }
                    return 0;
                },

                calculateTotalVolume() { return this.movements.reduce((acc, m) => acc + (parseInt(m.amount) || 0), 0); },
                calculateMarketTotal() { return Object.values(this.marketData).reduce((a, b) => a + b, 0); },

                // ROBUST PARSERS (FROM v1)
                processInput() {
                    const text = this.rawInput;
                    if (!text.trim()) return;

                    const startTime = performance.now();

                    // HTML Detection
                    if (text.includes('<html') || text.includes('MuiTypography') || text.includes('__NEXT_DATA__')) {
                        this.parseMarketDataRegex(text); // Use Regex fallback for reliability
                        return;
                    }

                    const existingIds = new Set(this.movements.map(m => m.id));
                    const pendingIds = new Set(this.pendingMovements.map(m => m.id));
                    const lines = text.split('\n');
                    let tempDate = null;

                    // Regex Patterns
                    const reSmartFormat = /^\[([^\]]+)\] (.+)/;
                    const reDate = /(\d{2}\/\d{2}\/\d{4})/;
                    const reTransfer = /(.+?) ha (comprado|vendido) al jugador (.+?) (?:de|a) (.+?) por ([\d\.]+)[‚Ç¨]?/;
                    const reShield = /(.+?) ha blindado a (.+)/i;
                    const reRewardJornada = /En la jornada (\d+), (.+?) ha ganado ([\d\.]+)[‚Ç¨]?/i;
                    const reTeamValue = /([^\n]+)\s+(\d+)\s+PFSY\s+([\d\.]+)/; // Team value heuristic

                    const normalizeDate = (d) => {
                        if (/^\d{1,2}:\d{2}$/.test(d)) {
                            const today = new Date();
                            return `${String(today.getDate()).padStart(2, '0')}/${String(today.getMonth() + 1).padStart(2, '0')}/${today.getFullYear()} ${d}`;
                        }
                        return d || 'NODATE';
                    };

                    lines.forEach(line => {
                        line = line.trim();
                        if (!line || line.startsWith('#')) return;

                        let dateKey = tempDate;
                        let textToParse = line;

                        const smartMatch = line.match(reSmartFormat);
                        if (smartMatch) { dateKey = smartMatch[1].trim(); textToParse = smartMatch[2]; }
                        else if (reDate.test(line)) { tempDate = line.match(reDate)[1]; return; }

                        // Transfer
                        let match = textToParse.match(reTransfer);
                        if (match) {
                            const [_, actor, action, player, other, amtStr] = match;
                            const amount = parseInt(amtStr.replace(/\./g, ''));
                            const buyer = action === 'comprado' ? actor.trim() : other.trim();
                            const seller = action === 'comprado' ? other.trim() : actor.trim();
                            const id = `transfer_${normalizeDate(dateKey)}_${buyer}_${seller}_${player}_${amount}`;

                            if (!pendingIds.has(id) && !existingIds.has(id)) {
                                pendingIds.add(id);
                                this.pendingMovements.push({ id, type: 'transfer', buyer, seller, player, amount, date: normalizeDate(dateKey) });
                            }
                            return;
                        }

                        // Shield
                        match = textToParse.match(reShield);
                        if (match) {
                            const id = `shield_${normalizeDate(dateKey)}_${match[1].trim()}_${match[2].trim()}`;
                            if (!pendingIds.has(id) && !existingIds.has(id)) {
                                pendingIds.add(id);
                                this.pendingMovements.push({ id, type: 'shield', beneficiary: match[1].trim(), player: match[2].trim(), amount: 0, date: normalizeDate(dateKey) });
                            }
                            return;
                        }

                        // Reward
                        match = textToParse.match(reRewardJornada);
                        if (match) {
                            const id = `reward_jor${match[1]}_${match[2].trim()}`;
                            if (!pendingIds.has(id) && !existingIds.has(id)) {
                                pendingIds.add(id);
                                this.pendingMovements.push({ id, type: 'reward', subtype: 'jornada', beneficiary: match[2].trim(), amount: parseInt(match[3].replace(/\./g, '')), date: normalizeDate(dateKey) });
                            }
                        }
                    });

                    if (this.pendingMovements.length > 0) this.addLog(`Detectados ${this.pendingMovements.length} movimientos.`, 'info');
                    else this.addLog('No se detectaron movimientos.', 'warning');
                },

                parseMarketDataRegex(text) {
                    const parts = text.split('class="MuiBox-root css-1j0r1in"');
                    let count = 0;
                    parts.forEach(part => {
                        const nameMatch = part.match(/MuiTypography-body2[^>]*>\s*([^<]+)<\/p>/);
                        const valMatch = part.match(/MuiTypography-body1[^>]*>\s*([\d\.]+) ‚Ç¨<\/p>/);
                        if (nameMatch && valMatch) {
                            const name = nameMatch[1].trim();
                            const val = parseInt(valMatch[1].replace(/\./g, ''));
                            this.marketData[name] = val;
                            count++;
                        }
                    });
                    this.addLog(`Mercado (HTML Regex) actualizado: ${count} jugadores`, 'success');
                    this.debouncedSaveData();
                },

                confirmImport() {
                    this.movements = [...this.movements, ...this.pendingMovements];
                    this.pendingMovements = [];
                    this.saveData();
                    this.reconstructTradingHistory();
                    this.addLog('Importaci√≥n confirmada', 'success');
                    this.rawInput = '';
                },
                cancelImport() { this.pendingMovements = []; this.rawInput = ''; }
            }
        }
    </script>
</body>

</html>